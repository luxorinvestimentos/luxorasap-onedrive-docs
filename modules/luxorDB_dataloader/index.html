
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentação completa do stack LuxorASAP em produção (2025)">
      
      
      
        <link rel="canonical" href="https://SEU_DOMINIO/modules/luxorDB_dataloader/">
      
      
        <link rel="prev" href="../luxorDB_datareader/">
      
      
        <link rel="next" href="../../planilhas/planilhas/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>luxorDB_dataloader.py - LuxorASAP Onedrive Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#luxordb_dataloaderpy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LuxorASAP Onedrive Docs" class="md-header__button md-logo" aria-label="LuxorASAP Onedrive Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LuxorASAP Onedrive Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              luxorDB_dataloader.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="orange"  aria-label="Alternar Dark Mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Alternar Dark Mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LuxorASAP Onedrive Docs" class="md-nav__button md-logo" aria-label="LuxorASAP Onedrive Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LuxorASAP Onedrive Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visão Geral
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Arquitetura
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Arquitetura
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/file_tree/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Estrutura de arquivos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/data_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data-flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/bloomberg_data_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bloomberg Data Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Módulos
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Módulos
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    carteira_online.production
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            carteira_online.production
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/portfolio_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    portfolio_builder.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/return_calculator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    return_calculator.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/cash_calculator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cash_calculator.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/btg_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    btg_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/asset_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    asset_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/historical_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    historical_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/leitor_carteira_excel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    leitor_carteira_excel.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/onedrive_file_redirect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    onedrive_file_redirect.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    source_bases.scripts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            source_bases.scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/hist_concentration_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hist_concentration_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/custom_funds_quotas_updater.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    custom_funds_quotas_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/non_bbg_data_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    non_bbg_data_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/daily_pnl_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    daily_pnl_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/historical_quotas_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    historical_quotas_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/risk_metrics_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    risk_metrics_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/us_cash_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    us_cash_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/swaps_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    swaps_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../run_luxorASAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    run_luxorASAP.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../market_data_extractor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    market_data_extractor.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../market_data_loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    market_data_loader.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    source_bases_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../luxorDB_datareader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    luxorDB_datareader.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    luxorDB_dataloader.py
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    luxorDB_dataloader.py
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luxorDB_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      luxorDB_dataloader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader" class="md-nav__link">
    <span class="md-ellipsis">
      DataLoader
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.add_file_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      add_file_tracker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.add_table_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      add_table_tracker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.is_file_modified" class="md-nav__link">
    <span class="md-ellipsis">
      is_file_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.load_file_if_modified" class="md-nav__link">
    <span class="md-ellipsis">
      load_file_if_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.load_table_if_modified" class="md-nav__link">
    <span class="md-ellipsis">
      load_table_if_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.scan_files" class="md-nav__link">
    <span class="md-ellipsis">
      scan_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.text_to_lowercase" class="md-nav__link">
    <span class="md-ellipsis">
      text_to_lowercase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../planilhas/planilhas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planilhas
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luxorDB_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      luxorDB_dataloader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader" class="md-nav__link">
    <span class="md-ellipsis">
      DataLoader
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.add_file_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      add_file_tracker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.add_table_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      add_table_tracker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.is_file_modified" class="md-nav__link">
    <span class="md-ellipsis">
      is_file_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.load_file_if_modified" class="md-nav__link">
    <span class="md-ellipsis">
      load_file_if_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.load_table_if_modified" class="md-nav__link">
    <span class="md-ellipsis">
      load_table_if_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.scan_files" class="md-nav__link">
    <span class="md-ellipsis">
      scan_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_dataloader.DataLoader.text_to_lowercase" class="md-nav__link">
    <span class="md-ellipsis">
      text_to_lowercase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="luxordb_dataloaderpy"><code>luxorDB_dataloader.py</code><a class="headerlink" href="#luxordb_dataloaderpy" title="Permanent link">¶</a></h1>
<p>Camada de escrita/persistência padronizada no LuxorDB.</p>


<div class="doc doc-object doc-module">



<a id="luxorDB_dataloader"></a>
    <div class="doc doc-contents first">

        <p>Este módulo contém a classe <code>DataLoader</code>, responsável por gerenciar o carregamento e a persistência de dados para o LuxorDB.</p>
<p>A classe <code>DataLoader</code> oferece funcionalidades para:
- Carregar tabelas a partir de arquivos Excel ou dados em memória.
- Monitorar arquivos e tabelas para detectar modificações e acionar recargas.
- Normalizar colunas de texto para minúsculas.
- Persistir dados em diferentes formatos (Excel, Parquet) no sistema de arquivos local.
- Exportar dados para o Azure Blob Storage em formato Parquet.</p>
<p>O objetivo principal é garantir que os dados no LuxorDB estejam sempre atualizados e consistentes,
facilitando a integração com outras partes do sistema.</p>
<p>De forma bem resumida:
Este módulo é responsável por carregar, monitorar e persistir dados no LuxorDB, garantindo que as tabelas estejam sempre atualizadas e consistentes.
Ele gerencia a leitura de arquivos Excel e dados em memória, normaliza colunas e exporta os dados para formatos como Excel, Parquet e Azure Blob Storage.
Oferece funcoes para:</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="luxorDB_dataloader.DataLoader" class="doc doc-heading">
            <code>DataLoader</code>


<a href="#luxorDB_dataloader.DataLoader" class="headerlink" title="Permanent link">¶</a></h2>


    <div class="doc doc-contents ">








              <details class="quote">
                <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataLoader</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fornece uma forma padronizada de carregar tabelas para a luxorDB.</span>
<span class="sd">            1. Possui metodos para carregar tabelas que já estao carregadas na memória</span>
<span class="sd">                - Sao os metodos que possuem &#39;table&#39; no nome</span>
<span class="sd">            2. Possui metodos para carregar arquivos de excel, com todas as suas abas</span>
<span class="sd">                Inclui metodo para checagem de alteracao de versao do arquivo</span>
<span class="sd">                - Sao os metodos que possuem &#39;file&#39; no nome</span>
<span class="sd">        Args:</span>
<span class="sd">            luxorDB_directory (pathlib.Path, optional): Caminho completo ate o diretorio de destino dos dados.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="n">luxorDB_directory</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s2">&quot;LuxorDB&quot;</span><span class="o">/</span><span class="s2">&quot;tables&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__persist_column_formatting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="n">columns_to_persist</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Vehicles&quot;</span><span class="p">,</span> <span class="s2">&quot;Segment&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Vamos persistir a formatacao de algumas colunas</span>
            <span class="n">columns_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">columns_to_persist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span>
            <span class="n">persistent_data</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">columns_to_persist</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">columns_to_normalize</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns_order</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">columns_to_normalize</span><span class="p">])</span>
            <span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">columns_to_persist</span><span class="p">]</span> <span class="o">=</span> <span class="n">persistent_data</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">columns_order</span><span class="p">]</span>

        <span class="c1"># Nos outros casos, transformaremos tudo em lowercase</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">text_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converte todas as colunas de texto para lowercase</span>
<span class="sd">        Args:</span>
<span class="sd">            t (pd.DataFrame): pandas DataFrame</span>
<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_file_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;excel&quot;</span><span class="p">,</span> <span class="n">sheet_names</span><span class="o">=</span><span class="p">{},</span> 
            <span class="n">excel_size_limit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adiciona arquivo na lista para checar por alteracao</span>
<span class="sd">        Args:</span>
<span class="sd">            tracked_file_path (pathlib.Path): caminho completo ate o arquivo,</span>
<span class="sd">                    incluindo nome do arquivo e extensão.</span>
<span class="sd">            sheet_names (dict, optional): Caso seja uma planilha com varias abas, mapear</span>
<span class="sd">                    aqui o nome da aba para o nome do arquivo de saida desejado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tracked_file_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;last_mtime&quot;</span> <span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="s2">&quot;filetype&quot;</span> <span class="p">:</span> <span class="n">filetype</span><span class="p">,</span> <span class="s2">&quot;sheet_names&quot;</span><span class="p">:</span> <span class="n">sheet_names</span><span class="p">,</span>
                    <span class="s2">&quot;excel_size_limit&quot;</span> <span class="p">:</span> <span class="n">excel_size_limit</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                    <span class="s2">&quot;index_name&quot;</span> <span class="p">:</span> <span class="n">index_name</span><span class="p">,</span>
                    <span class="s2">&quot;normalize_columns&quot;</span> <span class="p">:</span> <span class="n">normalize_columns</span><span class="p">,</span>
                <span class="p">}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_table_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adiciona tabela na lista para controle de alteracao.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">remove_file_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">tracked_file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">remove_table_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_file_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">}:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checa se o arquivo foi modificado desde a ultima leitura.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple(bool, float): (foi modificado?, timestamp da ultima modificacao)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span>

        <span class="n">last_saved_time</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span>
        <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">tracked_file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">return</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="n">last_saved_time</span><span class="p">,</span> <span class="n">file_last_update</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_file_modified_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">file_mtime</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">][</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_mtime</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">load_file_if_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carrega arquivo no caminho indicado, carregando na base de dados caso modificado.</span>
<span class="sd">        Args:</span>
<span class="sd">            tracked_file_path (pathlib.Path): caminho ate o arquivo(cadastro previamente por add_file_tracker)</span>
<span class="sd">            type_map (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">            filetype (str, optional): _description_. Defaults to &quot;excel&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span>

        <span class="n">last_saved_time</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;filetype&quot;</span><span class="p">]</span>
        <span class="n">file_sheets</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;sheet_names&quot;</span><span class="p">]</span>

        <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">tracked_file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>

        <span class="k">if</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="n">last_saved_time</span><span class="p">:</span> <span class="c1"># Houve alteracao no arquivo</span>
            <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;excel&quot;</span><span class="p">:</span>
                <span class="n">file_sheets</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_sheets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_sheets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># tables sera sempre um dicionario de tabelas</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">trials</span> <span class="o">=</span> <span class="mi">25</span>
                <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">trials</span> <span class="o">-</span> <span class="n">t_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">file_sheets</span><span class="p">)</span>
                        <span class="n">t_counter</span> <span class="o">=</span> <span class="n">trials</span> <span class="c1"># leitura concluida</span>
                    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao tentar ler arquivo &#39;</span><span class="si">{</span><span class="n">tracked_file_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Tentativa </span><span class="si">{</span><span class="n">t_counter</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">trials</span><span class="si">}</span><span class="s2">;&#39;.</span><span class="se">\n</span><span class="s2">Se estiver aberto feche.&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                        <span class="n">t_counter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">table_data</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="n">table_name</span> <span class="o">=</span> <span class="n">sheet_name</span> <span class="k">if</span> <span class="n">file_sheets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;sheet_names&quot;</span><span class="p">][</span><span class="n">sheet_name</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;trades&quot;</span><span class="p">:</span>
                        <span class="n">table_data</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">index</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">__export_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="n">index_name</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;index_name&quot;</span><span class="p">],</span>
                                            <span class="n">normalize_columns</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;normalize_columns&quot;</span><span class="p">],</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span>
                                            <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">][</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_last_update</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">load_table_if_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">last_update</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">do_not_load_excel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">,</span>
                               <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            table_name (str): nome da tabela (sera o mesmo do arquivo a ser salvo)</span>
<span class="sd">            table_data (pd.DataFrame): tabela de dados</span>
<span class="sd">            last_update (timestamp): timestamp da ultima edicao feita na tabela</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_table_tracker</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>


        <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">last_update</span> <span class="o">&gt;</span> <span class="n">last_update_time</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__export_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="n">normalize_columns</span><span class="p">,</span>
                                <span class="n">do_not_load_excel</span><span class="o">=</span><span class="n">do_not_load_excel</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">,</span>
                                <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="n">is_data_in_bytes</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="n">bytes_extension</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">scan_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Para todos os arquivos cadastrados, vai buscar e carregar quando houver</span>
<span class="sd">            arquivo mais recente.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">load_file_if_modified</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">)</span>


    <span class="c1">#def __load_bytes(self, content: bytes, extension=&quot;.xlsx&quot;) -&gt; pd.DataFrame:</span>
    <span class="c1">#    if extension == &quot;.xlsx&quot; or extension == &quot;xlsx&quot; or extension == &quot;xls&quot;:</span>
    <span class="c1">#        df = pd.read_excel(io.BytesIO(content), engine=&quot;openpyxl&quot;)</span>
    <span class="c1">#    </span>
    <span class="c1">#        return df</span>
<span class="c1">#</span>
    <span class="c1">#    raise ValueError(f&#39;Extension {extension} not supported&#39;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__load_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">,</span> <span class="s2">&quot;.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;xlsx&quot;</span><span class="p">,</span> <span class="s2">&quot;xls&quot;</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;openpyxl&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extension </span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__export_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">do_not_load_excel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">,</span>
                       <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">):</span>

        <span class="n">dest_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span>
        <span class="c1">#TODO -&gt; formatar para index=False</span>
        <span class="c1"># Salvando em formato excel</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">count_attempt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">is_data_in_bytes</span><span class="p">:</span>
            <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_bytes</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">bytes_extension</span><span class="p">)</span>

        <span class="c1"># Se o index tiver dados, vamos trata-los para virar uma coluna</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="c1"># Tratando o nome do index, caso seja necessario transformar em coluna</span>
            <span class="n">prev_index</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">prev_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_name</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">prev_index</span>
            <span class="n">table_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">index_name</span>

            <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">normalize_columns</span><span class="p">:</span>
            <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__persist_column_formatting</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_not_load_excel</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">count_attempt</span> <span class="o">&lt;</span> <span class="n">attempts</span><span class="p">:</span>
                <span class="n">count_attempt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1_000_000</span><span class="p">:</span>
                        <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
                    <span class="n">table_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">dest_directory</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">count_attempt</span> <span class="o">=</span> <span class="n">attempts</span> <span class="c1"># sair do loop</span>

                <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao tentar salvar arquivo </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">. Feche o arquivo. Tentativa </span><span class="si">{</span><span class="n">count_attempt</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">count_attempt</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Salvando em csv </span>
        <span class="c1"># -&gt; Salvar em csv foi descontinuado por falta de uso.</span>
        <span class="c1">#table_data.to_csv(dest_directory/&quot;csv&quot;/f&quot;{table_name}.csv&quot;, sep=&quot;;&quot;, index=False)</span>

        <span class="c1"># Salvando em parquet (tudo como string... dtypes deverao ser atribuidos na leitura)</span>
        <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">table_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">dest_directory</span><span class="o">/</span><span class="s2">&quot;parquet&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;fastparquet&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_to_blob</span><span class="p">:</span>
            <span class="c1"># Definindo o Container e o Blob Name</span>
            <span class="n">container_name</span> <span class="o">=</span> <span class="s2">&quot;luxorasap&quot;</span>
            <span class="n">blob_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blob_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span>  <span class="c1">#</span>

            <span class="c1"># Conversão para parquet em memória (sem precisar salvar local)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>
            <span class="n">parquet_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">parquet_buffer</span><span class="p">)</span>
            <span class="n">parquet_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Reseta o ponteiro para o início do buffer</span>

            <span class="c1"># Conectando ao Blob Storage</span>
            <span class="n">connection_string</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AZURE_STORAGE_CONNECTION_STRING&#39;</span><span class="p">)</span>
            <span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">conn_str</span><span class="o">=</span><span class="n">connection_string</span><span class="p">)</span>

            <span class="c1"># Criando um Blob Client</span>
            <span class="n">blob_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">container_name</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">blob_name</span><span class="p">)</span>
            <span class="n">blob_client</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">parquet_buffer</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">luxorDB_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.__init__" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Fornece uma forma padronizada de carregar tabelas para a luxorDB.
    1. Possui metodos para carregar tabelas que já estao carregadas na memória
        - Sao os metodos que possuem 'table' no nome
    2. Possui metodos para carregar arquivos de excel, com todas as suas abas
        Inclui metodo para checagem de alteracao de versao do arquivo
        - Sao os metodos que possuem 'file' no nome
Args:
    luxorDB_directory (pathlib.Path, optional): Caminho completo ate o diretorio de destino dos dados.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fornece uma forma padronizada de carregar tabelas para a luxorDB.</span>
<span class="sd">        1. Possui metodos para carregar tabelas que já estao carregadas na memória</span>
<span class="sd">            - Sao os metodos que possuem &#39;table&#39; no nome</span>
<span class="sd">        2. Possui metodos para carregar arquivos de excel, com todas as suas abas</span>
<span class="sd">            Inclui metodo para checagem de alteracao de versao do arquivo</span>
<span class="sd">            - Sao os metodos que possuem &#39;file&#39; no nome</span>
<span class="sd">    Args:</span>
<span class="sd">        luxorDB_directory (pathlib.Path, optional): Caminho completo ate o diretorio de destino dos dados.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="n">luxorDB_directory</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">luxorDB_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s2">&quot;LuxorDB&quot;</span><span class="o">/</span><span class="s2">&quot;tables&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.add_file_tracker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_file_tracker</span><span class="p">(</span><span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">,</span> <span class="n">sheet_names</span><span class="o">=</span><span class="p">{},</span> <span class="n">excel_size_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.add_file_tracker" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Adiciona arquivo na lista para checar por alteracao
Args:
    tracked_file_path (pathlib.Path): caminho completo ate o arquivo,
            incluindo nome do arquivo e extensão.
    sheet_names (dict, optional): Caso seja uma planilha com varias abas, mapear
            aqui o nome da aba para o nome do arquivo de saida desejado.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_file_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;excel&quot;</span><span class="p">,</span> <span class="n">sheet_names</span><span class="o">=</span><span class="p">{},</span> 
        <span class="n">excel_size_limit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Adiciona arquivo na lista para checar por alteracao</span>
<span class="sd">    Args:</span>
<span class="sd">        tracked_file_path (pathlib.Path): caminho completo ate o arquivo,</span>
<span class="sd">                incluindo nome do arquivo e extensão.</span>
<span class="sd">        sheet_names (dict, optional): Caso seja uma planilha com varias abas, mapear</span>
<span class="sd">                aqui o nome da aba para o nome do arquivo de saida desejado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tracked_file_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;last_mtime&quot;</span> <span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;filetype&quot;</span> <span class="p">:</span> <span class="n">filetype</span><span class="p">,</span> <span class="s2">&quot;sheet_names&quot;</span><span class="p">:</span> <span class="n">sheet_names</span><span class="p">,</span>
                <span class="s2">&quot;excel_size_limit&quot;</span> <span class="p">:</span> <span class="n">excel_size_limit</span><span class="p">,</span>
                <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                <span class="s2">&quot;index_name&quot;</span> <span class="p">:</span> <span class="n">index_name</span><span class="p">,</span>
                <span class="s2">&quot;normalize_columns&quot;</span> <span class="p">:</span> <span class="n">normalize_columns</span><span class="p">,</span>
            <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.add_table_tracker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_table_tracker</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.add_table_tracker" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Adiciona tabela na lista para controle de alteracao.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_table_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Adiciona tabela na lista para controle de alteracao.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.is_file_modified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_file_modified</span><span class="p">(</span><span class="n">tracked_file_path</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.is_file_modified" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Checa se o arquivo foi modificado desde a ultima leitura.
Returns:
    tuple(bool, float): (foi modificado?, timestamp da ultima modificacao)</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_file_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">}:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checa se o arquivo foi modificado desde a ultima leitura.</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple(bool, float): (foi modificado?, timestamp da ultima modificacao)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span>

    <span class="n">last_saved_time</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span>
    <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">tracked_file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
    <span class="k">return</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="n">last_saved_time</span><span class="p">,</span> <span class="n">file_last_update</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.load_file_if_modified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_file_if_modified</span><span class="p">(</span><span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.load_file_if_modified" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Carrega arquivo no caminho indicado, carregando na base de dados caso modificado.
Args:
    tracked_file_path (pathlib.Path): caminho ate o arquivo(cadastro previamente por add_file_tracker)
    type_map (<em>type</em>, optional): <em>description</em>. Defaults to None.
    filetype (str, optional): <em>description</em>. Defaults to "excel".</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_file_if_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Carrega arquivo no caminho indicado, carregando na base de dados caso modificado.</span>
<span class="sd">    Args:</span>
<span class="sd">        tracked_file_path (pathlib.Path): caminho ate o arquivo(cadastro previamente por add_file_tracker)</span>
<span class="sd">        type_map (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        filetype (str, optional): _description_. Defaults to &quot;excel&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">]</span>

    <span class="n">last_saved_time</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span>
    <span class="n">filetype</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;filetype&quot;</span><span class="p">]</span>
    <span class="n">file_sheets</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;sheet_names&quot;</span><span class="p">]</span>

    <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">tracked_file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>

    <span class="k">if</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="n">last_saved_time</span><span class="p">:</span> <span class="c1"># Houve alteracao no arquivo</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;excel&quot;</span><span class="p">:</span>
            <span class="n">file_sheets</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_sheets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_sheets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># tables sera sempre um dicionario de tabelas</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trials</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">trials</span> <span class="o">-</span> <span class="n">t_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">tracked_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">file_sheets</span><span class="p">)</span>
                    <span class="n">t_counter</span> <span class="o">=</span> <span class="n">trials</span> <span class="c1"># leitura concluida</span>
                <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao tentar ler arquivo &#39;</span><span class="si">{</span><span class="n">tracked_file_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Tentativa </span><span class="si">{</span><span class="n">t_counter</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">trials</span><span class="si">}</span><span class="s2">;&#39;.</span><span class="se">\n</span><span class="s2">Se estiver aberto feche.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">t_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">table_data</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">table_name</span> <span class="o">=</span> <span class="n">sheet_name</span> <span class="k">if</span> <span class="n">file_sheets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;sheet_names&quot;</span><span class="p">][</span><span class="n">sheet_name</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;trades&quot;</span><span class="p">:</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">index</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__export_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="n">index_name</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;index_name&quot;</span><span class="p">],</span>
                                        <span class="n">normalize_columns</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;normalize_columns&quot;</span><span class="p">],</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span>
                                        <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">[</span><span class="n">tracked_file_path</span><span class="p">][</span><span class="s2">&quot;last_mtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_last_update</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.load_table_if_modified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_table_if_modified</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">last_update</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_load_excel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">,</span> <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.load_table_if_modified" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nome da tabela (sera o mesmo do arquivo a ser salvo)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table_data</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tabela de dados</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>last_update</code>
            </td>
            <td>
                  <code><span title="timestamp">timestamp</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>timestamp da ultima edicao feita na tabela</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_table_if_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">last_update</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">do_not_load_excel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">,</span>
                           <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        table_name (str): nome da tabela (sera o mesmo do arquivo a ser salvo)</span>
<span class="sd">        table_data (pd.DataFrame): tabela de dados</span>
<span class="sd">        last_update (timestamp): timestamp da ultima edicao feita na tabela</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_table_tracker</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>


    <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">last_update</span> <span class="o">&gt;</span> <span class="n">last_update_time</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__export_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">normalize_columns</span><span class="o">=</span><span class="n">normalize_columns</span><span class="p">,</span>
                            <span class="n">do_not_load_excel</span><span class="o">=</span><span class="n">do_not_load_excel</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">,</span>
                            <span class="n">is_data_in_bytes</span><span class="o">=</span><span class="n">is_data_in_bytes</span><span class="p">,</span> <span class="n">bytes_extension</span><span class="o">=</span><span class="n">bytes_extension</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.scan_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scan_files</span><span class="p">(</span><span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.scan_files" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Para todos os arquivos cadastrados, vai buscar e carregar quando houver
arquivo mais recente.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">scan_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Para todos os arquivos cadastrados, vai buscar e carregar quando houver</span>
<span class="sd">        arquivo mais recente.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_files</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_file_if_modified</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">export_to_blob</span><span class="o">=</span><span class="n">export_to_blob</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="n">blob_directory</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_dataloader.DataLoader.text_to_lowercase" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></code>

<a href="#luxorDB_dataloader.DataLoader.text_to_lowercase" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Converte todas as colunas de texto para lowercase
Args:
    t (pd.DataFrame): pandas DataFrame
Returns:
    pd.DataFrame</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_dataloader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">text_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converte todas as colunas de texto para lowercase</span>
<span class="sd">    Args:</span>
<span class="sd">        t (pd.DataFrame): pandas DataFrame</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Luxor Group
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>