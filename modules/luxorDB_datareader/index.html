
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentação completa do stack LuxorASAP em produção (2025)">
      
      
      
        <link rel="canonical" href="https://SEU_DOMINIO/modules/luxorDB_datareader/">
      
      
        <link rel="prev" href="../source_bases_updater/">
      
      
        <link rel="next" href="../luxorDB_dataloader/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>luxorDB_datareader.py - LuxorASAP Onedrive Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#luxordb_datareaderpy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LuxorASAP Onedrive Docs" class="md-header__button md-logo" aria-label="LuxorASAP Onedrive Docs" data-md-component="logo">
      
  <img src="../../assets/logo_png.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LuxorASAP Onedrive Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              luxorDB_datareader.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="orange"  aria-label="Alternar Dark Mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Alternar Dark Mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LuxorASAP Onedrive Docs" class="md-nav__button md-logo" aria-label="LuxorASAP Onedrive Docs" data-md-component="logo">
      
  <img src="../../assets/logo_png.png" alt="logo">

    </a>
    LuxorASAP Onedrive Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visão Geral
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Arquitetura
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Arquitetura
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/file_tree/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Estrutura de arquivos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/data_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data-flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/bloomberg_data_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bloomberg Data Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/pipeline_luxorASAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline run_luxorASAP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Módulos
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Módulos
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    carteira_online.production
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            carteira_online.production
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/portfolio_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    portfolio_builder.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/return_calculator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    return_calculator.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/cash_calculator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cash_calculator.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/btg_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    btg_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/asset_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    asset_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/historical_data_extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    historical_data_extraction.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/leitor_carteira_excel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    leitor_carteira_excel.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../carteira_online/production/onedrive_file_redirect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    onedrive_file_redirect.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    source_bases.scripts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            source_bases.scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/hist_concentration_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hist_concentration_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/custom_funds_quotas_updater.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    custom_funds_quotas_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/non_bbg_data_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    non_bbg_data_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/daily_pnl_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    daily_pnl_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/historical_quotas_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    historical_quotas_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/risk_metrics_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    risk_metrics_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/us_cash_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    us_cash_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases/scripts/swaps_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    swaps_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../run_luxorASAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    run_luxorASAP.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../market_data_extractor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    market_data_extractor.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../market_data_loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    market_data_loader.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_bases_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    source_bases_updater.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    luxorDB_datareader.py
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    luxorDB_datareader.py
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luxorDB_datareader" class="md-nav__link">
    <span class="md-ellipsis">
      luxorDB_datareader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery" class="md-nav__link">
    <span class="md-ellipsis">
      LuxorQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LuxorQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__get_positions_and_movements" class="md-nav__link">
    <span class="md-ellipsis">
      __get_positions_and_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__hist_prices_intraday_extensor" class="md-nav__link">
    <span class="md-ellipsis">
      __hist_prices_intraday_extensor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__is_table_modified" class="md-nav__link">
    <span class="md-ellipsis">
      __is_table_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_adjusted_avg_price" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_adjusted_avg_price
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_attribution" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_attribution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_daily_pnl" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_daily_pnl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_drawdown" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_drawdown
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_fund_particip" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_fund_particip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_price_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_price_correlation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_tracking_error" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_tracking_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_bday_offset" class="md-nav__link">
    <span class="md-ellipsis">
      get_bday_offset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_bdays_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_bdays_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_benchmark_spx_cash" class="md-nav__link">
    <span class="md-ellipsis">
      get_benchmark_spx_cash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_current_fx_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_fx_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_group_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_group_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_hist_cash_movements" class="md-nav__link">
    <span class="md-ellipsis">
      get_hist_cash_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_position_variation" class="md-nav__link">
    <span class="md-ellipsis">
      get_position_variation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_positions" class="md-nav__link">
    <span class="md-ellipsis">
      get_positions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_positions_and_movements" class="md-nav__link">
    <span class="md-ellipsis">
      get_positions_and_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_price" class="md-nav__link">
    <span class="md-ellipsis">
      get_price
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_price_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_price_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_prices" class="md-nav__link">
    <span class="md-ellipsis">
      get_prices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_px_update_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_px_update_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_risk_metric" class="md-nav__link">
    <span class="md-ellipsis">
      get_risk_metric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_start_period_dt" class="md-nav__link">
    <span class="md-ellipsis">
      get_start_period_dt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_table" class="md-nav__link">
    <span class="md-ellipsis">
      get_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.is_holiday" class="md-nav__link">
    <span class="md-ellipsis">
      is_holiday
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.list_blob_files" class="md-nav__link">
    <span class="md-ellipsis">
      list_blob_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.normalize_price_key" class="md-nav__link">
    <span class="md-ellipsis">
      normalize_price_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.normalize_trades" class="md-nav__link">
    <span class="md-ellipsis">
      normalize_trades
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.simulate_portfolio_performance" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_portfolio_performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.text_to_lowercase" class="md-nav__link">
    <span class="md-ellipsis">
      text_to_lowercase
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.usdbrl_clean_coupon_fix" class="md-nav__link">
    <span class="md-ellipsis">
      usdbrl_clean_coupon_fix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.xirr" class="md-nav__link">
    <span class="md-ellipsis">
      xirr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../luxorDB_dataloader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    luxorDB_dataloader.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../planilhas/planilhas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planilhas
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How To
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            How To
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/add_new_asset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Adicionar novo ativo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/create_price_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Criar série de preços
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luxorDB_datareader" class="md-nav__link">
    <span class="md-ellipsis">
      luxorDB_datareader
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery" class="md-nav__link">
    <span class="md-ellipsis">
      LuxorQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LuxorQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__get_positions_and_movements" class="md-nav__link">
    <span class="md-ellipsis">
      __get_positions_and_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__hist_prices_intraday_extensor" class="md-nav__link">
    <span class="md-ellipsis">
      __hist_prices_intraday_extensor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.__is_table_modified" class="md-nav__link">
    <span class="md-ellipsis">
      __is_table_modified
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_adjusted_avg_price" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_adjusted_avg_price
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_attribution" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_attribution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_daily_pnl" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_daily_pnl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_drawdown" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_drawdown
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_fund_particip" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_fund_particip
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_price_correlation" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_price_correlation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.calculate_tracking_error" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_tracking_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_bday_offset" class="md-nav__link">
    <span class="md-ellipsis">
      get_bday_offset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_bdays_count" class="md-nav__link">
    <span class="md-ellipsis">
      get_bdays_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_benchmark_spx_cash" class="md-nav__link">
    <span class="md-ellipsis">
      get_benchmark_spx_cash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_current_fx_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_fx_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_group_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_group_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_hist_cash_movements" class="md-nav__link">
    <span class="md-ellipsis">
      get_hist_cash_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_position_variation" class="md-nav__link">
    <span class="md-ellipsis">
      get_position_variation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_positions" class="md-nav__link">
    <span class="md-ellipsis">
      get_positions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_positions_and_movements" class="md-nav__link">
    <span class="md-ellipsis">
      get_positions_and_movements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_price" class="md-nav__link">
    <span class="md-ellipsis">
      get_price
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_price_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_price_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_prices" class="md-nav__link">
    <span class="md-ellipsis">
      get_prices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_px_update_time" class="md-nav__link">
    <span class="md-ellipsis">
      get_px_update_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_risk_metric" class="md-nav__link">
    <span class="md-ellipsis">
      get_risk_metric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_start_period_dt" class="md-nav__link">
    <span class="md-ellipsis">
      get_start_period_dt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.get_table" class="md-nav__link">
    <span class="md-ellipsis">
      get_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.is_holiday" class="md-nav__link">
    <span class="md-ellipsis">
      is_holiday
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.list_blob_files" class="md-nav__link">
    <span class="md-ellipsis">
      list_blob_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.normalize_price_key" class="md-nav__link">
    <span class="md-ellipsis">
      normalize_price_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.normalize_trades" class="md-nav__link">
    <span class="md-ellipsis">
      normalize_trades
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.simulate_portfolio_performance" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_portfolio_performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.text_to_lowercase" class="md-nav__link">
    <span class="md-ellipsis">
      text_to_lowercase
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.usdbrl_clean_coupon_fix" class="md-nav__link">
    <span class="md-ellipsis">
      usdbrl_clean_coupon_fix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luxorDB_datareader.LuxorQuery.xirr" class="md-nav__link">
    <span class="md-ellipsis">
      xirr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="luxordb_datareaderpy"><code>luxorDB_datareader.py</code><a class="headerlink" href="#luxordb_datareaderpy" title="Permanent link">¶</a></h1>
<p>Classe <code>LuxorQuery</code> – API de acesso/leitura ao LuxorDB.</p>


<div class="doc doc-object doc-module">



<a id="luxorDB_datareader"></a>
    <div class="doc doc-contents first">

        <p>Modulo para leitura e manipulacao dos dados do LuxorDB.
Desenvolvido por: Sergio C. Filho
Data: 2023-01-01
Versao: 1.0</p>


<details class="resumo" open>
  <summary>Resumo</summary>
  <p>A classe 'LuxorQuery' fornece uma interface para acessar e manipular dados do LuxorDB.
Ela gerencia o carregamento de tabelas (CSV, Parquet, Excel), otimiza o acesso a preços
e dados históricos, e oferece funcionalidades para cálculos financeiros como
retornos, posições e conversões de moeda.</p>
</details>

<details class="explicação-mais-detalhada" open>
  <summary>Explicação mais detalhada</summary>
  <p>A classe 'LuxorQuery' é uma ferramenta abrangente para interagir com o LuxorDB. Ela oferece as seguintes funcionalidades:</p>
<ul>
<li><strong>Carregamento de Dados Flexível</strong>: Suporta o carregamento de tabelas de diversas fontes (ADLS, Parquet, Excel)</li>
<li><strong>Otimização de Preços e Dados Históricos</strong>: Implementa um cache de preços para consultas rápidas e gerencia o acesso a séries históricas de preços de ativos, VCs, e dados não-Bloomberg.</li>
<li><strong>Manipulação de Dados Financeiros</strong>:<ul>
<li><strong>Preços</strong>: Recupera preços de ativos em datas específicas, com conversão de moeda e tratamento para dados intraday.</li>
<li><strong>Retornos</strong>: Calcula retornos percentuais para ativos individuais e grupos, com opções de ajuste por amortização e períodos personalizados (YTD, MTD, etc.).</li>
<li><strong>Posições</strong>: Fornece o histórico de posições de fundos, incluindo posições internas de fundos aninhados.</li>
<li><strong>Movimentações de Caixa</strong>: Acessa e sumariza movimentações de caixa por fundo.</li>
<li><strong>Dívida a Termo</strong>: Calcula a dívida a termo para um fundo específico.</li>
<li><strong>Preço Médio</strong>: Obtém o preço médio de um ativo em um fundo em uma data específica.</li>
</ul>
</li>
<li><strong>Gerenciamento de Datas e Feriados</strong>: Inclui funções para verificar feriados, calcular dias úteis e determinar datas de início de períodos financeiros.</li>
<li><strong>Benchmarks</strong>: Calcula benchmarks compostos, como o benchmark Luxor (S&amp;P + Caixa), com ajuste para diferentes moedas e períodos históricos.</li>
<li><strong>Normalização de Trades</strong>: Converte trades para a moeda desejada, ajustando para BDRs e câmbio.</li>
<li><strong>Dados de Ativos</strong>: Acessa informações detalhadas sobre ativos, como tamanho de BDRs e outros campos de dados.</li>
</ul>
<p>A classe é projetada para ser robusta, com tratamento de erros e otimizações para garantir o desempenho na recuperação e manipulação de grandes volumes de dados financeiros.</p>
</details>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="luxorDB_datareader.LuxorQuery" class="doc doc-heading">
            <code>LuxorQuery</code>


<a href="#luxorDB_datareader.LuxorQuery" class="headerlink" title="Permanent link">¶</a></h2>


    <div class="doc doc-contents ">








              <details class="quote">
                <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuxorQuery</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_mode</span><span class="o">=</span><span class="s2">&quot;optimized&quot;</span><span class="p">,</span> <span class="n">is_develop_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tables_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            update_mode: </span>
<span class="sd">                &#39;standard&#39; - Carrega todas as tabelas disponiveis</span>
<span class="sd">                &#39;optimized&#39; - Carrega apenas as tabelas utilizadas sob demanda</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modified_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_develop_mode</span> <span class="o">=</span> <span class="n">is_develop_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blob_directory</span> <span class="o">=</span> <span class="n">blob_directory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span> <span class="o">=</span> <span class="n">tables_path</span>
        <span class="k">if</span> <span class="n">tables_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_tables_path</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset_last_prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># otimizacao da consulta de preco</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">lipi_manga_incorp_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">update_modes_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;standard&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;optimized&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_modes_name</span><span class="p">[</span><span class="n">update_mode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span> <span class="c1"># Nessa 1° exec. vai inicializar os dicionarios acima</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">__set_tables_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">cur_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">cur_dir_items</span> <span class="o">=</span> <span class="n">cur_dir</span><span class="o">.</span><span class="n">parts</span>
        <span class="n">home</span> <span class="o">=</span> <span class="n">cur_dir</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
        <span class="n">onedrive_name</span> <span class="o">=</span> <span class="n">cur_dir_items</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;OneDrive&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">onedrive_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No formato atual, para utilizar esse modulo a main deve ser executada dentro do diretorio do OneDrive.&quot;</span><span class="p">)</span>
        <span class="c1">#formato considerado eh: &quot;C:/Users/{user}/{onedrive_name}&quot;</span>

        <span class="n">tables_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home</span><span class="p">)</span><span class="o">/</span><span class="n">onedrive_name</span><span class="o">/</span><span class="s2">&quot;projetos&quot;</span><span class="o">/</span><span class="s2">&quot;LuxorASAP&quot;</span><span class="o">/</span><span class="s2">&quot;luxorDB&quot;</span><span class="o">/</span><span class="s2">&quot;tables&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_develop_mode</span><span class="p">:</span>
            <span class="n">tables_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home</span><span class="p">)</span><span class="o">/</span><span class="n">onedrive_name</span><span class="o">/</span><span class="s2">&quot;projetos&quot;</span><span class="o">/</span><span class="s2">&quot;LuxorASAP_Develop&quot;</span><span class="o">/</span><span class="s2">&quot;luxorDB&quot;</span><span class="o">/</span><span class="s2">&quot;tables&quot;</span>

        <span class="k">return</span> <span class="n">tables_path</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__is_table_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Retorna &#39;True&#39; ou &#39;False&#39; informando se a tabela informada em &#39;table_name&#39; foi criada ou modificada.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name (str): nome tabela</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True se foi criada ou modificada</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;table_path&quot;</span><span class="p">]</span>
            <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;update_time&quot;</span><span class="p">]</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arquivo &lt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&gt; não encontrado.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__persist_column_formatting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="n">columns_to_persist</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Vehicles&quot;</span><span class="p">,</span> <span class="s2">&quot;Segment&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Vamos persistir a formatacao de algumas colunas</span>
            <span class="n">columns_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">columns_to_persist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span>
            <span class="n">persistent_data</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">columns_to_persist</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">columns_to_normalize</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns_order</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns_to_persist</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">columns_to_normalize</span><span class="p">])</span>
            <span class="n">t</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">columns_to_persist</span><span class="p">]</span> <span class="o">=</span> <span class="n">persistent_data</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">columns_order</span><span class="p">]</span>

        <span class="c1"># Nos outros casos, transformaremos tudo em lowercase</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__get_tickers_bbg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Deprecated. </span>
        <span class="c1"># Criado apenas para manter compatibilidade</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Acesso direto a tabela &#39;bbg_ticker&#39; sera descontinuado.</span><span class="se">\n</span><span class="s2">Ao inves disso, pegue os valores unicos de asset[Ticker_BBG]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)[</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="p">{},</span> <span class="n">force_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Retorna uma copia do DataFrame do &#39;table_name&#39; correspondente. Se não estiver disponivel,</span>
<span class="sd">            retorna None.</span>

<span class="sd">            table_name: </span>
<span class="sd">                &#39;px_last&#39;              - Último preco dos ativos\n</span>
<span class="sd">                &#39;trades&#39;               - Historico de boletas dos trades da Luxor\n</span>
<span class="sd">                &#39;assets&#39;               - Tabela de ativos validos\n</span>
<span class="sd">                &#39;hist_px_last&#39;         - Preço histórico dos ativos desde 1990\n</span>
<span class="sd">                &#39;hist_vc_px_last&#39;      - Preço histórico dos VCs\n</span>
<span class="sd">                &#39;hist_non_bbg_px_last&#39; - Preço histórico de ativos sem preco no bbg (fidc trybe, spx hawker)\n</span>
<span class="sd">                &#39;[NOME_FUNDO]_quotas   - Cotas historicas do fundo (fund_a, fund_b, hmx, ...\n</span>
<span class="sd">                &#39;hist_us_cash&#39;         - Historico de caixas dos fundos (us apenas)\n</span>
<span class="sd">                &#39;bbg_tickers&#39;          - Ticker bbg de todos os tickers cadastrados\n</span>
<span class="sd">                &#39;bdr_sizes&#39;            - Tabela com o ultimo peso de cada bdr\n</span>
<span class="sd">                &#39;hist_swap&#39;            - Tabela historica dos swaps\n</span>
<span class="sd">                &#39;hist_positions&#39;       - Historico de posicoes dos fundos\n</span>
<span class="sd">                &#39;hist_positions_by_bank- Posicoes por banco\n</span>
<span class="sd">                &#39;cash_movements&#39;       - Historico de movimentacoes com data de liquidacao\n</span>
<span class="sd">                &#39;holidays&#39;             - Tabela de feriados das bolsas\n</span>
<span class="sd">                &#39;daily_pnl&#39;            - Tabela de PnL diario\n</span>
<span class="sd">                &#39;custom_funds_quotas&#39;  - Cotas dos fundos customizados(luxor equities, non-equities, etc)\n</span>

<span class="sd">            dtypes_override: dict : set - Dicionario com os tipos de dados das colunas devem ser sobrescritos.</span>
<span class="sd">                Deve possuir as chaves &#39;float&#39;, &#39;date&#39;, &#39;bool&#39; e &#39;str_nan_format&#39;(troca &#39;nan&#39; por pd.NA)</span>
<span class="sd">                    Para cada chave, colocar um Set com os nomes das colunas que receberao o cast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s1">&#39;bbg_tickers&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_tickers_bbg</span><span class="p">()</span> <span class="c1"># DEPRECATED TODO: remover apos testes</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">table_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;table_data&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="n">dtypes_override</span><span class="p">)</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">__load_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="p">{}):</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">__read_blob_parquet</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>

            <span class="n">connection_string</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AZURE_STORAGE_CONNECTION_STRING&#39;</span><span class="p">)</span>
            <span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">conn_str</span><span class="o">=</span><span class="n">connection_string</span><span class="p">)</span>

            <span class="n">container_name</span> <span class="o">=</span> <span class="s2">&quot;luxorasap&quot;</span>
            <span class="n">blob_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blob_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span>

            <span class="n">blob_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">container_name</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">blob_name</span><span class="p">)</span>

            <span class="c1"># Download do blob em memória</span>
            <span class="n">download_stream</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">download_stream</span> <span class="o">=</span> <span class="n">blob_client</span><span class="o">.</span><span class="n">download_blob</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tabela &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39; não encontrada no blob.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
            <span class="n">parquet_data</span> <span class="o">=</span> <span class="n">download_stream</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>

            <span class="c1"># Ler o parquet do stream em memória</span>
            <span class="n">parquet_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">parquet_data</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">parquet_buffer</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="kc">True</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">__load_parquet</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
            <span class="n">table_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span><span class="o">/</span><span class="s2">&quot;parquet&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">update_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">table_path</span><span class="p">)</span>
                <span class="n">table_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Primeiro, vamos tentar ler do blob</span>
                <span class="n">table_data</span><span class="p">,</span> <span class="n">blob_read_success</span> <span class="o">=</span> <span class="n">__read_blob_parquet</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">blob_read_success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--&gt; Onedrive fallback.&quot;</span><span class="p">)</span>
                    <span class="n">table_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">table_path</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;fastparquet&quot;</span><span class="p">)</span>

                <span class="n">table_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                <span class="n">float_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">,</span> <span class="s2">&quot;px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;Quota&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg_price&quot;</span><span class="p">,</span> <span class="s2">&quot;Variation&quot;</span><span class="p">,</span> <span class="s2">&quot;Variation_tot&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="s2">&quot;%_MoM&quot;</span><span class="p">,</span> <span class="s2">&quot;PL&quot;</span><span class="p">,</span> <span class="s2">&quot;AUM&quot;</span><span class="p">,</span> <span class="s2">&quot;%_pl&quot;</span><span class="p">,</span> <span class="s2">&quot;Market_Value&quot;</span><span class="p">,</span> <span class="s2">&quot;P&amp;L_MoM&quot;</span><span class="p">,</span> <span class="s2">&quot;Debt&quot;</span><span class="p">,</span> <span class="s2">&quot;Kd&quot;</span><span class="p">,</span> <span class="s2">&quot;P&amp;L_YTD&quot;</span><span class="p">,</span> <span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Weight&quot;</span><span class="p">,</span> <span class="s2">&quot;%_YTD&quot;</span><span class="p">,</span> <span class="s2">&quot;Net_Debt/Ebitda&quot;</span><span class="p">,</span> <span class="s2">&quot;adr_adr_per_sh&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span><span class="p">,</span><span class="s2">&quot;Liquidity_Rule&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Daily_Return&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">,</span> <span class="s2">&quot;Adjust&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily_Adm_Fee&quot;</span><span class="p">,</span> <span class="s2">&quot;Timestamp&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtypes_override</span><span class="p">:</span>
                    <span class="n">float_dtypes</span> <span class="o">=</span> <span class="n">float_dtypes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dtypes_override</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>

                <span class="n">date_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;last_update_dt&quot;</span><span class="p">,</span> <span class="s2">&quot;Query_Time&quot;</span><span class="p">,</span> <span class="s2">&quot;update_time&quot;</span><span class="p">,</span> <span class="s2">&quot;Update_Time&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Settlement Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Today&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">dtypes_override</span><span class="p">:</span>
                    <span class="n">date_dtypes</span> <span class="o">=</span> <span class="n">date_dtypes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dtypes_override</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

                <span class="n">bool_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Ignore Flag&quot;</span><span class="p">,</span> <span class="s2">&quot;Disable BDP&quot;</span><span class="p">,</span> <span class="s2">&quot;Hist_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Historical_Data&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;bool&#39;</span> <span class="ow">in</span> <span class="n">dtypes_override</span><span class="p">:</span>
                    <span class="n">bool_dtypes</span> <span class="o">=</span> <span class="n">bool_dtypes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dtypes_override</span><span class="p">[</span><span class="s1">&#39;bool&#39;</span><span class="p">])</span>

                <span class="n">str_nan_format</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;str_nan_format&#39;</span> <span class="ow">in</span> <span class="n">dtypes_override</span><span class="p">:</span>
                    <span class="n">str_nan_format</span> <span class="o">=</span> <span class="n">str_nan_format</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dtypes_override</span><span class="p">[</span><span class="s1">&#39;str_nan_format&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">table_name</span> <span class="o">!=</span> <span class="s2">&quot;last_all_flds&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">float_dtypes</span><span class="p">):</span>
                        <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;hist_risk_metrics&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cols_to_format</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Fund&quot;</span><span class="p">})</span>
                        <span class="n">table_data</span><span class="p">[</span><span class="n">cols_to_format</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="n">cols_to_format</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ao carregar tabela &#39;hist_px_last&#39;, nao foi possivel converter dados para float.&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">date_dtypes</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mixed&quot;</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bool_dtypes</span><span class="p">):</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;falso&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">str_nan_format</span><span class="p">):</span>
                    <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>



                <span class="k">return</span> <span class="n">table_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">update_time</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nao foi possivel carregar a tabela &lt;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&gt; no formato .parquet&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">__load_csv</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
            <span class="n">table_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span><span class="o">/</span><span class="s2">&quot;csv&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">update_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">table_path</span><span class="p">)</span>
                <span class="n">table_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">table_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">table_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">update_time</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nao foi possivel carregar a tabela &lt;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&gt; no formato .csv&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">__load_excel</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
                <span class="n">update_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">table_path</span><span class="p">)</span>
                <span class="c1"># Nao deixar crashar caso nao consiga ler do excel !</span>
                <span class="n">table_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">table_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tabela </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> carregada do arquivo em excel. Limite 1M de linhas.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">table_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">update_time</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">table_path</span><span class="p">,</span> <span class="kc">None</span>       
        <span class="c1"># Tentando carregar, do mais eficiente pro menos eficiente.</span>
        <span class="n">table_data</span><span class="p">,</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">update_time</span> <span class="o">=</span> <span class="n">__load_parquet</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="c1">#if table_data is None: CSV DESCONTINUADO POR FALTA DE USO</span>
        <span class="c1">#    table_data, table_path, update_time = __load_csv(table_name)</span>
        <span class="k">if</span> <span class="n">table_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_data</span><span class="p">,</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">update_time</span> <span class="o">=</span> <span class="n">__load_excel</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

        <span class="c1">#assert(table_data is not None)</span>
        <span class="k">if</span> <span class="n">table_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nao foi possivel carregar a tabela &lt;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&gt;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">table_data</span>

        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nao foi possível setar a coluna </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2"> como index para a tabela </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__persist_column_formatting</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;table_data&quot;</span> <span class="p">:</span> <span class="n">table_data</span><span class="p">,</span>
                                          <span class="s2">&quot;table_path&quot;</span> <span class="p">:</span> <span class="n">table_path</span><span class="p">,</span>
                                          <span class="s2">&quot;update_time&quot;</span> <span class="p">:</span> <span class="n">update_time</span>
                                          <span class="p">}</span>
        <span class="k">return</span> <span class="n">table_data</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__load_table_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_keys</span><span class="p">):</span>

        <span class="n">price_tables_loaded_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="n">table_keys</span><span class="p">:</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;last_all_flds&quot;</span><span class="p">]</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="s2">&quot;Key&quot;</span> <span class="k">if</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;last_all_flds&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">table_key</span> <span class="o">==</span> <span class="s2">&quot;px_last&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">asset_last_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">table_key</span> <span class="o">==</span> <span class="s2">&quot;last_all_flds&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_all_flds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">]:</span>
                <span class="n">price_tables_loaded_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Fund&quot;</span> <span class="p">:</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Quota&quot;</span> <span class="p">:</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span> <span class="p">:</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;Last_Price&quot;</span>
                                            <span class="p">})[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">table_key</span> <span class="o">==</span> <span class="s1">&#39;hist_vc_px_last&#39;</span><span class="p">:</span>

                    <span class="n">last_prices</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
                    <span class="n">last_date_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_prices</span><span class="p">)})</span>
                    <span class="n">last_date_df</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_prices</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">last_date_df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_prices</span><span class="o">.</span><span class="n">values</span>

                    <span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">table</span><span class="p">,</span> <span class="n">last_date_df</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
                                                            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span>
                                                            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="p">[</span><span class="o">~</span><span class="n">g</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                                            <span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">[</span><span class="n">table_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;px_last&#39;</span> <span class="ow">in</span> <span class="n">table_keys</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;hist_px_last&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">):</span>
            <span class="c1"># Vamos pegar o px_last e colocar na tabela de precos historicos, atualizando ultima ocorrencia</span>
            <span class="n">hist_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">)</span>
            <span class="n">hist_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_hist_px_last_intraday</span><span class="p">(</span><span class="n">hist_prices</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">[</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_prices</span>
            <span class="n">price_tables_loaded_flag</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="k">if</span> <span class="n">price_tables_loaded_flag</span><span class="p">:</span> <span class="c1"># Somente se a execucao alterou o estado de ´price_tables_loaded  </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_attempts_limit</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Atualiza todas as tabelas em uso.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">update_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># -&gt; reset da otimizacao da consulta de preco </span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">update_success</span> <span class="ow">and</span> <span class="p">(</span><span class="n">update_attempts</span> <span class="o">&lt;</span> <span class="n">update_attempts_limit</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
                    <span class="c1"># Verificando se tabela foi criada ou modificada</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_table_modified</span><span class="p">(</span><span class="n">table_key</span><span class="p">):</span>                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="n">table_key</span><span class="p">])</span>


                <span class="n">update_success</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                <span class="n">hist_prices_tables</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># desconsidera appends feitos no loop nao concluido</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Não foi possível carregar as tabelas pois tem algum arquivo aberto.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentativas de atualização: </span><span class="si">{</span><span class="n">update_attempts</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">update_attempts_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Não foi possivel carregar as tabelas.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentativas de atualização: </span><span class="si">{</span><span class="n">update_attempts</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">update_attempts_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">update_attempts</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Nao foi possivel atualizar os dados. Execução finalizada.&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">text_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converte todas as colunas de texto para lowercase</span>
<span class="sd">        Args:</span>
<span class="sd">            t (dt.DataFrame): pandas DataFrame</span>
<span class="sd">        Returns:</span>
<span class="sd">            dt.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Pendente de atualizacao para o python 3.12.2&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_px_update_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Informa Horário da ultima atualizacao da base de precos.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dt.datetime</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;px_last&quot;</span><span class="p">)[</span><span class="s2">&quot;Query_Time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_price_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Retorna a chave correta a ser usada para consultar o preco/rentabilidade do ativo.&quot;&quot;&quot;</span>

        <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Key == @asset_key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vc&quot;</span><span class="p">,</span> <span class="s2">&quot;luxor&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>

        <span class="c1"># Verificando se ha valor valido de ticker bbg</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

            <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]</span>
        <span class="c1"># caso nao haja, sera usado o ticker</span>
        <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger_level</span><span class="o">=</span><span class="s2">&quot;trace&quot;</span><span class="p">,</span> <span class="n">dr_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">asset_location</span><span class="o">=</span><span class="s2">&quot;us&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Informa o preço do ativo. Quando px_date nao eh informado, retorna o</span>
<span class="sd">        preço mais recente.</span>

<span class="sd">        Args:</span>
<span class="sd">            ticker (str): identificador do ativo.</span>
<span class="sd">            px_date (dt.date, optional): Data de referencia.</span>
<span class="sd">            logger_level (str, optional): Defaults to &quot;trace&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: preço do ativo.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>


        <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">asset_location</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span> <span class="ow">and</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>
                    <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">px_date</span><span class="p">)</span>
                    <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">usdbrl</span>
                <span class="k">elif</span> <span class="n">asset_location</span> <span class="o">==</span> <span class="s2">&quot;us&quot;</span> <span class="ow">and</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;brl&quot;</span><span class="p">:</span>
                    <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">px_date</span><span class="p">)</span>
                    <span class="n">currency_factor</span> <span class="o">=</span> <span class="n">usdbrl</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao converter moeda para </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2"> para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># dados do usd cupom limpo comecam em abril de 2011. Antes disso vamos pergar usdbrl normalmente</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ticker</span> <span class="o">==</span> <span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">px_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">px_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span> <span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;usdbrl curncy&quot;</span>

        <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">ticker</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">px_date</span><span class="p">)</span> <span class="c1"># chave unica do preco para essa data</span>
        <span class="c1"># se o preco foi consultado recentemente, podemos retorna-lo rapidamente.</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">*</span> <span class="n">currency_factor</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">px_date</span><span class="o">&gt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
            <span class="c1"># Nesse caso retornamos o mais recente utilizando o dicionario</span>

            <span class="k">if</span> <span class="s2">&quot;px_last&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;px_last&quot;</span><span class="p">])</span>

            <span class="c1">#if ticker in self.asset_last_prices.keys():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_last_prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;px_last&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">price_1_tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fip mission 1.1&#39;</span><span class="p">,</span> <span class="s1">&#39;caixa&#39;</span><span class="p">,</span> <span class="s1">&#39;caixa us&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">price_1_tickers</span> <span class="p">:</span>
                    <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if px_last_at_date is None:</span>
                    <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                    <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="mi">0</span>


            <span class="k">return</span> <span class="n">px_last_at_date</span> <span class="o">*</span> <span class="n">currency_factor</span>

        <span class="c1"># Vamos olhar em cada tabela de precos procurando pelo ticker informado</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">])</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Busca otimizada do preco pelo ativo e pela data informada</span>
            <span class="c1">#px_last_at_date = (self.hist_prices_table[&quot;Last_Price&quot;]</span>
            <span class="c1">#                    .to_numpy()[(</span>
            <span class="c1">#                            (self.hist_prices_table[&quot;Date&quot;].dt.date.to_numpy() &lt;= px_date) </span>
            <span class="c1">#                            &amp; </span>
            <span class="c1">#                            (self.hist_prices_table[&quot;Asset&quot;].to_numpy() == ticker) </span>
            <span class="c1">#                            )].item(-1)</span>
            <span class="c1">#                    )</span>
            <span class="c1">#return  px_last_at_date</span>

            <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @px_date and Asset == @ticker&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">px_last_at_date</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="n">currency_factor</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">px_last_at_date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="c1"># Nao achou o ativo em nenhuma das tabelas, retorna 0</span>
            <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
            <span class="k">return</span> <span class="mi">0</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">usdbrl_clean_coupon_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usdbrl_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Corrige o problema do ticker bmfxclco curncy nao ter dados intraday.</span>
<span class="sd">            Usa a variacao intraday do usdbrl curncy</span>
<span class="sd">        Args:</span>
<span class="sd">            usdbrl_df (pd.DataFrame): dataframe com precos historicos do bmfxclco curncy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_date</span> <span class="o">=</span> <span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_date</span> <span class="o">&lt;</span> <span class="n">today</span><span class="p">:</span>
            <span class="c1"># vamos pegar a variacao do usdbrl curncy</span>
            <span class="n">var_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s1">&#39;usdbrl curncy&#39;</span><span class="p">,</span> 
                                               <span class="n">recent_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span>
                                               <span class="n">previous_date</span><span class="o">=</span><span class="n">max_date</span><span class="p">)</span>
            <span class="c1"># vamos pegar o last_price em max_date</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="n">usdbrl_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @max_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="c1"># vamos ajustar com a variacao do usdbrl</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="n">last_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">var_usdbrl</span><span class="p">)</span>
            <span class="c1">#vamos colocar na base na data de hoje</span>
            <span class="n">usdbrl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">usdbrl_df</span><span class="p">,</span> 
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span><span class="p">:[</span><span class="n">today</span><span class="p">],</span>
                                      <span class="s2">&quot;Asset&quot;</span><span class="p">:[</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">],</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:[</span><span class="n">last_price</span><span class="p">]})])</span>

            <span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">usdbrl_df</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__update_hist_px_last_intraday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_prices</span><span class="p">):</span>

        <span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_prices</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">px_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;px_last&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Selecionando todos os tickers que estao na tabela px_last</span>
        <span class="n">px_last</span> <span class="o">=</span> <span class="n">px_last</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Key in @tickers&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># Vamos alterar a ultima ocorrencia desses tickers na hist_prices pelos valores na px_last</span>
        <span class="c1"># vamos fazer de forma vetorizada]</span>
        <span class="n">hist_prices_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">hist_prices</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">px_last</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">],</span>
                                        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;last_update_dt&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">hist_prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">hist_prices</span><span class="p">[</span><span class="s1">&#39;px_last&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
                                             <span class="n">hist_prices</span><span class="p">[</span><span class="s1">&#39;px_last&#39;</span><span class="p">],</span> 
                                             <span class="n">hist_prices</span><span class="p">[</span><span class="s1">&#39;Last_Price&#39;</span><span class="p">])</span>
        <span class="n">hist_prices</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="p">[</span><span class="n">hist_prices_columns</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">hist_prices</span>   


    <span class="k">def</span><span class="w"> </span><span class="nf">__hist_prices_intraday_extensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_prices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Completa a tabela de precos historicos com o preco intraday mais recente.</span>

<span class="sd">        Args:</span>
<span class="sd">            hist_prices (pd.DataFrame): dataframe de precos historicos</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Verificar cada Asset unico existente na tabela</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">updated_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># vamos fazer cada ativo por vez</span>
        <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
            <span class="c1"># vamos pegar a tabela de precos do ativo</span>
            <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == @asset&quot;</span><span class="p">)</span>
            <span class="c1"># Vamos pegar a data mais recente</span>
            <span class="n">last_date</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">last_date</span> <span class="o">==</span> <span class="n">today</span><span class="p">:</span>
                <span class="n">last_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
                <span class="n">asset_prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">asset_prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_date</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_price</span>
                <span class="n">updated_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset_prices</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="k">continue</span>
            <span class="c1"># vamos pegar o ultimo preco presente no df</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @last_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="c1"># vamos pegar a variacao ate o momento mais recente</span>
            <span class="n">query_asset</span> <span class="o">=</span> <span class="n">asset</span>
            <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">:</span>
                <span class="n">query_asset</span> <span class="o">=</span> <span class="s1">&#39;usdbrl curncy&#39;</span>
            <span class="n">variation</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">today</span> <span class="o">&gt;</span> <span class="n">last_date</span><span class="p">:</span>
                <span class="n">variation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="n">query_asset</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">)</span>
            <span class="c1"># vamos ajustar o preco com a variacao</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="n">last_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span>
            <span class="c1"># vamos colocar na base na data de hoje</span>
            <span class="n">updated_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">asset_prices</span><span class="p">,</span> 
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span><span class="p">:[</span><span class="n">today</span><span class="p">],</span>
                                      <span class="s2">&quot;Asset&quot;</span><span class="p">:[</span><span class="n">asset</span><span class="p">],</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:[</span><span class="n">last_price</span><span class="p">]})]))</span>

        <span class="n">updated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">updated_dfs</span><span class="p">)</span>
        <span class="n">updated_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">updated_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">updated_df</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
                         <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Filtra o historico de preços pelos tickers e pelo periodo informado.</span>

<span class="sd">        Args:</span>
<span class="sd">            recent_date (dt.date, optional): data de fim. Por padrao, data de hoje.</span>
<span class="sd">            previous_date (dt.date, optional): data de inicio. Por padrao, 30 dias antes de hoje.</span>
<span class="sd">            tickers (list|set, optional): Lista de tickers que devem ser incluidos, quando existirem.</span>
<span class="sd">            period(str): ytd, mtd ou &#39;xm&#39; onde &#39;x&#39; é o numero de meses.</span>
<span class="sd">            currency(str): codigo de 3 caracteres da moeda ou &#39;all&#39; para considerar a moeda local de cada ativo.</span>
<span class="sd">            period(str): ytd|mtd|&#39;xm&#39; onde &#39;x&#39; é o numero de meses. Usara como base o parametro &#39;recent_date&#39;</span>
<span class="sd">            holiday_location(str): all|any|us|bz ... ver metodo &#39;is_holiday&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Tabela de precos filtrada e convertida para moeda desejada</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recent_date</span> <span class="o">&lt;</span> <span class="n">previous_date</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Possivel inversao dos parametros de inicio e fim do periodo.&quot;</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">recent_date</span>
            <span class="n">recent_date</span> <span class="o">=</span> <span class="n">previous_date</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;custom_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">,</span> <span class="s2">&quot;px_last&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="c1"># Vamos tentar sem o custom_funds_quotas, pois pode nao existir ainda.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">,</span> <span class="s2">&quot;px_last&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tickers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#prices = self.hist_prices_table.query(&quot;Date &lt;= @recent_date and Date &gt;= @previous_date&quot;)</span>
            <span class="c1"># Nesse caso, tickers sera uma lista com todos os ativos da tabela de precos</span>
            <span class="n">tickers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tickers</span><span class="p">]</span>

        <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">]</span> <span class="c1"># padronizando tickers para lowercase</span>

        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="n">surrogate_previous_date</span> <span class="o">=</span> <span class="n">previous_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">surrogate_recent_date</span> <span class="o">=</span> <span class="n">recent_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @surrogate_recent_date and Date &gt;= @surrogate_previous_date</span><span class="se">\</span>
<span class="s2">                                   and Asset.isin(@tickers)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_continuous_date_range</span><span class="p">:</span>
            <span class="c1"># Vamos ajustar as datas logo aqui, caso flag esteja ativa</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>\
                            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">get_intraday_prices</span><span class="p">:</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hist_prices_intraday_extensor</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>

            <span class="c1"># TODO:  Resolver problema de consistencia com ticker e ticker_bbg </span>

            <span class="n">assets</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type != &#39;ações_bdr&#39; and Asset != &#39;spx eagle&#39;&quot;</span><span class="p">)</span>

            <span class="n">ticker_map</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Ticker_BBG.isna() and Ticker_BBG != Ticker&quot;</span><span class="p">)[[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
            <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ticker_map</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ticker_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

            <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]],</span> <span class="n">prices</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]]</span>
            <span class="n">currency_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bz&quot;</span><span class="p">:</span><span class="s2">&quot;brl&quot;</span><span class="p">,</span> <span class="s2">&quot;us&quot;</span><span class="p">:</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;cn&quot;</span><span class="p">:</span><span class="s2">&quot;cad&quot;</span><span class="p">,</span> <span class="s2">&quot;eur&quot;</span><span class="p">:</span><span class="s2">&quot;eur&quot;</span><span class="p">}</span>
            <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">currency_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="n">prices_by_location</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iter_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">iter_prices</span><span class="p">:</span>
                <span class="n">price_currency</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prices_by_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;Location&quot;</span><span class="p">})],</span> 
                                                                <span class="n">price_currency</span><span class="o">=</span><span class="n">price_currency</span><span class="p">,</span> <span class="n">dest_currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                                                <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="n">force_continuous_date_range</span><span class="p">,</span>
                                                                <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="n">get_intraday_prices</span><span class="p">,</span>
                                                                <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">))</span>


            <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">prices_by_location</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="c1"># Finalmente, vamos seguir filtrando pelo periodo desejado.</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @recent_date and Date &gt;= @previous_date and Asset.isin(@tickers)&quot;</span><span class="p">)</span>

        <span class="c1">#if adjust_bmfxlcoc and (&#39;bmfxclco curncy&#39; in tickers) and (recent_date == dt.date.today()):</span>
        <span class="c1">#    max_date = prices.query(&quot;Asset == &#39;bmfxclco curncy&#39;&quot;)[&quot;Date&quot;].max()</span>
        <span class="c1">#    if max_date &lt; dt.date.today(): # vamos colocar mais um dia usando usdbrl curncy</span>
        <span class="c1">#        var_usdbrl1d = self.get_pct_change(&#39;usdbrl curncy&#39;, </span>
        <span class="c1">#                                           recent_date=dt.date.today(),</span>
        <span class="c1">#                                           previous_date=max_date)</span>
        <span class="c1">#        # vamos pegar o last_price em max_date</span>
        <span class="c1">#        last_price = self.get_price(&#39;bmfxclco curncy&#39;, px_date=max_date)</span>
        <span class="c1">#        # vamos ajustar com a variacao do usdbrl</span>
        <span class="c1">#        last_price = last_price * (1 + var_usdbrl1d)</span>
        <span class="c1">#        #vamos colocar na base na data de hoje</span>
        <span class="c1">#        prices = pd.concat([prices, </span>
        <span class="c1">#                    pd.DataFrame({&quot;Date&quot;:[dt.date.today()],</span>
        <span class="c1">#                                  &quot;Asset&quot;:[&#39;bmfxclco curncy&#39;], &quot;Last_Price&quot;:[last_price]})])</span>

        <span class="k">return</span> <span class="n">prices</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">convert_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">price_currency</span><span class="p">,</span> <span class="n">dest_currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span>
                         <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                         <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">price_currency</span> <span class="o">==</span> <span class="n">dest_currency</span><span class="p">:</span> <span class="k">return</span> <span class="n">prices</span>

        <span class="n">convertion_rule</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;brl_usd&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="n">usdbrl_ticker</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;divide&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;usd_brl&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="n">usdbrl_ticker</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;multiply&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;eur_usd&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="s2">&quot;usdeur curncy&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;divide&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;usd_eur&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="s2">&quot;usdeur curncy&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;multiply&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;usd_cad&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="s2">&quot;cad curncy&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;multiply&quot;</span><span class="p">},</span>
                           <span class="s2">&quot;cad_usd&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">:</span><span class="s2">&quot;cad curncy&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;operation&quot;</span><span class="p">:</span><span class="s2">&quot;divide&quot;</span><span class="p">},</span> 
                                        <span class="p">}</span>


        <span class="n">convertion_ticker</span> <span class="o">=</span> <span class="n">convertion_rule</span><span class="p">[</span><span class="n">price_currency</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dest_currency</span><span class="p">][</span><span class="s2">&quot;currency_ticker&quot;</span><span class="p">]</span>
        <span class="n">convertion_operation</span> <span class="o">=</span> <span class="n">convertion_rule</span><span class="p">[</span><span class="n">price_currency</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">dest_currency</span><span class="p">][</span><span class="s2">&quot;operation&quot;</span><span class="p">]</span>

        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">recent_date</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">currencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">convertion_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span>
                                     <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="n">force_continuous_date_range</span><span class="p">,</span> 
                                     <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="n">get_intraday_prices</span><span class="p">,</span>
                                     <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">convertion_operation</span> <span class="o">==</span> <span class="s2">&quot;divide&quot;</span><span class="p">:</span>
            <span class="n">currencies</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">currencies</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>

        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">currencies</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;Currency&quot;</span><span class="p">}),</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Currency&quot;</span><span class="p">]]</span>

        <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Currency&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">prices</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;Currency&quot;</span><span class="p">})</span> <span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">flds</span><span class="p">,</span> <span class="n">data_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger_level</span><span class="o">=</span><span class="s2">&quot;trace&quot;</span><span class="p">):</span>

        <span class="n">flds</span> <span class="o">=</span> <span class="n">flds</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flds</span> <span class="o">==</span> <span class="s2">&quot;px_last&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">data_date</span><span class="p">,</span> <span class="n">logger_level</span><span class="o">=</span><span class="n">logger_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Vamos buscar o dado mais recente</span>
            <span class="n">data_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_all_flds</span><span class="p">[</span><span class="n">ticker</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">flds</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;last_all_flds&quot;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_all_flds</span><span class="p">[</span><span class="n">ticker</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">flds</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>    
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Formatando o valor retornado</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;field_map&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Field == @flds&quot;</span><span class="p">)[</span><span class="s2">&quot;Value_Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;numerical&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">data_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">data_value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">!=</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;field &#39;</span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2">&#39; nao foi cadastrado na tabela field_map.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data_value</span>

        <span class="c1"># Buscamos por dado numa data especifica. </span>
        <span class="n">hist_all_flds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_all_flds&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hist_all_flds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @data_date and Field == @flds and Ticker == @ticker&quot;</span><span class="p">)[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dado de </span><span class="si">{</span><span class="n">flds</span><span class="si">}</span><span class="s2"> nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="c1"># Nenhum dado encontrado para a data informada</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_bdr_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ticker</span> <span class="o">==</span> <span class="s1">&#39;mcor34 bz equity&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="mi">4</span> <span class="c1">#TODO remover quando atualizacao da table for reestabelecida</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;bdr_sizes&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sizes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>    


    <span class="k">def</span><span class="w"> </span><span class="nf">get_cash_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">):</span>

        <span class="n">cash_movements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;cash_movements&quot;</span><span class="p">)</span>
        <span class="c1">#cash_movements[&quot;Settlement Date&quot;] = cash_movements[&quot;Settlement Date&quot;].dt.date</span>
        <span class="c1">#cash_movements[&quot;Date&quot;] = pd.to_datetime(cash_movements[&quot;Date&quot;]).dt.date #Conversao para Date só funcionou dessa maneira</span>
        <span class="n">cash_movements</span> <span class="o">=</span> <span class="n">cash_movements</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(Fund == @fund_name) and (Date &gt; @ref_date)&quot;</span><span class="p">)[[</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]]</span>
        <span class="c1">#cash_movements = cash_movements.loc[ ((cash_movements[&quot;Fund&quot;] == fund_name) &amp; (cash_movements[&quot;Date&quot;] &gt; ref_date)) ] [[&quot;Type&quot;, &quot;Volume&quot;]]</span>
        <span class="c1">#cash_movements.to_excel(&quot;temmmp.xlsx&quot;)</span>
        <span class="n">cash_movements</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cash_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">cash_movements</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_avg_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_name and Asset_ID == @asset_key and Date &lt;= @date&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">positions</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="mi">0</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_term_debt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">):</span>

        <span class="n">term_debt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;last_positions&quot;</span><span class="p">)</span>
        <span class="n">term_debt</span> <span class="o">=</span> <span class="n">term_debt</span><span class="o">.</span><span class="n">loc</span> <span class="p">[((</span><span class="n">term_debt</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;term debt&quot;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">term_debt</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">fund_name</span><span class="p">))][[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg_price&quot;</span><span class="p">]]</span>
        <span class="n">total_debt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">term_debt</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">term_debt</span><span class="p">[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">total_debt</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_holiday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span>  <span class="n">location</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            date (dt.date): </span>
<span class="sd">            location (str): </span>
<span class="sd">                    &#39;any&#39;-&gt; se é feriado em qualquer um dos lugares cadastrados\n</span>
<span class="sd">                    &#39;all&#39; -&gt; se é feriado em todas as localidades da tabela\n</span>
<span class="sd">                    &#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela\n</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: se é ou nao feriado</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">holidays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;holidays&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span> <span class="ow">and</span> <span class="n">location</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">holidays</span> <span class="o">=</span> <span class="n">holidays</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">n_locations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">holidays</span> <span class="o">=</span> <span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;count == @n_locations&quot;</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="k">return</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_bday_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bz&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Retorna dia util com offset dias pra frente ou pra tras.\n</span>
<span class="sd">                location (str): </span>
<span class="sd">                    &#39;any&#39;-&gt; se é feriado em qualquer um dos lugares cadastrados\n</span>
<span class="sd">                    &#39;all&#39; -&gt; se é feriado em todas as localidades da tabela\n</span>
<span class="sd">                    &#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela\n</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset_direction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset_direction</span> <span class="o">=</span> <span class="n">offset</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="c1"># Pegamos proxima data</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">offset_direction</span><span class="p">)</span>
            <span class="c1"># Verificamos se eh dia util. Se for, contabilizamos.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_holiday</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">offset_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">date</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_bdays_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bz&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcula quantos dias uteis existem entre recent_date e previous_date</span>
<span class="sd">        (Exclusivo, ou seja, recent_date e previous_date nao sao contados)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iter_date</span> <span class="o">=</span> <span class="n">recent_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># primeiro dia nao eh contado</span>

        <span class="k">while</span> <span class="n">iter_date</span> <span class="o">&gt;</span> <span class="n">previous_date</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">iter_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_holiday</span><span class="p">(</span><span class="n">iter_date</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">iter_date</span> <span class="o">-=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">counter</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_month_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">):</span>

        <span class="n">ref_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_start_period_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                            <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A partir da data informada e do periodo, retorna a data de inicio do periodo.</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_date (dt.date): A data de referencia</span>
<span class="sd">            period (str): O periodo em questao dado em meses, ou ytd ou mtd. Ex.: &#39;12m&#39;, &#39;6m&#39;, &#39;ytd&#39;, &#39;mtd&#39;, &#39;24m&#39;</span>
<span class="sd">            force_bday (bool): Determina se a data retorna devera ser dia util\n</span>
<span class="sd">            holiday_location (str): \n</span>
<span class="sd">                                    &quot;bz&quot;,&quot;us&quot; -&gt; considerar feriados num local especifico\n</span>
<span class="sd">                                    &quot;all&quot; -&gt; considerar feriados globais apenas\n</span>
<span class="sd">                                    &quot;any&quot; -&gt; considerar feriado em qualquer localidade (dentre bz e us)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> 

            <span class="n">n_months</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">force_month_end</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">ref_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">n_months</span><span class="p">)</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_month_end</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">is_leap_date</span> <span class="o">=</span> <span class="p">((</span><span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">is_leap_date</span><span class="p">:</span>
                    <span class="n">ref_date</span> <span class="o">=</span> <span class="n">ref_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


                <span class="n">year_offset</span> <span class="o">=</span> <span class="n">n_months</span><span class="o">//</span><span class="mi">12</span> <span class="c1"># obtendo o numero de anos inteiros no periodo informado</span>
                <span class="n">month_offset</span> <span class="o">=</span> <span class="n">n_months</span><span class="o">%</span><span class="mi">12</span> <span class="c1"># obtendo o numero de anos parciais </span>

                <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="n">year_offset</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">-</span> <span class="n">month_offset</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_leap_date</span><span class="p">:</span>
                    <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># forcando avanco ao mes seguinte</span>
                    <span class="c1"># Retornando ao ultimo dia do mes anterior</span>
                    <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">start_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">start_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;ytd&quot;</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;mtd&quot;</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># A partir de uma data pegar o trimestre anterior</span>
        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s1">&#39;qtr&#39;</span><span class="p">:</span>
            <span class="c1"># Deve retornar sempre a ultima data do final do trimestre anterior</span>
            <span class="n">current_quarter</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">start_of_current_quarter</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="p">(</span><span class="n">current_quarter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_of_current_quarter</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Last day of previous quarter</span>

            <span class="c1">#start_date = ref_date - pd.DateOffset(months=3) </span>
            <span class="c1">#start_date = start_date.date()</span>
            <span class="c1">#start_date = self.get_month_end(start_date)</span>

        <span class="k">if</span> <span class="n">force_bday</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">start_date</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__calculate_benchmark_spxt_cash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">prop_spxt</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                                                <span class="n">cash_ticker</span><span class="o">=</span><span class="s2">&quot;jpmutcc lx equity&quot;</span><span class="p">,</span> <span class="n">spx_ticker</span><span class="o">=</span><span class="s2">&quot;spxt index&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_benchmark_spx_cash</span><span class="p">(</span><span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span>
                                         <span class="n">spx_ticker</span><span class="o">=</span><span class="n">spx_ticker</span><span class="p">,</span> <span class="n">prop_spx</span><span class="o">=</span><span class="n">prop_spxt</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="n">prop_cash</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="o">=</span><span class="n">cash_ticker</span><span class="p">,</span>
                                         <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1">#&quot;inx index&quot;</span>
        <span class="n">previous_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @previous_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">recent_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @recent_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">recent_value</span><span class="o">/</span><span class="n">previous_value</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_benchmark_spx_cash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">:</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">:</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">prop_spx</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
                               <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="o">=</span><span class="s2">&quot;jpmutcc lx equity&quot;</span><span class="p">,</span> <span class="n">spx_ticker</span><span class="o">=</span><span class="s2">&quot;spxt index&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Obtem a serie historica do benchmark luxor a partir do indice s&amp;p e caixa nas proporcoes desejadas.</span>
<span class="sd">        Args:</span>
<span class="sd">            previous_date (datetime.date): Data inicial desejada</span>
<span class="sd">            recent_date (datetime.date): Data final desejada</span>
<span class="sd">            prop_spx (float, optional): Proporcao s&amp;p. Defaults to 0.8.</span>
<span class="sd">            prop_cash (float, optional): Proporcao caixa. Defaults to 0.2.</span>
<span class="sd">            currency (str, optional): Moeda desejada (&#39;usd&#39;,&#39;brl&#39;). Defaults to &quot;usd&quot;.</span>
<span class="sd">            usdbrl_ticker (str, optional): Ticker do usdbrl para conversao. Defaults to &quot;bmfxclco curncy&quot;.</span>
<span class="sd">            cash_ticker (str, optional): Ticker do ativo usado como caixa. Defaults to &quot;jpmutcc lx equity&quot;.</span>
<span class="sd">            spx_ticker (str, optional): Ticker do ativo usado como s&amp;p. Defaults to &quot;spxt index&quot;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame contendo coluna Benchmark e Datas como index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">complementary_previous_date</span><span class="o">=</span><span class="n">previous_date</span>

        <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cash_ticker</span> <span class="o">==</span> <span class="s1">&#39;jpmutcc lx equity&#39;</span><span class="p">:</span>
            <span class="c1">#logger.warning(f&quot;Nao ha datas anteriores a {dt.date(2018,12,31)} para o JPMUTCC. Sera usada essa.&quot;)</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cash_ticker</span> <span class="o">==</span> <span class="s1">&#39;sofrindx index&#39;</span><span class="p">:</span>
            <span class="c1">#logger.warning(f&quot;Nao ha datas anteriores a {dt.date(2018,12,31)} para o JPMUTCC. Sera usada essa.&quot;)</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>



        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span><span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> 
                               <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recent_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="c1"># Precisamos ajustar o ultimo preco para o mais recente</span>
            <span class="n">last_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> 
                                        <span class="s2">&quot;Asset&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;spxt index&quot;</span><span class="p">,</span><span class="n">cash_ticker</span><span class="p">],</span> 
                                      <span class="s2">&quot;Last_Price&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;spxt index&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">cash_ticker</span><span class="p">)]</span>
                                    <span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt; @d&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">last_prices</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">complementary_previous_date</span> <span class="o">!=</span> <span class="n">previous_date</span><span class="p">:</span>
            <span class="c1"># Entrar aqui significa que o periodo precisou ser ajustado, pois eh anterior a existencia do indice usado para o caixa</span>
            <span class="c1"># Nesse caso, vamos pegar todo o periodo que faltou e considerar retorno diario do FED FUND</span>

            <span class="c1"># Primeiro, obtemos o periodo completo do s&amp;p</span>
            <span class="n">data_spx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">complementary_previous_date</span><span class="p">,</span>
                                                 <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
            <span class="c1"># Em seguida, vamos pegar o parcial do jpmutcc e completar com o treasury, </span>
            <span class="c1"># Para isso, sera necessario criar uma serie normalizada a partir dos retornos diarios</span>
            <span class="n">data_treasury</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == @cash_ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="s2">&quot;Asset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">cash_initial_date</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
            <span class="n">complementary_treasury</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fedl01 index&quot;</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">complementary_previous_date</span><span class="p">,</span>
                                                 <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
            <span class="n">complementary_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">complementary_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">complementary_treasury</span> <span class="o">=</span> <span class="n">complementary_treasury</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt; @cash_initial_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data_treasury</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">complementary_treasury</span><span class="p">,</span> <span class="n">data_treasury</span><span class="p">])</span>
            <span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash_ticker</span>
            <span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_spx</span><span class="p">,</span> <span class="n">data_treasury</span><span class="p">])</span>



        <span class="c1"># Gerando tabela de granularidade mensal, com as cotas mensais do indicador</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_spx</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_cash</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Salvando a base mensal num novo df</span>
        <span class="n">df_benchmark</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Benchmark&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="c1"># Gerando base de granularidade diaria com o fator de retorno mtd com 80% spxt e 20% jpmutcc</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#df[cash_ticker].ffill() # como tende a ser constante, podemos estimar os valores na</span>
        <span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># para o s&amp;p por ser variavel, preencheremos com 0 sempre</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
        <span class="c1"># Acumulando para encontrar o retorno MTD</span>
        <span class="n">df_mtd_w</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="c1"># Ponderando para encontrar o benchmark MTD 80/20</span>
        <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;MTD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_cash</span> <span class="o">+</span> <span class="n">df_mtd_w</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_spx</span>

        <span class="c1"># Agora que temos o fator MTD granularidade diaria e a cota mensal</span>
        <span class="c1"># Vamos colocar a cota mensal numa coluna da tabela de granulariade diaria</span>
        <span class="c1"># Primeiro, precisamos de uma juncao que compreenda ano e mes</span>
        <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
        <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
        <span class="n">df_benchmark</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">:</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">})</span>

        <span class="c1"># shiftando para que seja sempre a rentabilidade acumulada ate o mes anterior.</span>
        <span class="c1"># Essa operacao tambem ira descartar qualquer acumulo feito numa data que nao for fim de mes.</span>
        <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>

        <span class="c1"># Preenchemos entao uma coluna com a rentabilidade de cada mes anterior</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_benchmark</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Finalmente, o benchmark sera obtido atraves do acumulado anterior acumulado com o MTD atual</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MTD&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Benchmark&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_quota_adjusted_by_amortization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">quota</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>

        <span class="n">amortizations</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># Amortizacao Bruta / PL antes da amortizacao</span>
                <span class="s2">&quot;maratona&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;event_date&quot;</span> <span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="s2">&quot;amortization_ratio&quot;</span> <span class="p">:</span> <span class="mf">2_517_404.21</span><span class="o">/</span><span class="mf">24_165_260.40</span><span class="p">},</span>
                              <span class="p">{</span><span class="s2">&quot;event_date&quot;</span> <span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="s2">&quot;amortization_ratio&quot;</span> <span class="p">:</span> <span class="mi">950_000</span><span class="o">/</span><span class="mf">27_633_373.46</span><span class="p">},</span>
                              <span class="p">],</span>
            <span class="p">}</span>
        <span class="c1"># Verificando se ha amortizacoes para o ativo e aplicando.</span>
        <span class="k">if</span> <span class="n">fund_name</span> <span class="ow">in</span> <span class="n">amortizations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">amortization</span> <span class="o">=</span> <span class="n">amortizations</span><span class="p">[</span><span class="n">fund_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">amortization</span> <span class="ow">in</span> <span class="n">amortization</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">amortization</span><span class="p">[</span><span class="s2">&quot;event_date&quot;</span><span class="p">]:</span>
                    <span class="n">quota</span> <span class="o">=</span>  <span class="n">quota</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">amortization</span><span class="p">[</span><span class="s2">&quot;amortization_ratio&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">quota</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_pct_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">adjust_amortization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                                     <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recent_date</span> <span class="o">&lt;</span> <span class="n">previous_date</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Possivel inversao dos parametros de inicio e fim do periodo.&quot;</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">recent_date</span>
            <span class="n">recent_date</span> <span class="o">=</span> <span class="n">previous_date</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">if</span> <span class="n">ticker</span> <span class="o">==</span> <span class="s1">&#39;benchmark luxor spx cash&#39;</span> <span class="ow">and</span> <span class="n">recent_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_benchmark_spxt_cash</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="o">=</span><span class="s2">&quot;sofrindx index&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ticker</span> <span class="o">==</span> <span class="s1">&#39;benchmark luxor sp500 85/15 cash&#39;</span> <span class="ow">and</span> <span class="n">recent_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_benchmark_spxt_cash</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">prop_spxt</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                                <span class="n">cash_ticker</span><span class="o">=</span><span class="s1">&#39;sofrindx index&#39;</span><span class="p">)</span>


        <span class="n">last_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_price</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">last_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">previous_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">previous_price</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">previous_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">previous_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ValueError:</span><span class="se">\n</span><span class="s2">ticker:</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2"> previous_price: </span><span class="si">{</span><span class="n">previous_price</span><span class="si">}</span><span class="s2"> previous_date:</span><span class="si">{</span><span class="n">previous_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adjust_amortization</span><span class="p">:</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quota_adjusted_by_amortization</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">last_price</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
            <span class="n">previous_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quota_adjusted_by_amortization</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">previous_price</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">last_price</span><span class="o">/</span><span class="n">previous_price</span><span class="o">-</span><span class="mi">1</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_pct_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span>
            <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
            <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">adjust_amortization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#TODO -&gt; garantir que a tabela de precos esta sendo atualizada pelos precos no intraday</span>
        <span class="k">if</span> <span class="n">adjust_amortization</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Ajuste de amortizacao ainda NAO implementado para esse metodo.&quot;</span><span class="p">)</span>
        <span class="c1"># Aproveitando a get_prices, para realizar as filtragens</span>
        <span class="n">pct_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span>
                                      <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                      <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">,</span>
                                       <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">True</span>
                                       <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

        <span class="n">pct_changes</span><span class="p">[</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">pct_changes</span> <span class="o">=</span> <span class="n">pct_changes</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Pct_Change&quot;</span><span class="p">]]</span>
        <span class="n">pct_changes</span><span class="p">[</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">pct_changes</span> <span class="o">=</span> <span class="n">pct_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pct_changes</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__calculate_pct_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">hist_pct_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hist_pct_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_pct_change</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">get_inner_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Fornece um dicionario com as posicoes do fundo na data informada.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_name&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">previous_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># manter funcionamento antes da implementacao da funcionalidade de cosultar multiplas datas</span>
            <span class="c1"># Separamos posicoes historicas apenas do fundo que nos interessa antes da data informada</span>
            <span class="n">hist_pos</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hist_pos</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">]</span>

            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span> <span class="c1"># Obtendo lista de rows(dicts) para iterar</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="c1"># vamos iterar do primeiro ao ultimo</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.000001</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.000001</span><span class="p">:</span>
                        <span class="n">positions</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">get_inner_positions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">positions</span>

            <span class="c1"># Vamos ver se tem fundos da luxor</span>
            <span class="c1"># Vamos remover esse e explodir em posicoes internas</span>
            <span class="n">inner_funds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lipizzaner_lipizzaner&quot;</span> <span class="p">:</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;fund a_fund a&quot;</span> <span class="p">:</span> <span class="s2">&quot;fund a&quot;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">inner_fund</span> <span class="ow">in</span> <span class="n">inner_funds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">inner_fund</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">inner_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">inner_funds</span><span class="p">[</span><span class="n">inner_fund</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span>
                                                         <span class="n">get_inner_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">positions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">inner_fund</span><span class="p">)</span>
                    <span class="n">positions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inner_positions</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">positions</span>

        <span class="c1"># Obtendo data de inicio e validando datas</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">recent_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">recent_date</span> <span class="o">&gt;</span> <span class="n">previous_date</span><span class="p">)</span>

        <span class="n">previous_or_before</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @previous_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">previous_or_before</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>

        <span class="n">after_previous</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt; @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">previous_or_before</span><span class="p">,</span> <span class="n">after_previous</span><span class="p">])</span>
        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">positions</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_bdr_adj_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

        <span class="n">ticker</span> <span class="o">=</span> <span class="n">asset_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>
        <span class="n">bdr_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdr_size</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
        <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">price_key</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="n">usdbrl</span><span class="o">/</span><span class="n">bdr_size</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">asset_id_columns</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Para um dado dataframe de trades, converte para moeda indicada.</span>
<span class="sd">            Trades devem conter as colunas Asset, Ticker e Delta_Shares.</span>
<span class="sd">            BDR: Usa o peso do BDR e a quantidade de BDR operada para chegar na quantidade do ativo original.</span>
<span class="sd">            Financeiro: Corrigido pelo cambio de fechamento.</span>

<span class="sd">        Args:</span>
<span class="sd">            trades (pd.DataFrame): dataframe de trades, mais especificamente o output</span>
<span class="sd">                            de get_positions_and_movements.</span>
<span class="sd">            currency (str): brl; usd; all -&gt; todas as moedas, no caso usd e brl</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;brl&quot;</span><span class="p">])</span>
        <span class="n">previous_date</span><span class="o">=</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">recent_date</span><span class="o">=</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>

        <span class="c1"># tratando inconsistencia da Location do spx hawker</span>
        <span class="n">spx_hawker_brl_tickers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;SPX SEG HAWKER JAN22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER FEB22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX HAWKER CL AMAR22&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SPX SEG HAWKER APR22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX HAWKER CL ASET18&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER JUN23&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER SEP23&quot;</span><span class="p">]</span>
        <span class="n">spx_hawker_brl_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">spx_hawker_brl_tickers</span><span class="p">))</span> <span class="c1"># colocando tudo para minusculo</span>
        <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">spx_hawker_brl_tickers</span><span class="p">),</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>


        <span class="c1"># Salvando os nomes das colunas antes de editar a tabela.</span>
        <span class="n">trades_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trades</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>        


        <span class="c1"># Adicionando algumas colunas que vamos precisar para conseguir distinguir os ativos</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>

        <span class="c1"># Achando quantidade do trade no ativo original -&gt; usando peso do bdr </span>
        <span class="n">bdr_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;bdr_sizes&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">bdr_sizes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;adr_adr_per_sh&quot;</span><span class="p">:</span><span class="s2">&quot;BDR_Size&quot;</span><span class="p">})</span>
        <span class="c1"># Achando quantidade do trade no ativo original -&gt; usando peso do bdr </span>
        <span class="c1"># -&gt; Partindo da premissa que sempre atualizamos o historico quando ha alteracao do peso (inplit/split do bdr)</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ações_bdr&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;BDR_Size&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">])</span>
        <span class="c1"># Ajustando quantidades dos trades de localiza proporcionalmente:</span>
        <span class="c1">#lcam_rent_ratio = 0.4388444  #0.44 rent3 para cada lcam3</span>
        <span class="c1">#lzrfy_rent_ratio = 1 # 1 rent para cada lzrfy</span>
        <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;lcam3 bz equity&#39;, trades[&quot;Delta_Shares&quot;] * lcam_rent_ratio, trades[&quot;Delta_Shares&quot;])</span>
        <span class="c1"># Ajuste da lzrfy eh desnecessario ja que eh 1:1</span>
        <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;lzrfy us equity&#39;, trades[&quot;Delta_Shares&quot;] * lzrfy_rent_ratio, trades[&quot;Delta_Shares&quot;])</span>

        <span class="c1">#brkA_brkB_ratio = 1500</span>
        <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;brk/a us equity&#39;, trades[&quot;Delta_Shares&quot;] * brkA_brkB_ratio, trades[&quot;Delta_Shares&quot;])</span>

        <span class="c1"># Adicionando coluna de usdbrl de fechamento em cada dia</span>
        <span class="n">hist_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span> <span class="s2">&quot;USDBRL&quot;</span><span class="p">})</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">hist_usdbrl</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;USDBRL&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

        <span class="c1"># Criando colunas com financeiro normalizado.</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;usd&#39;</span><span class="p">:</span>
            <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bz&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;USDBRL&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;brl&#39;</span><span class="p">:</span>
            <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;USDBRL&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades_columns</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_price_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Adiciona a coluna &#39;Price_ID&#39; no df informado representando uma chave normalizada para o preco do ativo desejado.</span>
<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame que obrigatoriamente precisa conter &#39;Asset&#39; e &#39;Ticker&#39; como colunas. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">,]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">})</span>

        <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">asset_price_key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;etf s&amp;p&quot;</span> <span class="p">:</span> <span class="s1">&#39;voo us equity&#39;</span><span class="p">,</span> <span class="s2">&quot;spx hawker&quot;</span><span class="p">:</span> <span class="s2">&quot;spx hawker usd&quot;</span><span class="p">,</span> <span class="s2">&quot;berkshire&quot;</span> <span class="p">:</span> <span class="s2">&quot;brk/b us equity&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;localiza&quot;</span> <span class="p">:</span> <span class="s2">&quot;rent3 bz equity&quot;</span><span class="p">,</span> <span class="s2">&quot;suzano&quot;</span><span class="p">:</span><span class="s2">&quot;suzb3 bz equity&quot;</span><span class="p">}</span>
        <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">asset_price_key_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">asset_price_key_map</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Price_Old_key&quot;</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>

        <span class="c1"># Casos padroes |-&gt; tratados na tabela asset, usando o get_price_key. Casos especificos adicionar no asset_price_key_map.</span>
        <span class="c1">#df[&quot;Price_Key&quot;] = np.where((df[&quot;Ticker_BBG&quot;] is None) or (df[&quot;Ticker_BBG&quot;].isnull()), df[&quot;Ticker&quot;], df[&quot;Ticker_BBG&quot;])</span>

        <span class="k">if</span> <span class="s2">&quot;Price_Key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span> <span class="n">df_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df_columns</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_average_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">asset_id</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">):</span>
        <span class="c1"># Dictionary to store cumulative cost and total shares for each ticker</span>
        <span class="n">ticker_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Function to update ticker information</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">__update_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">delta_shares</span><span class="p">,</span> <span class="n">trade_amount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ticker_info</span><span class="p">:</span>
                <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cumulative_cost&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;total_shares&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_price&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">delta_shares</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Buy trade</span>
                <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;cumulative_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">trade_amount</span>  <span class="c1"># Trade amount is negative for buys</span>

            <span class="k">elif</span> <span class="n">delta_shares</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Sell trade</span>
                <span class="c1"># Update cumulative cost using the last average price</span>
                <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;cumulative_cost&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;avg_price&#39;</span><span class="p">]</span><span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">delta_shares</span><span class="p">)</span>

            <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;total_shares&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_shares</span>

            <span class="c1"># Calculate average price</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;total_shares&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;avg_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;cumulative_cost&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s1">&#39;total_shares&#39;</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;avg_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Avoid division by zero</span>

            <span class="k">return</span> <span class="n">ticker_info</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;avg_price&quot;</span><span class="p">]</span>

        <span class="c1"># Apply the function to each row and create a new column for the average price</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Average_Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">__update_ticker</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">asset_id</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_Shares&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Trade_Amount&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_adjusted_avg_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">groupby_column</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recebe um DataFrame contendo as colunas Date, Ticker, Delta_Shares e Trade_Amount.</span>
<span class="sd">            Trade_Amount sera resultado do preco_medio anterior (ja calculado na transacao) </span>
<span class="sd">            multiplicado pela quantidade operada. ATENCAO pois na venda nao tem a informacao</span>
<span class="sd">            do valor pelo qual o ativo foi vendido.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame):</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Adiciona as colunas Cumulative_Shares, Open_Position_Cost e Average_Price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sort the DataFrame by Ticker and Date for sequential processing</span>
        <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">groupby_column</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Side&quot;</span><span class="p">])</span> <span class="c1"># sort by trade_side (para processar sempre a compra primeiro)</span>
        <span class="n">df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Calculate cumulative shares and trade value for each ticker</span>
        <span class="n">df_sorted</span><span class="p">[</span><span class="s1">&#39;Cumulative_Shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_column</span><span class="p">)[</span><span class="s1">&#39;Delta_Shares&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

        <span class="n">df_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average_price</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">)</span>
        <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Side&quot;</span><span class="p">])[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="c1">#fillna(method=&quot;ffill&quot;)</span>

        <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Cumulative_Shares&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df_sorted</span><span class="p">[</span><span class="n">df_columns</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;Cumulative_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Average_Price&quot;</span><span class="p">]]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__get_positions_and_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            fund_name (str): </span>
<span class="sd">            tickers (str|list|set, optional): Defaults to None.</span>
<span class="sd">            recent_date (datetime.date, optional): Defaults to dt.date.today().</span>
<span class="sd">            previous_date (datetime.date, optional): _description_. Defaults to dt.date.today()-dt.timedelta(days=1).</span>
<span class="sd">            period (str, optional): mtd|ytd|3m|6m|...|nm. Defaults to None.</span>
<span class="sd">            holiday_location (str, optional): any|bz|us|all. Defaults to &quot;all&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;brl&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Garantindo que a data inicial sera sempre dia util, assim eh certo de que havera preco de acao nessa data</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
        <span class="n">lipi_manga_incorp_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipi_manga_incorp_date</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>


        <span class="c1"># Filtrando somente os trades desejados</span>
        <span class="c1"># lembrando que lipi precisa abrir em fund_A e manga_master (quando antes da incorporacao)</span>
        <span class="c1"># ha ainda um ajuste no lipi, que na data da incorporacao compra as posicoes do Manga (nao podemos tirar essas boletas) </span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;trades&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Fund&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="s2">&quot;Op Type&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;#&quot;</span><span class="p">:</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span> <span class="p">:</span> <span class="s2">&quot;Trade_Amount&quot;</span><span class="p">,</span> <span class="s2">&quot;Op Type&quot;</span><span class="p">:</span><span class="s2">&quot;Op_Type&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(Date &gt; @previous_date and Date &lt;= @recent_date) and Op_Type.isin([&#39;a vista&#39;, &#39;ndf&#39;, &#39;termo&#39;, &#39;apl/resg fundos&#39;, &#39;vc capital call&#39;, &#39;vc&#39;])&quot;</span><span class="p">))</span>

        <span class="n">fund_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">fund_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s1">&#39;lipizzaner&#39;</span><span class="p">:</span>
            <span class="n">fund_filter</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;fund a&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">lipi_manga_incorp_date</span><span class="p">:</span>
                <span class="n">fund_filter</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mangalarga master&quot;</span><span class="p">]</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund in @fund_filter&quot;</span><span class="p">)</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund != &#39;lipizzaner&#39; or Date != @lipi_manga_incorp_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>


        <span class="c1"># Obtendo posicoes na data de inicio, e criando boletas de inicializacao</span>
        <span class="n">initial_positions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fund_filter</span><span class="p">:</span>
            <span class="n">fund_initial_pos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">fund_initial_pos</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">fund_initial_pos</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>

            <span class="n">initial_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">)</span>

            <span class="c1"># Adicionando coluna de tipo, pois sera necessario tratar quando type == ações_bdr</span>
            <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>

            <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">initial_prices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                              <span class="n">recent_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">})[[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">]])</span>

            <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">initial_prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">])</span>

            <span class="c1"># Corrigindo preço de entrada das BDRs</span>
            <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ações_bdr&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdr_adj_price</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">],</span> <span class="n">date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># tratando caso inicial, onde nao ha posicoes no inicio</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">trades</span><span class="p">])[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]]</span>

        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="c1"># Adicionando coluna pra marcar se eh compra ou venda. Sera usado na agregacao logo mais.</span>
        <span class="c1">#trades[&quot;Trade_Side&quot;] = np.where(trades[&quot;Delta_Shares&quot;] &lt; 0, &quot;sell&quot;, &quot;buy&quot;)</span>

        <span class="c1"># Ordenando boletas, por padrao vamos sempre comprar antes de vender.</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_trades</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span><span class="p">)</span>
        <span class="c1"># Apos normalizar os trades, eh necessario recalcular o preco da boleta</span>

        <span class="c1"># Agrupando boletas de forma a ter apenas uma boleta por dia por codigo de ativo</span>
        <span class="c1">#trades = trades.groupby([&quot;Date&quot;, &quot;Asset_ID&quot;]).agg({&quot;Delta_Shares&quot;:&quot;sum&quot;, &quot;Exec_Price&quot;:&quot;last&quot;, &quot;Trade_Amount&quot;:&quot;sum&quot;}).reset_index()</span>
        <span class="c1"># Precisamos calcular novamente o preco correto de execucao do trade</span>
        <span class="c1">#trades[&quot;Exec_Price&quot;] = abs(trades[&quot;Trade_Amount&quot;])/abs(trades[&quot;Delta_Shares&quot;])</span>

        <span class="c1"># Calculando posicao ao final de cada trade, preco medio e custo da posicao</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average_price</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="c1">#fillna(method=&quot;ffill&quot;)</span>

        <span class="c1"># Vamos agregar novamente, agora para tirar o &#39;Trade_Side&#39;, passando a ter uma linha apenas por data</span>
        <span class="c1">#trades = trades.groupby([&quot;Date&quot;, &quot;Asset_ID&quot;]).agg({&quot;Delta_Shares&quot;:&quot;sum&quot;, &quot;Exec_Price&quot;:&quot;last&quot;, &quot;Trade_Amount&quot;:&quot;sum&quot;,</span>
        <span class="c1">#                                                    &quot;Open_Quantity&quot;:&quot;last&quot;, &quot;Average_Price&quot; : &quot;last&quot;, &quot;Trade_Side&quot;:&quot;last&quot;}).reset_index()</span>
        <span class="c1"># Preco de execucao, necessita ser recalculado</span>
        <span class="c1">#trades[&quot;Exec_Price&quot;] = abs(trades[&quot;Trade_Amount&quot;])/abs(trades[&quot;Delta_Shares&quot;])</span>

        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">trades</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_positions_and_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            fund_name (str): </span>
<span class="sd">            tickers (str|list|set, optional): Defaults to None.</span>
<span class="sd">            recent_date (datetime.date, optional): Defaults to dt.date.today().</span>
<span class="sd">            previous_date (datetime.date, optional): _description_. Defaults to dt.date.today()-dt.timedelta(days=1).</span>
<span class="sd">            period (str, optional): mtd|ytd|3m|6m|...|nm. Defaults to None.</span>
<span class="sd">            holiday_location (str, optional): any|bz|us|all. Defaults to &quot;all&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__run_return_analysis</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span>
                                    <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                    <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                    <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">agregate_by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span>
                                    <span class="p">)</span>
        <span class="c1"># Vamos obter os precos de fechamento em cada dia</span>
        <span class="c1"># Preenchendo primeiro todo o historico</span>
        <span class="n">prices_previous_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">price_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span>
                    <span class="n">tickers</span><span class="o">=</span><span class="n">price_keys</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">prices_previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                    <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Finalmente, vamos atualizar com o preco mais recente do ativo na data de hoje</span>
        <span class="c1"># -&gt; Pode ser substituido pelo uso da flag get_intraday_prices na get_prices</span>
        <span class="c1"># TODO : remover essa parte e testar</span>
        <span class="c1">#df_prev = df.query(&quot;Date &lt; @dt.date.today()&quot;).copy()</span>
        <span class="c1">#df_today = df.query(&quot;Date == @dt.date.today()&quot;).copy()</span>
        <span class="c1">#assets = self.get_table(&quot;assets&quot;).rename(columns={&quot;Key&quot;:&quot;Asset_ID&quot;})</span>
        <span class="c1">#df_today = df_today.merge(assets[[&quot;Asset_ID&quot;, &quot;Location&quot;]], on=&quot;Asset_ID&quot;)</span>
        <span class="c1">#if len(df_today) &gt; 0:</span>
        <span class="c1">#    df_today[&quot;Last_Price&quot;] = df_today.apply(lambda row: self.get_price(</span>
        <span class="c1">#                                        row[&quot;Price_Key&quot;], currency=currency,</span>
        <span class="c1">#                                        usdbrl_ticker=&quot;usdbrl curncy&quot;,</span>
        <span class="c1">#                                        asset_location=row[&quot;Location&quot;]), axis=1</span>
        <span class="c1">#                                        )</span>
        <span class="c1">#    df = pd.concat([df_prev, df_today])</span>
        <span class="c1">#else:</span>
        <span class="c1">#    df = df_prev</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Amount_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]]</span>

        <span class="c1"># preenchendo Last_Price nulos com o do dia anterior para os mesmos asset_id</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">run_return_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

        <span class="n">currency</span> <span class="o">=</span> <span class="s2">&quot;usd&quot;</span>
        <span class="n">positions_and_movements_usd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__run_return_analysis</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span>
                                                                        <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                                                                        <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                                                        <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="s2">&quot;brl&quot;</span>

        <span class="n">positions_and_movements_brl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__run_return_analysis</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span>
                                                                        <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                                                                        <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                                                        <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">positions_and_movements_usd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">positions_and_movements_brl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">positions_and_movements_usd</span><span class="p">,</span> <span class="n">positions_and_movements_brl</span><span class="p">])</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__expand_hist_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_positions</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>

        <span class="c1">#for asset_id in positions_and_movements[&quot;Asset_ID&quot;].unique():</span>
        <span class="c1">#    first_trade_date = positions_and_movements[positions_and_movements[&#39;Asset_ID&#39;] == asset_id].index.min()</span>
        <span class="c1">#    date_range = pd.date_range(start=first_trade_date, end=recent_date, freq=&#39;D&#39;)</span>
        <span class="c1">#    ticker_transactions = positions_and_movements[positions_and_movements[&#39;Asset_ID&#39;] == asset_id]</span>

        <span class="c1">#    temp_df = pd.DataFrame({&#39;Date&#39;: date_range, &#39;Asset_ID&#39;: asset_id})</span>
        <span class="c1">#    temp_df = temp_df.merge(ticker_transactions, on=[&#39;Date&#39;, &#39;Asset_ID&#39;], how=&#39;left&#39;)</span>
        <span class="c1">#    columns_to_ffill = [&quot;Asset_ID&quot;, &#39;Open_Quantity&#39;,&quot;Open_Position_Cost&quot;, &quot;Average_Price&quot;]</span>
        <span class="c1">#    temp_df[columns_to_ffill] = temp_df[columns_to_ffill].ffill()</span>
        <span class="c1">#    columns_to_fill_zeros = [&quot;Delta_Shares&quot;,&quot;Trade_Amount&quot;, &quot;Exec_Price&quot;, &quot;Shares_Bought&quot;,</span>
        <span class="c1">#                            &quot;Shares_Sold&quot;, &quot;Shares_Bought_Cost&quot;, &quot;Amount_Sold&quot;, &quot;Cost_Of_Stocks_Sold&quot;, &quot;Result_Of_Stocks_Sold&quot;]</span>
        <span class="c1">#    </span>
        <span class="c1">#    temp_df[columns_to_fill_zeros] = temp_df[columns_to_fill_zeros].fillna(0)</span>
        <span class="c1">#    </span>
        <span class="c1">#    daily_positions = pd.concat([daily_positions, temp_df])</span>
        <span class="k">pass</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__run_return_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span>
            <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">agregate_by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;brl&quot;</span><span class="p">])</span>

        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_positions_and_movements</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="p">,</span>
                                                                     <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

        <span class="c1"># -&gt; Shares_Bought : Delta_Shares &gt; 0</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># -&gt; Shares_Sold : Delta_Shares &lt; 0</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># -&gt; Shares_Bought_Cost: eh o trade amount</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># -&gt; Amount_Sold : Shares_Sold * Exec_Price</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># -&gt; Cost_Of_Stocks_Sold : Shares_Sold * avg_price # vai dar ruim na zeragem, posso propagar o avg_price ao inves do cumulative_cost? Feito.</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Cost_Of_Stocks_Sold&quot;</span><span class="p">]</span> <span class="o">=</span><span class="nb">abs</span><span class="p">(</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">])</span>
        <span class="c1"># -&gt; Result_Of_Stocks_Sold: Total_Sold - Cost_Of_Stocks_Sold</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Result_Of_Stocks_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Cost_Of_Stocks_Sold&quot;</span><span class="p">]</span>

        <span class="c1">#positions_and_movements.to_excel(f&quot;testando_{currency}.xlsx&quot;)</span>
        <span class="c1"># Transformar granularidade pra diario somente aqui...</span>
        <span class="n">agg_rule</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Open_Quantity&#39;</span><span class="p">:</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;Average_Price&quot;</span><span class="p">:</span><span class="s2">&quot;last&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">:</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">:</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount_Sold&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;Cost_Of_Stocks_Sold&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;Result_Of_Stocks_Sold&quot;</span><span class="p">:</span><span class="s2">&quot;sum&quot;</span>
        <span class="p">}</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_rule</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


        <span class="c1"># diminuindo a granularidade de 1 linha por trade pra 1 linha por dia</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

        <span class="n">daily_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">asset_id</span> <span class="ow">in</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">first_trade_date</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s1">&#39;Asset_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">first_trade_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            <span class="n">ticker_transactions</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s1">&#39;Asset_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asset_id</span><span class="p">]</span>

            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">,</span> <span class="s1">&#39;Asset_ID&#39;</span><span class="p">:</span> <span class="n">asset_id</span><span class="p">})</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ticker_transactions</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Asset_ID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">columns_to_ffill</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s1">&#39;Open_Quantity&#39;</span><span class="p">,</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span>

            <span class="n">temp_df</span><span class="p">[</span><span class="n">columns_to_ffill</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">columns_to_ffill</span><span class="p">]</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
            <span class="n">columns_to_fill_zeros</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Cost_Of_Stocks_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Result_Of_Stocks_Sold&quot;</span><span class="p">]</span>

            <span class="n">temp_df</span><span class="p">[</span><span class="n">columns_to_fill_zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">columns_to_fill_zeros</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">daily_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">daily_positions</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">])</span>

        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">daily_positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># -&gt; Criar coluna price_key</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>
        <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c1"># -&gt; Fazer merge com Asset_ID, colocando colunas Name, Class e Price_Key</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">agregate_by_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">positions_and_movements</span>

        <span class="c1"># -&gt; pegar precos e colocar no diario</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                                    <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">})</span>

        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">])</span>

        <span class="c1"># -&gt; Criar coluna Market_Value</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>

        <span class="c1"># -&gt; Open_Result_Amount: Current_Position_Value - avg_price * Open_Quantity Se nao fizer assim vai dar problema no dia da zeragem</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Result_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span>

        <span class="c1"># -&gt; valido salvar uma versao nessa etapa para conferir</span>
        <span class="c1">#positions_and_movements.to_excel(&quot;testing.xlsx&quot;)</span>
        <span class="c1"># -&gt; Apos essa agregacao, nao se pode mais usar o preco medio &lt;-</span>
        <span class="c1"># -&gt; Agrupar por Name</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[[</span>
            <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Asset_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Trade_Amount&#39;</span><span class="p">,</span> <span class="c1"># &#39;Delta_Shares&#39;, &#39;Exec_Price&#39;</span>
            <span class="s1">&#39;Open_Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;Open_Position_Cost&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="c1">#&#39;Average_Price&#39;, &#39;Key&#39;</span>
            <span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="s1">&#39;Price_Key&#39;</span><span class="p">,</span> <span class="s1">&#39;Current_Position_Value&#39;</span><span class="p">,</span> <span class="c1"># &#39;Last_Price&#39;</span>
            <span class="s1">&#39;Shares_Bought&#39;</span><span class="p">,</span> <span class="s1">&#39;Shares_Sold&#39;</span><span class="p">,</span> <span class="s1">&#39;Shares_Bought_Cost&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Amount_Sold&#39;</span><span class="p">,</span> <span class="s1">&#39;Cost_Of_Stocks_Sold&#39;</span><span class="p">,</span> <span class="s1">&#39;Result_Of_Stocks_Sold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Open_Result_Amount&#39;</span><span class="p">]]</span>

        <span class="n">agg_rule</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;Asset_ID&#39;</span> <span class="p">:</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s1">&#39;Trade_Amount&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Open_Quantity&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Open_Position_Cost&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Class&#39;</span> <span class="p">:</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s1">&#39;Price_Key&#39;</span> <span class="p">:</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s1">&#39;Current_Position_Value&#39;</span> <span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Shares_Bought&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Shares_Sold&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Shares_Bought_Cost&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Amount_Sold&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Cost_Of_Stocks_Sold&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s1">&#39;Result_Of_Stocks_Sold&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Open_Result_Amount&#39;</span> <span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">}</span>

        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_rule</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># -&gt; Acc_Result_Of_Stocks_Sold : Acc_Result_Of_Stocks_Sold.cumsum()</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Result_Of_Stocks_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Result_Of_Stocks_Sold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="c1"># -&gt; Tota_Result_Amount: Acc_Result_Of_Stocks_Sold + Open_Result_Amount</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Total_Result_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Result_Of_Stocks_Sold&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Result_Amount&quot;</span><span class="p">]</span>
        <span class="c1"># -&gt; Acc_Cost_Of_Stocks_Sold : Cost_Of_Stocks_Sold.cumsum()</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Cost_Of_Stocks_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Cost_Of_Stocks_Sold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="c1"># -&gt; Acc_Buy_Cost: Total_Bough.cumsum()</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

        <span class="c1"># -&gt; %_Closed_Result: Acc_Result_Of_Stocks_Sold/Acc_Cost_Of_Stocks_Sold</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Closed_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Result_Of_Stocks_Sold&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Acc_Cost_Of_Stocks_Sold&quot;</span><span class="p">])</span>
        <span class="c1"># -&gt; %_Open_Result: Current_Position_Value/Open_Position_Cost</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># -&gt; %_Total_Result: Total_Result_Amount/Acc_Buy_Cost</span>

        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Avg_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[[</span>
                                                <span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>
                                                <span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Avg_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Avg_Cost&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">positions_and_movements</span>
                                               <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#positions_and_movements[&quot;%_Total_Result&quot;] = positions_and_movements[&quot;Total_Result_Amount&quot;]/positions_and_movements[&quot;Acc_Shares_Bought_Cost&quot;]</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Total_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Total_Result_Amount&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Avg_Cost&quot;</span><span class="p">]</span>
        <span class="c1"># -&gt; redefinir price_key e price -&gt; Precisa tratar nessa funcao o caso a caso do ticker de preco que sera mostrado</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_price_key</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">)</span>
        <span class="c1"># A normalizacao pode acabar inserindo algum ticker generico que ainda nao estava calculado. Logo, temos que pegar os precos novamente.</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                                        <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                        <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">})</span>

        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">])</span>

        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Currency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currency</span>
        <span class="c1"># Consideramos como ativos atuais aqueles que possuem posicao aberta ou que foram encerradas no dia</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned_Prev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Is_Curr_Owned&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned_Prev&quot;</span><span class="p">]</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Is_Curr_Owned_Prev&quot;</span><span class="p">])</span>

        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent_date</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">])</span>
        <span class="n">last_trades</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Trade_Amount != 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>
        <span class="n">last_trades</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">last_trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span> <span class="o">&lt;</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">last_trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">last_trades</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">])</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">last_trades</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">])</span>

        <span class="c1"># Removendo erros de divisao por 0</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Closed_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Closed_Result&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Closed_Result&quot;</span><span class="p">])</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">])</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Total_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Total_Result&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Total_Result&quot;</span><span class="p">])</span>
        <span class="c1"># Refinando, para garantir dados consistentes</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;%_Open_Result&quot;</span><span class="p">])</span>

        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Security_Acc_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Security_Acc_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="p">[[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="s2">&quot;Security_Acc_Return&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>


        <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Days_Since_Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions_and_movements</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>

        <span class="n">spx_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;inx index&quot;</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                     <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;spx_index&quot;</span><span class="p">})</span>
        <span class="n">positions_and_movements</span> <span class="o">=</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">spx_prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1">#positions_and_movements[&quot;spx_index&quot;] = (positions_and_movements[&quot;spx_index&quot;].pct_change().fillna(0)+1).cumprod()-1</span>

        <span class="k">return</span> <span class="n">positions_and_movements</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">:</span><span class="s2">&quot;Ticker&quot;</span><span class="p">})</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_fx_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">fx_ticker</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcula o PNL de FX de um fundo. -&gt; CONSIDERANDO QUE EH USDBRL&quot;&quot;&quot;</span>
        <span class="n">fx_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;last_positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund and Ticker == @fx_ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Pnl_USD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Pnl_BRL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">])</span>
        <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Exposure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>
        <span class="n">fx_positions</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[[</span><span class="s2">&quot;Pnl_USD&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_BRL&quot;</span><span class="p">,</span> <span class="s2">&quot;Exposure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fx_positions</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_hist_cash_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
            <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span> <span class="o">=</span> <span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retorna o historico de caixa do fundo.</span>
<span class="sd">        Args:</span>
<span class="sd">            fund (str): nome do fundo</span>
<span class="sd">            currency (str): moeda (usd|brl)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: historico de caixa</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## TODO: Remover linhas com pnl e retorno vazios!</span>


        <span class="n">fund</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">ref_date</span><span class="p">,</span> <span class="o">-</span><span class="n">bdays</span><span class="p">,</span>
                                        <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>

        <span class="n">cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_portfolios_concentration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Group.isin([&#39;caixa&#39;,&#39;caixa_us&#39;]) and Fund_Name == @fund&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;= @previous_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># cash estara com ambos os caixas em R$ ou U$.</span>
        <span class="c1"># Para saber a moeda do caixa retornado, precisamos saber a moeda do fundo</span>
        <span class="n">fund_key</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">fund_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;funds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_key&quot;</span><span class="p">)[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">currency_location</span>  <span class="o">=</span> <span class="s2">&quot;us&quot;</span> <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span> <span class="k">else</span> <span class="s2">&quot;bz&quot;</span>
        <span class="k">if</span> <span class="n">fund_location</span> <span class="o">!=</span> <span class="n">currency_location</span><span class="p">:</span>
            <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),)</span>
            <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usdbrl_clean_coupon_fix</span><span class="p">(</span><span class="n">usdbrl</span><span class="p">)</span>
            <span class="n">usdbrl</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usdbrl</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
            <span class="n">usdbrl</span> <span class="o">=</span> <span class="n">usdbrl</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">})</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">usdbrl</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;usdbrl&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fund_location</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">:</span>
                <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">]</span>

            <span class="c1"># Removendo coluna auxiliar</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">])</span>

        <span class="c1"># Vamos calcular o preco de fechamento com o rendimento do dia</span>
        <span class="n">bz_cash_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;bzacselc index&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">bz_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bz_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">bz_cash_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">bz_cash_index</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;bz_cash_index&quot;</span><span class="p">})</span>
                            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">us_cash_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;sofrindx index&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">us_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">us_cash_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">us_cash_index</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;us_cash_index&quot;</span><span class="p">})</span>
                            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">us_margin_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;sofr + 75bps&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">us_margin_cost</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_margin_cost</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">us_margin_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">us_margin_cost</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;us_margin_cost&quot;</span><span class="p">})</span>
                            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bz_cash_index</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">us_cash_index</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">us_margin_cost</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># Dependendo do ativo e da posicao a variacao no dia será diferente</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;bz_cash_index&quot;</span><span class="p">]</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">,</span>
                                       <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;us_cash_index&quot;</span><span class="p">],</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span>
                                       <span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">,</span>
                                       <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="s1">&#39;bz&#39;</span>
                                       <span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">)</span> <span class="p">,</span>
                                        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;us_margin_cost&quot;</span><span class="p">],</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span>
                                        <span class="p">)</span>

        <span class="n">cash</span> <span class="o">=</span> <span class="p">(</span><span class="n">cash</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Market_Value&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">]]</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Market_Value&quot;</span><span class="p">:</span><span class="s2">&quot;Close_Mkt_Value&quot;</span>
                                     <span class="p">}))</span>
        <span class="c1"># Criando colunas necessarias para concatenar com o df do daily pnl</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span>

        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>

        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Group&quot;</span><span class="p">])[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">cash</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__fix_open_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_op_fix</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span>
                         <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_op_fix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># Guardando a lista de colunas, para remover colunas auxiliares posteriormente</span>
        <span class="n">columns_list</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_op_fix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">asset_ids</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Key.isin(@asset_ids)&quot;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Currency Exposure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Currency Exposure&quot;</span> <span class="p">:</span> <span class="s2">&quot;Currency_Exposure&quot;</span>
                    <span class="p">})</span>

        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Asset_ID&#39;</span><span class="p">)</span>
        <span class="n">df_op_fix</span><span class="p">[</span><span class="s2">&quot;Needs_Fix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="p">[</span><span class="s2">&quot;Currency_Exposure&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">currency</span>

        <span class="n">df_fixed</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Needs_Fix&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Needs_Fix&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="n">local_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">df_op_fix</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span>
                                        <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="n">local_prices</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>\
                                        <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">local_prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">])</span>
        <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span>
                                 <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span>
                                 <span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">})</span>
        <span class="n">local_prices</span> <span class="o">=</span> <span class="n">local_prices</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">usdbrl</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span> <span class="p">:</span> <span class="s2">&quot;Today&quot;</span><span class="p">})</span>

        <span class="c1"># Considera apenas caso de brl e usd TODO: tratar outros casos que venham a existir</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;usd&#39;</span><span class="p">:</span>
            <span class="n">local_prices</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">local_prices</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_prices</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">local_prices</span><span class="p">[</span><span class="s1">&#39;usdbrl&#39;</span><span class="p">]</span>

        <span class="c1"># Substituindo Open_Price antigo pelo novo ja com a conversao correta de moeda</span>
        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">])</span>
        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df_op_fix</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">local_prices</span><span class="p">[[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Price&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Today&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">])</span>

        <span class="n">df_fixed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fixed</span><span class="p">,</span> <span class="n">df_op_fix</span><span class="p">])</span>
        <span class="c1"># Removendo as colunas auxiliares</span>
        <span class="n">df_fixed</span> <span class="o">=</span> <span class="n">df_fixed</span><span class="p">[</span><span class="n">columns_list</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df_fixed</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_daily_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">group_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">classification_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">asset_filters</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">currency_exposure_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_cash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_cash_debt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticker_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">annual_adm_fee</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ignore_small_pnl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span> <span class="c1">#test_op_fix=False):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Calcula o PnL do dia de cada ativo no fundo.</span>
<span class="sd">            (Nao inclui o PnL das taxas!).</span>
<span class="sd">        Args:</span>
<span class="sd">            fund (str): nome do fundo</span>
<span class="sd">            ref_date (str): data de referência do PnL</span>
<span class="sd">            currency (str): moeda (usd|brl)</span>
<span class="sd">            holiday_location (str, optional): refencia de feriados. Defaults to &quot;all&quot;.</span>
<span class="sd">            bdays (int, optional): quantidade de dias uteis a serem considerados.</span>
<span class="sd">                                Defaults to 10.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># dia util anterior</span>
        <span class="c1"># Obtendo todas as posicoes e movimentacoes, dos ultimos dias</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">ref_date</span><span class="p">,</span> <span class="o">-</span><span class="n">bdays</span><span class="p">,</span>
                                        <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions_and_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                            <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span>
                                                          <span class="s2">&quot;Currency Exposure&quot;</span><span class="p">:</span><span class="s2">&quot;Currency_Exposure&quot;</span><span class="p">})</span>

        <span class="c1"># Filtrando pelos ativos desejados</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">classification_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">classification_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Luxor_Classification.isin(@classification_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">group_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Group.isin(@group_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">type_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">type_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@type_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">asset_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">asset_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">asset_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset.isin(@asset_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticker_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ticker_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ticker_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Ticker.isin(@ticker_filters)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">currency_exposure_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">currency_exposure_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">currency_exposure_filters</span><span class="p">]</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Currency_Exposure.isin(@currency_exposure_filters)&quot;</span><span class="p">)</span>
        <span class="c1"># Fazemos uma juncao interna, mantendo somente as linhas filtradas acima</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Date&quot;</span> <span class="p">:</span> <span class="s2">&quot;Today&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Open_Quantity&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Quantity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Last_Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Current_Position_Value&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Mkt_Value&quot;</span>
        <span class="p">})</span>

        <span class="c1"># Obtendo o preco de abertura</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">])</span>
        <span class="n">types_to_fix_open_price</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndf usdbrl&#39;</span><span class="p">]</span>
        <span class="c1">#if test_op_fix:</span>

        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@types_to_fix_open_price)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_op_fix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fix_open_price</span><span class="p">(</span><span class="n">df_op_fix</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Type.isin(@types_to_fix_open_price)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Juntando dfs novamente</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_op_fix</span><span class="p">])</span>



        <span class="c1"># Precisamos consertar o open_price do FX. (Deve ser convertido pelo spot de fechamento sempre)</span>

        <span class="c1"># Podemos puxar o caixa aqui e concatenar para as proximas operacoes</span>
        <span class="k">if</span> <span class="n">include_cash</span><span class="p">:</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hist_cash_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="n">bdays</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                                <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
            <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">])</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Close_Mkt_Value &gt;= 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixed income&#39;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
                <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">cash</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Vamos segregar como dívida o caixa virado.</span>
        <span class="k">if</span> <span class="n">include_cash_debt</span><span class="p">:</span>
            <span class="n">cash_debt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hist_cash_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="n">bdays</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                                     <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
            <span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">])</span>
            <span class="n">cash_debt</span> <span class="o">=</span> <span class="n">cash_debt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Close_Mkt_Value &lt; 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;debt&#39;</span>

            <span class="c1"># Caixa virado no Brasil, vamos desconsiderar, pois na prática nao teremos.</span>
            <span class="c1">#cash_debt = cash_debt.query(&quot;Asset_ID != &#39;caixa_caixa&#39; or Location != &#39;bz&#39;&quot;).copy()</span>
            <span class="c1">#Optando por manter e retirar o PnL posteriormente, para nao perder a contribuicao dele pra aporte e resgate</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
                <span class="n">cash_debt</span> <span class="o">=</span> <span class="n">cash_debt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">cash_debt</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Vamos obter a data d-1</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Yesterday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                            <span class="p">)</span>
        <span class="c1"># Obtendo quantidade na abertura</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Obtendo valor de mercado por ativo na abertura</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span>
        <span class="c1"># Calculando precos de compas e vendas</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Buy_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> 
                            <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sell_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculando PnL Diário (Caixa nao pode ser calculado aqui, pois o preco eh sempre 1)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Buy_Price&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sell_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">])</span>
        <span class="c1"># Ajustando PnL sold. Quando for debt, a venda representa a divida sendo tomada</span>
        <span class="c1"># e a compra representa o pagamento da divida. Na primeira, ha juros e na segunda nao ha pnl.</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Bought&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Luxor_Classification&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Bought&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Sold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Luxor_Classification&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debt&#39;</span><span class="p">,</span> 
                                  <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open_Price&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close_Price&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Shares_Sold&#39;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">])</span>

        <span class="c1"># O caixa no BZ pode estar virado temporariamente durante aportes/resgates de caixa_us, mas isso n estará gerando PnL</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;caixa_caixa&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;caixa_caixa&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">])</span>



        <span class="c1"># Ajustar aqui as operacoes com logica de pnl e exposicao</span>
        <span class="c1"># Para nao considerar no AUM e no Cash Flow</span>
        <span class="n">types_to_recalculate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndf usdbrl&#39;</span><span class="p">]</span>
        <span class="c1"># Separando os dados em dois grupos, para editar um deles</span>
        <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@types_to_recalculate)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Type.isin(@types_to_recalculate)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Calculo especifico para pnl do FX.</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> \
                                     <span class="o">+</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span>

        <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])</span>
        <span class="c1"># Valor de mercado sera o PnL acumulado</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Retirando qualquer possibilidade de impacto para aporte e resgate</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># TODO Pensar o que vai mudar no caso de uma zeragem parcial</span>
        <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">)</span>


        <span class="c1"># Juntando dfs novamente</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_exposure</span><span class="p">])</span>

        <span class="c1"># Calculando net de aporte e resgate por ativo</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">])</span>

        <span class="n">hist_dividends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                            <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">hist_dividends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">]],</span>
                            <span class="n">hist_dividends</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">]]</span>
        <span class="n">hist_dividends</span> <span class="o">=</span> <span class="n">hist_dividends</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">:</span><span class="s2">&quot;Dividends&quot;</span><span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hist_dividends</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Open_Quantity&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Buy_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell_Price&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Cash_Flow&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]]</span>


        <span class="c1"># Calculando AUM no fechamento</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_AUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">annual_adm_fee</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Incluir taxas de adm e gestao no calculo do PnL</span>
        <span class="c1"># Elas ja impactam o caixa, mas precisam ser consideradas no PnL</span>
            <span class="n">daily_adm_fee</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_adm_fee</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">365</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_AUM&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
            <span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Close_AUM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">daily_adm_fee</span>
            <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;taxas e custos_tx adm&quot;</span>

            <span class="n">value_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Sobrescreve com 0, menos para Pnl_Unchanged e Close_AUM</span>

            <span class="n">df_fees</span><span class="p">[</span><span class="n">value_columns</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Para taxas, todos os outros valores nao importam.</span>
            <span class="c1"># Finalmente, falta colocar dados de name, type e group</span>
            <span class="n">all_assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">})</span>

            <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
                <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_fees</span><span class="p">])</span>  


        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>

        <span class="c1"># Calculando PL Inicial Ajustado</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Sera o valor de mercado da abertura somado com o net de aportes.</span>
        <span class="c1"># Racional: Resgates rentabilizam no dia (ja estao no inicial)</span>
        <span class="c1">#           Aportes rentabilizam no dia (nao estano no inicial)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM_Adjusted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM&quot;</span><span class="p">]</span> <span class="o">+</span> 
                                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                                    <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Pnl&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM_Adjusted&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


        <span class="c1"># ao retornar, filtrar port Daily_Pnl != 0 e  not Daily_Pnl.isna()</span>
        <span class="k">if</span> <span class="n">ignore_small_pnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39; (Daily_Pnl &lt;= -0.01 or Daily_Pnl &gt;= 0.01)</span><span class="se">\</span>
<span class="s1">                                            and not Daily_Pnl.isna()&#39;&#39;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>

        <span class="c1">#return df.reset_index().sort_values(by=&quot;Today&quot;)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_dividends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> 
                      <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_dividends&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_name and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">df_usd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Currency == &#39;usd&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_brl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Currency == &#39;brl&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;usd&#39;</span><span class="p">:</span>
            <span class="n">df_brl_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">(</span><span class="n">df_brl</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Amount&quot;</span><span class="p">:</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">}),</span>
                                  <span class="n">price_currency</span><span class="o">=</span><span class="s2">&quot;brl&quot;</span><span class="p">,</span>
                                  <span class="n">dest_currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span>
                                  <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Last_Price&#39;</span> <span class="p">:</span> <span class="s1">&#39;Amount&#39;</span><span class="p">})</span>
            <span class="n">df_brl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_brl_mod</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_brl_mod</span><span class="p">[</span><span class="s1">&#39;Amount&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;brl&#39;</span><span class="p">:</span>
            <span class="n">df_usd_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">(</span><span class="n">df_usd</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Amount&quot;</span><span class="p">:</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">}),</span>
                                  <span class="n">price_currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
                                  <span class="n">dest_currency</span><span class="o">=</span><span class="s2">&quot;brl&quot;</span>
                                  <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Last_Price&#39;</span><span class="p">:</span><span class="s1">&#39;Amount&#39;</span><span class="p">})</span>
            <span class="n">df_usd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_usd_mod</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_usd_mod</span><span class="p">[</span><span class="s1">&#39;Amount&#39;</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_brl</span><span class="p">,</span> <span class="n">df_usd</span><span class="p">])[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;Amount&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s1">&#39;lipizzaner&#39;</span><span class="p">:</span>
            <span class="n">df_fund_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">(</span><span class="s1">&#39;fund a&#39;</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">holiday_location</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_fund_a</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">get_position_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Fornece um dataframe com a variacao das posicoes do fundo entre as datas. </span>
<span class="sd">            Inclui tambem uma coluna de flag informando se a posicao foi zerada ou nao</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Pegamos as posicoes da data mais recente, transformando de dict para dataframe</span>
        <span class="n">cur_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
        <span class="n">cur_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur_positions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;#_cur&quot;</span><span class="p">])</span>

        <span class="c1"># Igual para as posicoes da data mais antiga</span>
        <span class="n">prev_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">)</span>
        <span class="n">prev_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prev_positions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;#_prev&quot;</span><span class="p">])</span>

        <span class="c1"># Realizamos juncao externa na chave, mantendo assim dados nan (zeragens e ativos novos)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cur_positions</span><span class="p">,</span> <span class="n">prev_positions</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;Variation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_cur&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_prev&quot;</span><span class="p">]</span>
        <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;Closed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_cur&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">diff</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Variation&quot;</span><span class="p">,</span> <span class="s2">&quot;Closed&quot;</span><span class="p">]]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_risk_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span>  <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Retorna as metricas de risco numa determinada data.</span>

<span class="sd">        Args:</span>
<span class="sd">            fund_name (str): nome do fundo correspontente</span>
<span class="sd">            metrics (str, list(str)): str da metrica desejada ou uma lista de strings</span>
<span class="sd">             para mais de uma metrica. Defaults to None (all available).</span>
<span class="sd">            date (datetime.date, optional): Data da metrica. Defaults to datetime.date.today().</span>

<span class="sd">        Returns:</span>

<span class="sd">            Pode retornar o valor de uma metrica especifica ou Dataframe quando </span>
<span class="sd">            metrics passado for uma lista de metricas.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fund_name</span> <span class="o">=</span> <span class="n">fund_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="n">hist_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_risk_metrics&quot;</span><span class="p">)</span>
        <span class="n">hist_metrics</span> <span class="o">=</span> <span class="n">hist_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">hist_metrics</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fund_name</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hist_metrics</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span> <span class="p">)]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_metrics</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Fund&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>

                <span class="k">return</span> <span class="n">hist_metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist_metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrica(s) </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2"> indisponivel(is)&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_risk_metric_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_risk_metric</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_risk_metric</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recent</span> <span class="o">-</span> <span class="n">previous</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_group_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">segments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;brl&quot;</span><span class="p">,</span> <span class="n">inception_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcula e retorna o resultado de cada segmento.</span>

<span class="sd">        Args:</span>
<span class="sd">            recent_date (dt.date): Data inicial NAO inclusiva (sera filtrado por uma data anterior a essa.)</span>
<span class="sd">                                    Ex. Para considerar retorno ate o mes de marco, deve ser passada alguma data em abril.</span>
<span class="sd">            previous_date (dt.date): Data final</span>
<span class="sd">            segments (_type_, optional): Lista ou string com nome dos segmentos </span>
<span class="sd">                desejados. Defaults to None. Quando None, retorna todos os segmentos existentes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Retorno por segmento.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">previous_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">previous_date</span> <span class="o">&gt;</span> <span class="n">recent_date</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data inicial é menor que a data final. Parametros invertidos?&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1"># Obtendo tabela de retornos historicos extraida do retorno consolidado</span>
        <span class="n">group_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;luxor group results&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Segment&quot;</span><span class="p">,</span> <span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

        <span class="c1"># Selecionando o periodo de tempo desejado</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">recent_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ytd&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># fechamento de dezembro! Vamos ter que ajustar o previous_date</span>
                    <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">35</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
                <span class="n">previous_date</span> <span class="o">+=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;= @previous_date and Date &lt; @recent_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">segments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Vamos deixar apenas os segmentos informados no parametro &#39;segments&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">segments</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">seg_filter</span> <span class="o">=</span> <span class="n">segments</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;segments&#39; precisa ser do tipo &#39;list&#39; ou &#39;str&#39;&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

            <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot; Segment.isin(@seg_filter)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Segment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Retornos dos segmentos, por padrao, estarao em R$.</span>
        <span class="c1"># Para ver em US$ precisa ser feita a conversao.</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">__get_usdbrl_variation</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span>
                <span class="c1"># ajustando janelas de inicio e fim, para pegar a variacao correta de usd no periodo -&gt;  A base do grupo eh de retornos, a de usd eh de preços                </span>
                <span class="n">usd_recent_date</span>  <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">usd_previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">previous_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Ainda, se a data for anterior ou igual ao inceptio date, vamos usar o incepion date</span>
                <span class="c1">#print(f&quot;conversao usdbrl usando: previous_date:{usd_previous_date}  recent_date: {usd_recent_date}&quot;)</span>
                <span class="k">if</span> <span class="n">inception_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">inception_dates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                    <span class="n">sgmnt_inception</span> <span class="o">=</span> <span class="n">inception_dates</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># subtraindo 1 dia para usar o fechamento do dia anterior ao inicio</span>
                    <span class="n">usd_previous_date</span> <span class="o">=</span> <span class="n">sgmnt_inception</span> <span class="k">if</span> <span class="p">((</span><span class="n">sgmnt_inception</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sgmnt_inception</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">month</span><span class="p">))</span> <span class="k">else</span> <span class="n">usd_previous_date</span>
                                            <span class="c1">#&quot;bmfxclco curncy&quot; -&gt; converter usando usd cupom limpo</span>

                <span class="n">delta_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">usd_previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">usd_recent_date</span><span class="p">)</span>
                <span class="c1">#print(f&quot;Segmento: {segment}  Retorno_BRL:{multiplier}  delta usdbrl={delta_usdbrl}   Retorno_USD: {(1+multiplier)/(1+delta_usdbrl)-1}&quot;)</span>
                <span class="k">return</span> <span class="n">delta_usdbrl</span>


            <span class="c1"># Convertendo para usd o que estiver em brl</span>

            <span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">__get_usdbrl_variation</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Segment&quot;</span><span class="p">]))</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Segment&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">group_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fund_particip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Informa o percentual que &#39;fund_name&#39; possui do &#39;fund_owned&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            fund_name (str) </span>
<span class="sd">            fund_owned (str)</span>
<span class="sd">            date (dt.date) </span>
<span class="sd">        Returns:</span>
<span class="sd">            (float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fund_name</span> <span class="o">=</span> <span class="n">fund_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">fund_owned_key</span> <span class="o">=</span> <span class="n">fund_owned</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fund_owned</span>

        <span class="c1"># antes da data de incorporacao do manga master pelo lipi, 100% do manga master era do manga fic</span>
        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># antes da data de incorporacao do manga master pelo lipi, 100% do fund_a era do manga master</span>
        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga master&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Adicionando mais um nivel de calculo </span>
        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga ii fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga fic fia&quot;</span><span class="p">,</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_positions&quot;</span><span class="p">)</span>

        <span class="c1"># Busca otimizada pela posicao</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[(</span>
                            <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_name</span><span class="p">)</span>
                            <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_owned_key</span><span class="p">)</span>
                            <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span>
                        <span class="p">)]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="c1"># nao havia participacao do fundo em questao na data informada</span>
            <span class="k">return</span> <span class="mi">0</span>


        <span class="n">fund_owned_total_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fund_owned_total_amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[(</span>
                                            <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_owned</span><span class="p">)</span>
                                            <span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span>
                                            <span class="p">)]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>

            <span class="c1"># Algo deu errado</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">position</span><span class="o">/</span><span class="n">fund_owned_total_amount</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Mantem 5 casas decimais de precisao</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_fund_aum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>

        <span class="n">hist_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_name&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">==</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_fund_numb_shares</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>

        <span class="n">hist_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">fund_name</span><span class="o">+</span><span class="s2">&quot;_quotas&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">==</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_delta_subscription_redemption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">):</span>

        <span class="n">hist_quotas</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund and Date&gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;#&quot;</span> <span class="p">:</span> <span class="s2">&quot;Quota_Amnt&quot;</span><span class="p">})[[</span><span class="s2">&quot;Quota_Amnt&quot;</span><span class="p">,</span> <span class="s2">&quot;Quota&quot;</span><span class="p">]]</span>
                           <span class="p">)</span>
        <span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Delta_Quotas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Quota_Amnt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Nao eh necessario usar a cota do dia anterior. Caso precise, basta fazer o shift abaixo</span>
        <span class="c1"># hist_quotas[&quot;Quota&quot;] = hist_quotas[&quot;Quota&quot;].shift(1).fillna(0)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Delta_Quotas&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">hist_quotas</span><span class="p">[</span><span class="s2">&quot;Quota&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">delta</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_month_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">cur_m</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">month</span> <span class="o">!=</span> <span class="n">cur_m</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_fund_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">):</span> <span class="c1">#, orig_curncy=None, dest_curncy=None):</span>

        <span class="c1"># Nao ha nenhuma conversao de moeda a ser feita</span>
        <span class="c1">#if orig_curncy is None or dest_curncy is None or orig_curncy == dest_curncy:</span>

        <span class="n">start_aum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fund_aum</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">date</span> <span class="o">=</span> <span class="n">previous_date</span><span class="p">)</span>
        <span class="n">end_aum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fund_aum</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">date</span> <span class="o">=</span> <span class="n">recent_date</span><span class="p">)</span>
        <span class="n">period_cash_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delta_subscription_redemption</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>

        <span class="c1">#if fund == &quot;fund a&quot;:</span>
        <span class="c1">#    print()</span>
        <span class="c1">#    print(f&quot;{fund}, prev:{previous_date} rec:{recent_date} pnl:{end_aum - start_aum - period_cash_flow} = {end_aum} - {start_aum} - {period_cash_flow}&quot;)</span>

        <span class="k">return</span> <span class="n">end_aum</span> <span class="o">-</span> <span class="n">start_aum</span> <span class="o">-</span> <span class="n">period_cash_flow</span>

        <span class="c1"># Desativando pois nao esta computando o resultado corretamente</span>
        <span class="c1"># Eh necessario converter de uma moeda para outra</span>
        <span class="c1">#location = self.get_table(&quot;funds&quot;).query(&quot;Fund == @fund&quot;)[&quot;Location&quot;].squeeze()</span>
        <span class="c1">#end_date = recent_date</span>
        <span class="c1">#recent_date = previous_date</span>
        <span class="c1">#</span>
        <span class="c1">#total_pnl = 0</span>
<span class="c1">#</span>
        <span class="c1">#while recent_date &lt; end_date:</span>
<span class="c1">#</span>
        <span class="c1">#    recent_date = self.get_next_attr_date(fund, previous_date, location, mode=&quot;week&quot;)</span>
<span class="c1">#</span>
        <span class="c1">#    if recent_date &gt; end_date:</span>
        <span class="c1">#        recent_date = end_date</span>
<span class="c1">#</span>
        <span class="c1">#    # chamada recursiva, que roda apenas a primeira parte</span>
        <span class="c1">#    pnl = self.get_fund_pnl(fund, previous_date, recent_date)</span>
        <span class="c1">#    </span>
        <span class="c1">#    end_usdbrl = self.get_price(&quot;bmfxclco curncy&quot;, px_date=recent_date)</span>
        <span class="c1">#    </span>
        <span class="c1">#    if orig_curncy == &quot;brl&quot; and dest_curncy ==&quot;usd&quot;:</span>
        <span class="c1">#        total_pnl += pnl / end_usdbrl</span>
        <span class="c1">#    elif orig_curncy == &quot;usd&quot; and dest_curncy == &quot;brl&quot;:</span>
        <span class="c1">#        total_pnl += pnl * end_usdbrl</span>
        <span class="c1">#    </span>
        <span class="c1">#    previous_date = recent_date</span>
<span class="c1">#</span>
        <span class="c1">#return total_pnl</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_eduardo_lipi_particip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>

        <span class="n">funds_particip</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga fic fia&quot;</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span> 
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga ii fic fia&quot;</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span> 
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;maratona&quot;</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;fund c&quot;</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">))</span> 

        <span class="k">if</span> <span class="n">funds_particip</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ----&gt; Atenção! Calculo de participacao ficou errado para o eduardo. &lt;----&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">funds_particip</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_next_attr_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span> <span class="c1">#funds_info):</span>
        <span class="c1"># Funcao auxiliar do attribution, permite pegar a proxima data valida para contabilizacao do attribution</span>
        <span class="c1"># Levar em consideracao que lipizzaner, antes de incorporar o manga, tinha também cota diaria.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;day&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fund</span> <span class="o">==</span> <span class="s2">&quot;lipizzaner&quot;</span> <span class="ow">and</span> <span class="n">start_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;week&quot;</span><span class="p">:</span>
            <span class="n">thursday</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#weekday de quinta-feira (base da cota semanal)</span>
            <span class="n">start_date_weekday</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="c1"># Vamos setar a data como a proxima sexta e pegar o primeiro dia util anterior</span>
            <span class="n">friday_offset</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">start_date_weekday</span> <span class="o">==</span> <span class="n">thursday</span> <span class="k">else</span> <span class="o">-</span><span class="p">(</span><span class="n">start_date_weekday</span> <span class="o">-</span> <span class="n">thursday</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">friday_offset</span><span class="p">),</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>

            <span class="c1"># Caso com muitos feriados proximos. Vamos resolver pegando o proximo dia util, para facilitar.</span>
            <span class="k">if</span> <span class="n">next_date</span> <span class="o">&lt;=</span> <span class="n">start_date</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">next_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">):</span> <span class="n">next_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">next_date</span><span class="o">.</span><span class="n">month</span> <span class="o">!=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
                <span class="c1"># houve troca de mes. Se o ultimo dia do mes nao for start_date, vamos retornos o final do mes</span>
                <span class="n">month_ending</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">start_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">start_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">month_ending</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">month_ending</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month_ending</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># mas se start_date for o month_ending, entao esta correto retornar next_date.</span>
                <span class="k">if</span> <span class="n">month_ending</span> <span class="o">==</span> <span class="n">start_date</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">next_date</span> 
                <span class="k">return</span> <span class="n">month_ending</span>
            <span class="k">return</span> <span class="n">next_date</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;&#39;mode&#39; desconhecido.&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">fund_currency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Calcula o attribution do fundo informado para qualquer periodo.</span>

<span class="sd">        Args:</span>
<span class="sd">            fund (str): nome do fundo (lipizzaner, fund a, fund b, ...)</span>
<span class="sd">            previous_date (datetime.date): data inicial</span>
<span class="sd">            recent_date (datetime.date): data final</span>
<span class="sd">            fund_currency (str): &#39;brl&#39; ou &#39;usd</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Dataframe contendo o attribution (% e pnl) por ativo no periodo.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Acumulando os p&amp;l&#39;s do periodo</span>
        <span class="n">hist_attr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_attr_base&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund and Start_Date&gt;= @previous_date and End_Date &lt;= @recent_date&quot;</span><span class="p">)</span>
                         <span class="p">)</span>
        <span class="c1"># Corrigindo datas de inicio e fim, para datas validas considerando as janelas de attribution calculadas.</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">recent_date</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">hist_attr</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[[</span><span class="s2">&quot;p&amp;l_brl&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_brl_curncy&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_usd&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_usd_curncy&quot;</span><span class="p">,</span>  <span class="s2">&quot;attr_brl&quot;</span><span class="p">,</span>  <span class="s2">&quot;attr_brl_curncy&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_usd&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_usd_curncy&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">#hist_attr = hist_attr[[&quot;p&amp;l_brl&quot;,&quot;p&amp;l_brl_curncy&quot;,&quot;p&amp;l_usd&quot;,&quot;p&amp;l_usd_curncy&quot;]].groupby(&quot;Key&quot;).sum()</span>


        <span class="c1"># Vamos encontrar o total de p&amp;l do periodo e a rentabilidade no periodo, em reais e em dolares</span>
        <span class="n">end_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
        <span class="n">average_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == &#39;usdbrl curncy&#39; and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">usdbrl_variation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span>

        <span class="c1"># Calculando pnl e rentab totais (ainda nao sabemos em qual moeda esta)</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fund_pnl</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
        <span class="n">total_rentab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span>
        <span class="n">others_pnl</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_&quot;</span><span class="o">+</span><span class="n">fund_currency</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">others_pnl_curncy</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_&quot;</span><span class="o">+</span><span class="n">fund_currency</span><span class="o">+</span><span class="s2">&quot;_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Inicializando todas as possibilidades</span>
        <span class="n">total_pnl_brl</span><span class="p">,</span> <span class="n">total_pnl_usd</span><span class="p">,</span> <span class="n">total_rentab_brl</span><span class="p">,</span> <span class="n">total_rentab_usd</span> <span class="o">=</span> <span class="n">total_pnl</span><span class="p">,</span> <span class="n">total_pnl</span><span class="p">,</span> <span class="n">total_rentab</span><span class="p">,</span> <span class="n">total_rentab</span>
        <span class="n">others_pnl_brl</span><span class="p">,</span> <span class="n">others_pnl_usd</span> <span class="o">=</span> <span class="n">others_pnl</span><span class="p">,</span> <span class="n">others_pnl</span>
        <span class="n">others_pnl_brl_curncy</span><span class="p">,</span> <span class="n">others_pnl_usd_curncy</span> <span class="o">=</span> <span class="n">others_pnl_curncy</span><span class="p">,</span> <span class="n">others_pnl_curncy</span>

        <span class="c1"># Encontrando moeda e corrigindo valores.</span>
        <span class="k">if</span> <span class="n">fund_currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>
            <span class="n">others_pnl_brl</span> <span class="o">=</span> <span class="n">others_pnl_brl</span> <span class="o">*</span> <span class="n">end_usdbrl</span>
            <span class="n">others_pnl_brl_curncy</span> <span class="o">=</span> <span class="n">others_pnl_brl_curncy</span> <span class="o">*</span> <span class="n">end_usdbrl</span>
            <span class="n">total_pnl_brl</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_brl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">others_pnl_brl</span>
            <span class="n">total_rentab_brl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">total_rentab_usd</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">usdbrl_variation</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="c1"># Nesse caso:</span>
            <span class="c1"># O pnl total precisa ter o mesmo sinal da rentabilidade total, senao algo esta errado.</span>
            <span class="k">if</span> <span class="n">total_pnl_brl</span> <span class="o">*</span> <span class="n">total_rentab_brl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rentabilidade e pnl com sinais trocados. Conferir &#39;</span><span class="si">{</span><span class="n">fund</span><span class="si">}</span><span class="s2">&#39; de &#39;</span><span class="si">{</span><span class="n">previous_date</span><span class="si">}</span><span class="s2">&#39; ate &#39;</span><span class="si">{</span><span class="n">recent_date</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtendo pnl total a partir da rentabilidade e PL medio do periodo&quot;</span><span class="p">)</span>
                <span class="n">fund_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund ==@fund and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
                <span class="n">total_pnl_brl</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;Quota&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">average_usdbrl</span> <span class="o">*</span> <span class="n">total_rentab_brl</span>

        <span class="k">elif</span> <span class="n">fund_currency</span> <span class="o">==</span> <span class="s2">&quot;brl&quot;</span><span class="p">:</span>
            <span class="n">others_pnl_usd</span> <span class="o">=</span><span class="n">others_pnl_usd</span> <span class="o">/</span> <span class="n">end_usdbrl</span> 
            <span class="n">others_pnl_usd_curncy</span> <span class="o">=</span> <span class="n">others_pnl_usd_curncy</span> <span class="o">/</span> <span class="n">end_usdbrl</span>
            <span class="n">total_pnl_usd</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_usd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">others_pnl_usd</span>
            <span class="n">total_rentab_usd</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">total_rentab_brl</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">usdbrl_variation</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
            <span class="c1"># Nesse caso:</span>
            <span class="c1"># O pnl total precisa ter o mesmo sinal da rentabilidade total, senao algo esta errado.</span>
            <span class="k">if</span> <span class="n">total_pnl_usd</span> <span class="o">*</span> <span class="n">total_rentab_usd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rentabilidade e pnl com sinais trocados. Conferir &#39;</span><span class="si">{</span><span class="n">fund</span><span class="si">}</span><span class="s2">&#39; de &#39;</span><span class="si">{</span><span class="n">previous_date</span><span class="si">}</span><span class="s2">&#39; ate &#39;</span><span class="si">{</span><span class="n">recent_date</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtendo pnl total a partir da rentabilidade e PL medio do periodo&quot;</span><span class="p">)</span>
                <span class="n">fund_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund ==@fund and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
                <span class="n">total_pnl_usd</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;Quota&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">average_usdbrl</span> <span class="o">*</span> <span class="n">total_rentab_usd</span>

        <span class="n">others_attr_brl</span> <span class="o">=</span> <span class="n">total_rentab_brl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_brl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">others_attr_brl_curncy</span> <span class="o">=</span> <span class="n">total_rentab_brl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_brl_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">others_attr_usd</span> <span class="o">=</span> <span class="n">total_rentab_usd</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_usd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">others_attr_usd_curncy</span> <span class="o">=</span> <span class="n">total_rentab_usd</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_usd_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Vamos inserir o row &#39;outros&#39; com o que falta de pnl para atingir a rentabilidade do periodo</span>
        <span class="n">hist_attr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;outros_outros&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">others_pnl_brl</span><span class="p">,</span> <span class="n">others_pnl_brl_curncy</span><span class="p">,</span> <span class="n">others_pnl_usd</span><span class="p">,</span> <span class="n">others_pnl_usd_curncy</span><span class="p">,</span> <span class="n">others_attr_brl</span><span class="p">,</span> <span class="n">others_attr_brl_curncy</span><span class="p">,</span> <span class="n">others_attr_usd</span><span class="p">,</span> <span class="n">others_attr_usd_curncy</span><span class="p">]</span>

        <span class="c1">#hist_attr.loc[&quot;outros_outros&quot;] = [others_pnl_brl, others_pnl_brl_curncy, others_pnl_usd, others_pnl_usd_curncy]</span>


        <span class="c1"># Vamos calcular o % de atribuicao, proporcional a variacao da cota no periodo</span>
        <span class="c1"># Em reais</span>
        <span class="c1">#hist_attr[&quot;attr_brl&quot;] = hist_attr.apply(lambda row: ((row[&quot;p&amp;l_brl&quot;])/abs(row[&quot;p&amp;l_brl&quot;])) * abs(row[&quot;p&amp;l_brl&quot;] * total_rentab_brl/total_pnl_brl), axis=1)</span>
        <span class="c1">#hist_attr[&quot;attr_brl_curncy&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_brl_curncy&quot;] * total_rentab_brl/total_pnl_brl, axis=1)</span>
        <span class="c1"># Em dolares</span>
        <span class="c1">#hist_attr[&quot;attr_usd&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_usd&quot;] * total_rentab_usd/total_pnl_usd, axis=1)</span>
        <span class="c1">#hist_attr[&quot;attr_usd_curncy&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_usd_curncy&quot;] * total_rentab_usd/total_pnl_usd, axis=1)</span>


        <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>
        <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent_date</span>

        <span class="k">return</span> <span class="n">hist_attr</span>        


    <span class="k">def</span><span class="w"> </span><span class="nf">get_coinvestors_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>

        <span class="c1"># Obtendo dados de cotistas na data informada ou data anterior mais proxima</span>
        <span class="n">hist_pos_cotistas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_pos_cotistas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @date&quot;</span><span class="p">)</span>    

        <span class="n">most_recent_date</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">hist_pos_cotistas</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @most_recent_date and Quantidade &gt; 0&quot;</span><span class="p">)</span>

        <span class="n">ID_MANGA_I</span> <span class="o">=</span> <span class="mi">37</span>
        <span class="n">ID_MANGA_II</span> <span class="o">=</span> <span class="mi">507161</span>

        <span class="c1"># Definindo IDs dos membros da familia</span>
        <span class="n">family_members_ids</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">100000009</span> <span class="p">:</span> <span class="s2">&quot;Thomas Ribas&quot;</span><span class="p">,</span>
        <span class="mi">100000007</span> <span class="p">:</span> <span class="s2">&quot;Marcelo Ribas Grabowsky&quot;</span><span class="p">,</span>
        <span class="mi">100000008</span> <span class="p">:</span> <span class="s2">&quot;Arthur Ribas Ferrer&quot;</span><span class="p">,</span>
        <span class="mi">100000006</span> <span class="p">:</span> <span class="s2">&quot;Eduardo Ribas Grabowsky&quot;</span><span class="p">,</span>
        <span class="mi">100000010</span> <span class="p">:</span> <span class="s2">&quot;Victoria Ribas Ferrer&quot;</span><span class="p">,</span>
        <span class="mi">100000003</span> <span class="p">:</span> <span class="s2">&quot;Carla Maria Flores Ribas&quot;</span><span class="p">,</span>
        <span class="mi">100000004</span> <span class="p">:</span> <span class="s2">&quot;Cristina Maria Flores Ribas&quot;</span><span class="p">,</span>
        <span class="mi">100000005</span> <span class="p">:</span> <span class="s2">&quot;Claudia Maria Fllores Ribas&quot;</span><span class="p">,</span>

        <span class="p">}</span>

        <span class="n">luxor_companies_ids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">100000021</span> <span class="p">:</span> <span class="s2">&quot;Jobi Holdings&quot;</span><span class="p">,</span>
        <span class="mi">100000050</span> <span class="p">:</span> <span class="s2">&quot;Luxor Investimentos&quot;</span><span class="p">,</span>
        <span class="mi">100000012</span> <span class="p">:</span> <span class="s2">&quot;Luxor Holding LLC&quot;</span><span class="p">,</span>
        <span class="mi">100000022</span> <span class="p">:</span> <span class="s2">&quot;Luxor Holdings&quot;</span><span class="p">,</span>
        <span class="mi">100000011</span> <span class="p">:</span> <span class="s2">&quot;Luxor Participação S/A&quot;</span><span class="p">,</span>
        <span class="mi">1000000000</span> <span class="p">:</span> <span class="s2">&quot;Cerros&quot;</span><span class="p">,</span>
        <span class="mi">1000000029</span> <span class="p">:</span> <span class="s2">&quot;RB1&quot;</span><span class="p">,</span>
        <span class="mi">100000120</span> <span class="p">:</span> <span class="s2">&quot;Nepal Trust&quot;</span><span class="p">,</span> <span class="c1"># Nao vamos contabilizar Nepal Trust, esta contabilizado para a claudia. </span>
                                   <span class="c1"># No futuro, entrarao 2 novos ids no family members</span>
        <span class="p">}</span>

        <span class="c1"># Definindo IDs dos funcionarios da Luxor</span>
        <span class="n">luxor_team_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">100000083</span> <span class="p">:</span> <span class="s2">&quot;Thiago Estrella&quot;</span><span class="p">,</span>
            <span class="mi">100000094</span> <span class="p">:</span> <span class="s2">&quot;Daniel Baeta&quot;</span><span class="p">,</span>
            <span class="mi">100000101</span> <span class="p">:</span> <span class="s2">&quot;Bruna Lourenço&quot;</span><span class="p">,</span>
            <span class="mi">100000084</span> <span class="p">:</span> <span class="s2">&quot;Ivan Azevedo&quot;</span><span class="p">,</span>
            <span class="mi">100000091</span> <span class="p">:</span> <span class="s2">&quot;Carolina Schnarndorf&quot;</span><span class="p">,</span>
            <span class="mi">100000096</span> <span class="p">:</span> <span class="s2">&quot;Ana Luiza Tramontin&quot;</span><span class="p">,</span>
            <span class="mi">100000090</span> <span class="p">:</span> <span class="s2">&quot;Antonio Azevedo&quot;</span><span class="p">,</span>
            <span class="mi">100000089</span> <span class="p">:</span> <span class="s2">&quot;Maurício Mesquita&quot;</span><span class="p">,</span> 
            <span class="mi">100000087</span> <span class="p">:</span> <span class="s2">&quot;Aline Pezzi&quot;</span><span class="p">,</span>
            <span class="mi">10000050</span>  <span class="p">:</span> <span class="s2">&quot;Thawana Arbues&quot;</span><span class="p">,</span>
            <span class="mi">10000043</span>  <span class="p">:</span> <span class="s2">&quot;Sergio Barbosa&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Separando cada grupo num dataframe</span>
        <span class="n">family_members</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Cotista.isin(@family_members_ids.keys())&quot;</span><span class="p">)</span>

        <span class="n">companies</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Cotista.isin(@luxor_companies_ids.keys())&quot;</span><span class="p">)</span>
        <span class="n">luxor_team</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Cotista.isin(@luxor_team_ids.keys())&quot;</span><span class="p">)</span>

        <span class="c1"># Encontrando o nmr de ids em cada grupo</span>
        <span class="n">numb_of_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist_pos_cotistas</span><span class="p">[</span><span class="s2">&quot;Id_Cotista&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">numb_of_family_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">family_members</span><span class="p">[</span><span class="s2">&quot;Id_Cotista&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">numb_of_companies_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span>
        <span class="n">numb_of_team_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">luxor_team</span><span class="p">)</span>
        <span class="n">numb_of_coinvestors_ids</span> <span class="o">=</span> <span class="n">numb_of_ids</span> <span class="o">-</span> <span class="n">numb_of_family_ids</span> <span class="o">-</span> <span class="n">numb_of_companies_ids</span> <span class="o">-</span> <span class="n">numb_of_team_ids</span>

        <span class="c1"># Encontrando totais investidos de cada grupo.</span>
        <span class="c1"># Luxor Team -&gt; Todos investem pelo Manga I</span>
        <span class="c1"># Luxor Family -&gt; Investem pelo Manga I e Manga II. Nepal Trust tambem entra aqui, porem nao eh contabilizado como um cotista a mais (considera-se cotista como sendo a claudia)</span>

        <span class="c1"># Obtendo a cota do fundo nessa data</span>
        <span class="c1">#fund_quota = self.get_price(&quot;mangalarga fic fia&quot;, px_date=date) #TODO -- Verificar se o manga ii fic altera o resultado aqui.</span>
        <span class="n">manga_i_quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;mangalarga fic fia&quot;</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        <span class="n">manga_ii_quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;mangalarga ii fic fia&quot;</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span> 

        <span class="c1"># Obtendo a posicao total de cada parte na data informada</span>

        <span class="n">total_nepal_trust_manga_i</span> <span class="o">=</span> <span class="n">companies</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_I and Id_Cotista == 100000120&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_i_quota</span>
        <span class="n">total_family_members_manga_i</span>  <span class="o">=</span> <span class="n">family_members</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_I&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_i_quota</span> <span class="o">+</span> <span class="n">total_nepal_trust_manga_i</span>
        <span class="n">total_companies_manga_i</span> <span class="o">=</span> <span class="n">companies</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_I&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_i_quota</span> <span class="o">-</span> <span class="n">total_nepal_trust_manga_i</span>

        <span class="n">total_nepal_trust_manga_ii</span> <span class="o">=</span> <span class="n">companies</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_II and Id_Cotista == 100000120&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_ii_quota</span>
        <span class="n">total_family_members_manga_ii</span> <span class="o">=</span> <span class="n">family_members</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_II&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_ii_quota</span> <span class="o">+</span> <span class="n">total_nepal_trust_manga_ii</span>
        <span class="n">total_companies_manga_ii</span> <span class="o">=</span> <span class="n">companies</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_II&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_ii_quota</span> <span class="o">-</span> <span class="n">total_nepal_trust_manga_ii</span>

        <span class="n">total_nepal_trust</span> <span class="o">=</span> <span class="n">total_nepal_trust_manga_i</span> <span class="o">+</span> <span class="n">total_nepal_trust_manga_ii</span>
        <span class="n">total_family_members</span> <span class="o">=</span> <span class="n">total_family_members_manga_i</span> <span class="o">+</span> <span class="n">total_family_members_manga_ii</span>
        <span class="n">total_companies</span> <span class="o">=</span> <span class="n">total_companies_manga_i</span> <span class="o">+</span> <span class="n">total_companies_manga_ii</span>

        <span class="n">total_luxor_team</span> <span class="o">=</span> <span class="n">luxor_team</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_I&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_i_quota</span>

        <span class="n">total_coinvestors</span> <span class="o">=</span> <span class="n">hist_pos_cotistas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id_Carteira == @ID_MANGA_I&quot;</span><span class="p">)[</span><span class="s2">&quot;Quantidade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">manga_i_quota</span> <span class="o">-</span> <span class="n">total_family_members_manga_i</span> <span class="o">-</span> <span class="n">total_luxor_team</span> <span class="o">-</span> <span class="n">total_companies_manga_i</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;family manga i: </span><span class="si">{</span><span class="n">total_family_members_manga_i</span><span class="si">}</span><span class="s2">, family manga ii: </span><span class="si">{</span><span class="n">total_family_members_manga_ii</span><span class="si">}</span><span class="s2">, companies ii: </span><span class="si">{</span><span class="n">total_companies_manga_ii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Se Nepal Trust estiver sendo considerado como luxor company, precisamos subtrair do total de membros antes de retornar (ja contabilizado no luxor family)</span>
        <span class="k">if</span> <span class="s2">&quot;Nepal Trust&quot;</span> <span class="ow">in</span> <span class="n">luxor_companies_ids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">numb_of_companies_ids</span> <span class="o">=</span> <span class="n">numb_of_companies_ids</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">numb_of_family_ids</span><span class="p">,</span> <span class="n">total_family_members</span><span class="p">]</span> <span class="p">,</span> 
                <span class="s2">&quot;luxor_team&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">numb_of_team_ids</span><span class="p">,</span> <span class="n">total_luxor_team</span><span class="p">],</span>
                <span class="s2">&quot;luxor_companies&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">numb_of_companies_ids</span><span class="p">,</span> <span class="n">total_companies</span><span class="p">],</span>
                <span class="s2">&quot;coinvestors&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">numb_of_coinvestors_ids</span><span class="p">,</span> <span class="n">total_coinvestors</span><span class="p">]}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcula o drawdown para um ativo ou um conjunto de ativos em cada data do perido fornecido.</span>

<span class="sd">        Args:</span>
<span class="sd">            tickers (str|list|set): ticker ou lista de tickers</span>
<span class="sd">            previous_date (dt.date): _description_</span>
<span class="sd">            recent_date (dt.date):</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Seguinte DataFrame usando Date como index -&gt; [[Asset, Period_Change, Previous_Peak, Drawdowns]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Period_Change&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Period_Change&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Drawdowns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tracking_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Calcula o tracking error de uma serie de retorno com relacao ao benchmark.</span>

<span class="sd">        Args:</span>
<span class="sd">            returns_ticker (str): ticker da serie de retorno que sera testada</span>
<span class="sd">            benchmark_ticker (str): ticker da serie de retorno que sera usada para comparacao</span>
<span class="sd">            previous_date (dt.date): data de inicio do teste</span>
<span class="sd">            recent_date (dt.date): data de fim do teste</span>
<span class="sd">        Returns:</span>
<span class="sd">            _type_: _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>


        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">([</span><span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">)</span>

        <span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">returns</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">]</span>

        <span class="n">n_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">returns</span><span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">returns_ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">returns</span><span class="p">[</span><span class="n">benchmark_ticker</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">tracking_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tracking_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n_periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">tracking_error</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">xirr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cashflows</span><span class="p">,</span> <span class="n">dates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calcula o XIRR para uma serie de cash flows em datas especificas.</span>

<span class="sd">            :cashflows (numpy.array of float): cash flows (positive para entrada, negativo para saida)</span>
<span class="sd">            :dates (numpy.array of datetime64): datas correspondentes aos cash flows</span>
<span class="sd">            :return: XIRR</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Garantindo que dates eh um numpy array de datetime64</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dates</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Reference date</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">date</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[D]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">xnpv</span><span class="p">(</span><span class="n">rate</span><span class="p">):</span>
            <span class="c1"># Limiting the rate to avoid overflow and division by zero</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.9999</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">yr</span> <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cashflows</span><span class="p">,</span> <span class="n">years</span><span class="p">)])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">xnpv_prime</span><span class="p">(</span><span class="n">rate</span><span class="p">):</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.9999</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="o">-</span><span class="n">yr</span> <span class="o">*</span> <span class="n">cf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">yr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cashflows</span><span class="p">,</span> <span class="n">years</span><span class="p">)])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Using a conservative initial guess</span>
            <span class="n">initial_guess</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">return</span> <span class="n">newton</span><span class="p">(</span><span class="n">xnpv</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">fprime</span><span class="o">=</span><span class="n">xnpv_prime</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
            <span class="c1"># Return NaN if the calculation fails</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_price_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets_data</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">sample_frequency</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;12m&quot;</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the correlation between assets in the columns of &#39;asset_prices&#39;. The correlation is calculated using the formula:</span>
<span class="sd">        corr = (1 + r1*r2 + r1*r2*corr) / sqrt(1+r1**2) * sqrt(1+r2**2)</span>
<span class="sd">        where r1 and r2 are the returns of the assets and corr is the correlation between the returns.</span>
<span class="sd">        The correlation is calculated using the formula above and the returns are calculated using the formula:</span>
<span class="sd">        r = (price[t] - price[t-1]) / price[t-1]</span>
<span class="sd">        where t is the time period.</span>
<span class="sd">        The returns are calculated using the sample frequency and the lookback in months.</span>
<span class="sd">        assets_data: dict mapeando ticker para {Name:str, Key:str e Location:str(bz ou us)}</span>
<span class="sd">        sample_frequency: str, default &quot;monthly&quot;. Frequencia de amostragem dos precos. Pode ser &quot;daily&quot;, &quot;weekly&quot; ou &quot;monthly&quot;</span>
<span class="sd">        period: str, default &#39;12m&#39;. Periodo de calculo da correlacao. Deve ser &#39;ytd&#39; ou o numero de meses seguido por &#39;m&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_frequency</span> <span class="o">=</span> <span class="n">sample_frequency</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">asset_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">assets_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">},</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span>
                                        <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">)</span>
        <span class="n">usdbrl_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">},</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">usdbrl_prices</span><span class="p">])</span>

        <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>


        <span class="n">frequencies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;daily&quot;</span><span class="p">:</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly&quot;</span><span class="p">:</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly&quot;</span><span class="p">:</span><span class="s2">&quot;ME&quot;</span><span class="p">}</span>
        <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="n">sample_frequency</span><span class="p">])</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="c1">#returns = asset_prices.pct_change(lookback_in_months)</span>
        <span class="c1">#returns = returns.dropna()</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="n">correlations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Asset_Corr&quot;</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">value_vars</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset_Corr&quot;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">value_vars</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;Correlation&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Correlation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset_Corr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Asset_Corr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">assets_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
        <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">assets_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
        <span class="n">correlations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Order&quot;</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Comp_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset_Corr&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset&quot;</span><span class="p">]</span>
        <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_frequency</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ly&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">period</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ytd&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;y&quot;</span>
        <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">correlations</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">min_rolling_period_months</span><span class="p">,</span> <span class="n">analysis_period_days</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">sample_frequency</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">):</span>

        <span class="n">period</span> <span class="o">=</span> <span class="n">min_rolling_period_months</span> <span class="o">+</span> <span class="n">analysis_period_days</span><span class="o">//</span><span class="mi">60</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

        <span class="n">year_size</span> <span class="o">=</span> <span class="mi">260</span>

        <span class="k">if</span> <span class="n">sample_frequency</span> <span class="o">==</span> <span class="s2">&quot;monthly&quot;</span><span class="p">:</span>
            <span class="n">analysis_period_days</span> <span class="o">=</span> <span class="n">analysis_period_days</span><span class="o">//</span><span class="mi">30</span> <span class="c1"># numero de meses para rolling</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
            <span class="n">year_size</span> <span class="o">=</span> <span class="mi">12</span>

        <span class="k">elif</span> <span class="n">sample_frequency</span> <span class="o">==</span> <span class="s1">&#39;weekly&#39;</span><span class="p">:</span>
            <span class="n">analysis_period_days</span> <span class="o">=</span> <span class="n">analysis_period_days</span><span class="o">//</span><span class="mi">7</span> <span class="c1"># numero de semanas para rolling</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
            <span class="n">year_size</span> <span class="o">=</span> <span class="mi">52</span>

        <span class="k">elif</span> <span class="n">sample_frequency</span> <span class="o">==</span> <span class="s2">&quot;daily&quot;</span><span class="p">:</span>
            <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Yesterday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Equals_To_Yesterday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Yesterday&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Equals_To_Yesterday&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>


        <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Previous_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Return&quot;</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Previous_Price&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Return&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">analysis_period_days</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">year_size</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>

        <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Return&quot;</span><span class="p">:</span><span class="s2">&quot;Volatility&quot;</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">prices</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_asset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>

        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Ticker == @ticker&quot;</span><span class="p">)[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">name</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">list_blob_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">ends_with</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lista todos os arquivos dentro de um diretorio no blob storage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">connect_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AZURE_STORAGE_CONNECTION_STRING&#39;</span><span class="p">)</span>
        <span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">connect_str</span><span class="p">)</span>

        <span class="c1"># Vamos listar os arquivos do diretorio</span>
        <span class="n">blob_files</span> <span class="o">=</span> <span class="n">blob_service_client</span>\
                    <span class="o">.</span><span class="n">get_container_client</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">list_blobs</span><span class="p">(</span><span class="n">name_starts_with</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ends_with</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">blob_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blob_file</span> <span class="ow">in</span> <span class="n">blob_files</span> <span class="k">if</span> <span class="n">blob_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ends_with</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">blob_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blob_file</span> <span class="ow">in</span> <span class="n">blob_files</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_portfolio_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">portfolio_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">adm_fee</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">performance_fee</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Simula o desempenho de um portfólio com base em um dicionário de ativos e suas alocações iniciais.</span>

<span class="sd">            Parâmetros:</span>
<span class="sd">            - portfolio: dicionário com os ativos e suas alocações iniciais. Dicionário deve seguir o formato:\n</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;ticker1&quot;: peso1,</span>
<span class="sd">                    &quot;ticker2&quot;: peso2,</span>
<span class="sd">                    ...</span>
<span class="sd">                    &quot;tickerN&quot;: pesoN</span>
<span class="sd">                }, onde os pesos devem somar 1.</span>
<span class="sd">            - portfolio_date: data inicial do portfólio.</span>
<span class="sd">            - adm_fee: taxa de administração %.a.a</span>
<span class="sd">            - performance_fee: taxa de performance (opcional).</span>

<span class="sd">            Retorna:</span>
<span class="sd">            - DataFrame com o fator de correção da cota para cada dia a partir da data inicial do portfolio.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Formatar os tickers para minusculas</span>
            <span class="n">portfolio</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">initial_portfolio</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">portfolio_date</span><span class="p">,</span>
                <span class="s2">&quot;assets&quot;</span> <span class="p">:</span> <span class="n">portfolio</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Criando dataframe com as colunas  Date|Ticker|Weight|</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">initial_portfolio</span><span class="p">[</span><span class="s2">&quot;assets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Weight&quot;</span><span class="p">])</span>
            <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_portfolio</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
            <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">tickers</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">max_date</span> <span class="o">=</span> <span class="n">portfolio_date</span>

            <span class="k">while</span> <span class="n">max_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
                <span class="c1"># Adicionando 1 dia</span>
                <span class="n">new_date</span> <span class="o">=</span> <span class="n">max_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">daily_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_changes</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">max_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">new_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">)</span>

                <span class="n">daily_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Ticker&quot;</span>

                <span class="n">new_day</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @max_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span>
                <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_returns</span>
                <span class="n">new_day</span> <span class="o">=</span> <span class="n">new_day</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="c1"># Ajusta pesos considerando a atribuicao de retorno do dia anterior</span>
                <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span>
                <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">new_date</span>

                <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span>
                <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">positions</span><span class="p">,</span> <span class="n">new_day</span><span class="p">])</span>
                <span class="n">max_date</span> <span class="o">=</span> <span class="n">new_date</span>

            <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
            <span class="c1">#positions.to_excel(&quot;positions_tci.xlsx&quot;)</span>
            <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

            <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
            <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
                                                            <span class="p">((</span><span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">performance_fee</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">adm_fee</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span>
                                                            <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">adm_fee</span><span class="o">/</span><span class="mi">12</span>
                                                            <span class="p">)</span>

            <span class="k">return</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">:</span> <span class="s2">&quot;Factor&quot;</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.__get_positions_and_movements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__get_positions_and_movements</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.__get_positions_and_movements" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fund_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tickers</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span> | <span title="set">set</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defaults to dt.date.today().</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em>. Defaults to dt.date.today()-dt.timedelta(days=1).</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>() - <span title="datetime.timedelta">timedelta</span>(days=1)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>mtd|ytd|3m|6m|...|nm. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>holiday_location</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any|bz|us|all. Defaults to "all".</p>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame:</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__get_positions_and_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        fund_name (str): </span>
<span class="sd">        tickers (str|list|set, optional): Defaults to None.</span>
<span class="sd">        recent_date (datetime.date, optional): Defaults to dt.date.today().</span>
<span class="sd">        previous_date (datetime.date, optional): _description_. Defaults to dt.date.today()-dt.timedelta(days=1).</span>
<span class="sd">        period (str, optional): mtd|ytd|3m|6m|...|nm. Defaults to None.</span>
<span class="sd">        holiday_location (str, optional): any|bz|us|all. Defaults to &quot;all&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;brl&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Garantindo que a data inicial sera sempre dia util, assim eh certo de que havera preco de acao nessa data</span>
    <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
    <span class="n">lipi_manga_incorp_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipi_manga_incorp_date</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>


    <span class="c1"># Filtrando somente os trades desejados</span>
    <span class="c1"># lembrando que lipi precisa abrir em fund_A e manga_master (quando antes da incorporacao)</span>
    <span class="c1"># ha ainda um ajuste no lipi, que na data da incorporacao compra as posicoes do Manga (nao podemos tirar essas boletas) </span>
    <span class="n">trades</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;trades&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Fund&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="s2">&quot;Op Type&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;#&quot;</span><span class="p">:</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Total&quot;</span> <span class="p">:</span> <span class="s2">&quot;Trade_Amount&quot;</span><span class="p">,</span> <span class="s2">&quot;Op Type&quot;</span><span class="p">:</span><span class="s2">&quot;Op_Type&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(Date &gt; @previous_date and Date &lt;= @recent_date) and Op_Type.isin([&#39;a vista&#39;, &#39;ndf&#39;, &#39;termo&#39;, &#39;apl/resg fundos&#39;, &#39;vc capital call&#39;, &#39;vc&#39;])&quot;</span><span class="p">))</span>

    <span class="n">fund_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">fund_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s1">&#39;lipizzaner&#39;</span><span class="p">:</span>
        <span class="n">fund_filter</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;fund a&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">lipi_manga_incorp_date</span><span class="p">:</span>
            <span class="n">fund_filter</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mangalarga master&quot;</span><span class="p">]</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund in @fund_filter&quot;</span><span class="p">)</span>

    <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund != &#39;lipizzaner&#39; or Date != @lipi_manga_incorp_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>


    <span class="c1"># Obtendo posicoes na data de inicio, e criando boletas de inicializacao</span>
    <span class="n">initial_positions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fund_filter</span><span class="p">:</span>
        <span class="n">fund_initial_pos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">fund_initial_pos</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">fund_initial_pos</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>

        <span class="n">initial_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fund_initial_pos</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">)</span>

        <span class="c1"># Adicionando coluna de tipo, pois sera necessario tratar quando type == ações_bdr</span>
        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>

        <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">initial_prices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                          <span class="n">recent_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">})[[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">]])</span>

        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">initial_prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">])</span>

        <span class="c1"># Corrigindo preço de entrada das BDRs</span>
        <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ações_bdr&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdr_adj_price</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">],</span> <span class="n">date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Exec_Price&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">initial_positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># tratando caso inicial, onde nao ha posicoes no inicio</span>

    <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">trades</span><span class="p">])[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Exec_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]]</span>

    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="c1"># Adicionando coluna pra marcar se eh compra ou venda. Sera usado na agregacao logo mais.</span>
    <span class="c1">#trades[&quot;Trade_Side&quot;] = np.where(trades[&quot;Delta_Shares&quot;] &lt; 0, &quot;sell&quot;, &quot;buy&quot;)</span>

    <span class="c1"># Ordenando boletas, por padrao vamos sempre comprar antes de vender.</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_trades</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span><span class="p">)</span>
    <span class="c1"># Apos normalizar os trades, eh necessario recalcular o preco da boleta</span>

    <span class="c1"># Agrupando boletas de forma a ter apenas uma boleta por dia por codigo de ativo</span>
    <span class="c1">#trades = trades.groupby([&quot;Date&quot;, &quot;Asset_ID&quot;]).agg({&quot;Delta_Shares&quot;:&quot;sum&quot;, &quot;Exec_Price&quot;:&quot;last&quot;, &quot;Trade_Amount&quot;:&quot;sum&quot;}).reset_index()</span>
    <span class="c1"># Precisamos calcular novamente o preco correto de execucao do trade</span>
    <span class="c1">#trades[&quot;Exec_Price&quot;] = abs(trades[&quot;Trade_Amount&quot;])/abs(trades[&quot;Delta_Shares&quot;])</span>

    <span class="c1"># Calculando posicao ao final de cada trade, preco medio e custo da posicao</span>
    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">])</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average_price</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="c1">#fillna(method=&quot;ffill&quot;)</span>

    <span class="c1"># Vamos agregar novamente, agora para tirar o &#39;Trade_Side&#39;, passando a ter uma linha apenas por data</span>
    <span class="c1">#trades = trades.groupby([&quot;Date&quot;, &quot;Asset_ID&quot;]).agg({&quot;Delta_Shares&quot;:&quot;sum&quot;, &quot;Exec_Price&quot;:&quot;last&quot;, &quot;Trade_Amount&quot;:&quot;sum&quot;,</span>
    <span class="c1">#                                                    &quot;Open_Quantity&quot;:&quot;last&quot;, &quot;Average_Price&quot; : &quot;last&quot;, &quot;Trade_Side&quot;:&quot;last&quot;}).reset_index()</span>
    <span class="c1"># Preco de execucao, necessita ser recalculado</span>
    <span class="c1">#trades[&quot;Exec_Price&quot;] = abs(trades[&quot;Trade_Amount&quot;])/abs(trades[&quot;Delta_Shares&quot;])</span>

    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">trades</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.__hist_prices_intraday_extensor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__hist_prices_intraday_extensor</span><span class="p">(</span><span class="n">hist_prices</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.__hist_prices_intraday_extensor" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Completa a tabela de precos historicos com o preco intraday mais recente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hist_prices</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe de precos historicos</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__hist_prices_intraday_extensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_prices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Completa a tabela de precos historicos com o preco intraday mais recente.</span>

<span class="sd">    Args:</span>
<span class="sd">        hist_prices (pd.DataFrame): dataframe de precos historicos</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Verificar cada Asset unico existente na tabela</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">updated_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># vamos fazer cada ativo por vez</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
        <span class="c1"># vamos pegar a tabela de precos do ativo</span>
        <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == @asset&quot;</span><span class="p">)</span>
        <span class="c1"># Vamos pegar a data mais recente</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_date</span> <span class="o">==</span> <span class="n">today</span><span class="p">:</span>
            <span class="n">last_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
            <span class="n">asset_prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">asset_prices</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_date</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_price</span>
            <span class="n">updated_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset_prices</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">continue</span>
        <span class="c1"># vamos pegar o ultimo preco presente no df</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @last_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="c1"># vamos pegar a variacao ate o momento mais recente</span>
        <span class="n">query_asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">:</span>
            <span class="n">query_asset</span> <span class="o">=</span> <span class="s1">&#39;usdbrl curncy&#39;</span>
        <span class="n">variation</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">today</span> <span class="o">&gt;</span> <span class="n">last_date</span><span class="p">:</span>
            <span class="n">variation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="n">query_asset</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">)</span>
        <span class="c1"># vamos ajustar o preco com a variacao</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">last_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">variation</span><span class="p">)</span>
        <span class="c1"># vamos colocar na base na data de hoje</span>
        <span class="n">updated_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">asset_prices</span><span class="p">,</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span><span class="p">:[</span><span class="n">today</span><span class="p">],</span>
                                  <span class="s2">&quot;Asset&quot;</span><span class="p">:[</span><span class="n">asset</span><span class="p">],</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:[</span><span class="n">last_price</span><span class="p">]})]))</span>

    <span class="n">updated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">updated_dfs</span><span class="p">)</span>
    <span class="n">updated_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">updated_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">updated_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">update_mode</span><span class="o">=</span><span class="s1">&#39;optimized&#39;</span><span class="p">,</span> <span class="n">is_develop_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tables_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.__init__" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">



<details class="update_mode" open>
  <summary>update_mode</summary>
  <p>'standard' - Carrega todas as tabelas disponiveis
'optimized' - Carrega apenas as tabelas utilizadas sob demanda</p>
</details>

            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_mode</span><span class="o">=</span><span class="s2">&quot;optimized&quot;</span><span class="p">,</span> <span class="n">is_develop_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tables_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="n">blob_directory</span><span class="o">=</span><span class="s1">&#39;enriched/parquet&#39;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update_mode: </span>
<span class="sd">            &#39;standard&#39; - Carrega todas as tabelas disponiveis</span>
<span class="sd">            &#39;optimized&#39; - Carrega apenas as tabelas utilizadas sob demanda</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">modified_tables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_develop_mode</span> <span class="o">=</span> <span class="n">is_develop_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blob_directory</span> <span class="o">=</span> <span class="n">blob_directory</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span> <span class="o">=</span> <span class="n">tables_path</span>
    <span class="k">if</span> <span class="n">tables_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_tables_path</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asset_last_prices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># otimizacao da consulta de preco</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">lipi_manga_incorp_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">update_modes_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;standard&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;optimized&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_modes_name</span><span class="p">[</span><span class="n">update_mode</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span> <span class="c1"># Nessa 1° exec. vai inicializar os dicionarios acima</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.__is_table_modified" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__is_table_modified</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.__is_table_modified" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Retorna 'True' ou 'False' informando se a tabela informada em 'table_name' foi criada ou modificada.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nome tabela</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True se foi criada ou modificada</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__is_table_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Retorna &#39;True&#39; ou &#39;False&#39; informando se a tabela informada em &#39;table_name&#39; foi criada ou modificada.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name (str): nome tabela</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True se foi criada ou modificada</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;table_path&quot;</span><span class="p">]</span>
        <span class="n">file_last_update</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">file_last_update</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;update_time&quot;</span><span class="p">]</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arquivo &lt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&gt; não encontrado.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_adjusted_avg_price" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_adjusted_avg_price</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby_column</span><span class="o">=</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_adjusted_avg_price" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Recebe um DataFrame contendo as colunas Date, Ticker, Delta_Shares e Trade_Amount.
    Trade_Amount sera resultado do preco_medio anterior (ja calculado na transacao) 
    multiplicado pela quantidade operada. ATENCAO pois na venda nao tem a informacao
    do valor pelo qual o ativo foi vendido.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame: Adiciona as colunas Cumulative_Shares, Open_Position_Cost e Average_Price</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_adjusted_avg_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">groupby_column</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recebe um DataFrame contendo as colunas Date, Ticker, Delta_Shares e Trade_Amount.</span>
<span class="sd">        Trade_Amount sera resultado do preco_medio anterior (ja calculado na transacao) </span>
<span class="sd">        multiplicado pela quantidade operada. ATENCAO pois na venda nao tem a informacao</span>
<span class="sd">        do valor pelo qual o ativo foi vendido.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame):</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: Adiciona as colunas Cumulative_Shares, Open_Position_Cost e Average_Price</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort the DataFrame by Ticker and Date for sequential processing</span>
    <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">groupby_column</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Side&quot;</span><span class="p">])</span> <span class="c1"># sort by trade_side (para processar sempre a compra primeiro)</span>
    <span class="n">df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Calculate cumulative shares and trade value for each ticker</span>
    <span class="n">df_sorted</span><span class="p">[</span><span class="s1">&#39;Cumulative_Shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_column</span><span class="p">)[</span><span class="s1">&#39;Delta_Shares&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="n">df_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average_price</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">)</span>
    <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade_Side&quot;</span><span class="p">])[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="c1">#fillna(method=&quot;ffill&quot;)</span>

    <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Cumulative_Shares&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_sorted</span><span class="p">[</span><span class="s2">&quot;Average_Price&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_sorted</span><span class="p">[</span><span class="n">df_columns</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;Cumulative_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Position_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Average_Price&quot;</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_attribution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_attribution</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">fund_currency</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_attribution" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o attribution do fundo informado para qualquer periodo.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fund</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nome do fundo (lipizzaner, fund a, fund b, ...)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data inicial</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data final</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fund_currency</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>'brl' ou 'usd</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame: Dataframe contendo o attribution (% e pnl) por ativo no periodo.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">fund_currency</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calcula o attribution do fundo informado para qualquer periodo.</span>

<span class="sd">    Args:</span>
<span class="sd">        fund (str): nome do fundo (lipizzaner, fund a, fund b, ...)</span>
<span class="sd">        previous_date (datetime.date): data inicial</span>
<span class="sd">        recent_date (datetime.date): data final</span>
<span class="sd">        fund_currency (str): &#39;brl&#39; ou &#39;usd</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: Dataframe contendo o attribution (% e pnl) por ativo no periodo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Acumulando os p&amp;l&#39;s do periodo</span>
    <span class="n">hist_attr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_attr_base&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund and Start_Date&gt;= @previous_date and End_Date &lt;= @recent_date&quot;</span><span class="p">)</span>
                     <span class="p">)</span>
    <span class="c1"># Corrigindo datas de inicio e fim, para datas validas considerando as janelas de attribution calculadas.</span>
    <span class="n">previous_date</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">recent_date</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">hist_attr</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[[</span><span class="s2">&quot;p&amp;l_brl&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_brl_curncy&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_usd&quot;</span><span class="p">,</span><span class="s2">&quot;p&amp;l_usd_curncy&quot;</span><span class="p">,</span>  <span class="s2">&quot;attr_brl&quot;</span><span class="p">,</span>  <span class="s2">&quot;attr_brl_curncy&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_usd&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_usd_curncy&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1">#hist_attr = hist_attr[[&quot;p&amp;l_brl&quot;,&quot;p&amp;l_brl_curncy&quot;,&quot;p&amp;l_usd&quot;,&quot;p&amp;l_usd_curncy&quot;]].groupby(&quot;Key&quot;).sum()</span>


    <span class="c1"># Vamos encontrar o total de p&amp;l do periodo e a rentabilidade no periodo, em reais e em dolares</span>
    <span class="n">end_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
    <span class="n">average_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == &#39;usdbrl curncy&#39; and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">usdbrl_variation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span>

    <span class="c1"># Calculando pnl e rentab totais (ainda nao sabemos em qual moeda esta)</span>
    <span class="n">total_pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fund_pnl</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
    <span class="n">total_rentab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span>
    <span class="n">others_pnl</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_&quot;</span><span class="o">+</span><span class="n">fund_currency</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">others_pnl_curncy</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_&quot;</span><span class="o">+</span><span class="n">fund_currency</span><span class="o">+</span><span class="s2">&quot;_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Inicializando todas as possibilidades</span>
    <span class="n">total_pnl_brl</span><span class="p">,</span> <span class="n">total_pnl_usd</span><span class="p">,</span> <span class="n">total_rentab_brl</span><span class="p">,</span> <span class="n">total_rentab_usd</span> <span class="o">=</span> <span class="n">total_pnl</span><span class="p">,</span> <span class="n">total_pnl</span><span class="p">,</span> <span class="n">total_rentab</span><span class="p">,</span> <span class="n">total_rentab</span>
    <span class="n">others_pnl_brl</span><span class="p">,</span> <span class="n">others_pnl_usd</span> <span class="o">=</span> <span class="n">others_pnl</span><span class="p">,</span> <span class="n">others_pnl</span>
    <span class="n">others_pnl_brl_curncy</span><span class="p">,</span> <span class="n">others_pnl_usd_curncy</span> <span class="o">=</span> <span class="n">others_pnl_curncy</span><span class="p">,</span> <span class="n">others_pnl_curncy</span>

    <span class="c1"># Encontrando moeda e corrigindo valores.</span>
    <span class="k">if</span> <span class="n">fund_currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>
        <span class="n">others_pnl_brl</span> <span class="o">=</span> <span class="n">others_pnl_brl</span> <span class="o">*</span> <span class="n">end_usdbrl</span>
        <span class="n">others_pnl_brl_curncy</span> <span class="o">=</span> <span class="n">others_pnl_brl_curncy</span> <span class="o">*</span> <span class="n">end_usdbrl</span>
        <span class="n">total_pnl_brl</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_brl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">others_pnl_brl</span>
        <span class="n">total_rentab_brl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">total_rentab_usd</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">usdbrl_variation</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Nesse caso:</span>
        <span class="c1"># O pnl total precisa ter o mesmo sinal da rentabilidade total, senao algo esta errado.</span>
        <span class="k">if</span> <span class="n">total_pnl_brl</span> <span class="o">*</span> <span class="n">total_rentab_brl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rentabilidade e pnl com sinais trocados. Conferir &#39;</span><span class="si">{</span><span class="n">fund</span><span class="si">}</span><span class="s2">&#39; de &#39;</span><span class="si">{</span><span class="n">previous_date</span><span class="si">}</span><span class="s2">&#39; ate &#39;</span><span class="si">{</span><span class="n">recent_date</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtendo pnl total a partir da rentabilidade e PL medio do periodo&quot;</span><span class="p">)</span>
            <span class="n">fund_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund ==@fund and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
            <span class="n">total_pnl_brl</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;Quota&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">average_usdbrl</span> <span class="o">*</span> <span class="n">total_rentab_brl</span>

    <span class="k">elif</span> <span class="n">fund_currency</span> <span class="o">==</span> <span class="s2">&quot;brl&quot;</span><span class="p">:</span>
        <span class="n">others_pnl_usd</span> <span class="o">=</span><span class="n">others_pnl_usd</span> <span class="o">/</span> <span class="n">end_usdbrl</span> 
        <span class="n">others_pnl_usd_curncy</span> <span class="o">=</span> <span class="n">others_pnl_usd_curncy</span> <span class="o">/</span> <span class="n">end_usdbrl</span>
        <span class="n">total_pnl_usd</span> <span class="o">=</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;p&amp;l_usd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">others_pnl_usd</span>
        <span class="n">total_rentab_usd</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">total_rentab_brl</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">usdbrl_variation</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Nesse caso:</span>
        <span class="c1"># O pnl total precisa ter o mesmo sinal da rentabilidade total, senao algo esta errado.</span>
        <span class="k">if</span> <span class="n">total_pnl_usd</span> <span class="o">*</span> <span class="n">total_rentab_usd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rentabilidade e pnl com sinais trocados. Conferir &#39;</span><span class="si">{</span><span class="n">fund</span><span class="si">}</span><span class="s2">&#39; de &#39;</span><span class="si">{</span><span class="n">previous_date</span><span class="si">}</span><span class="s2">&#39; ate &#39;</span><span class="si">{</span><span class="n">recent_date</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtendo pnl total a partir da rentabilidade e PL medio do periodo&quot;</span><span class="p">)</span>
            <span class="n">fund_quotas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund ==@fund and Date &gt;= @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
            <span class="n">total_pnl_usd</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund_quotas</span><span class="p">[</span><span class="s2">&quot;Quota&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">average_usdbrl</span> <span class="o">*</span> <span class="n">total_rentab_usd</span>

    <span class="n">others_attr_brl</span> <span class="o">=</span> <span class="n">total_rentab_brl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_brl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">others_attr_brl_curncy</span> <span class="o">=</span> <span class="n">total_rentab_brl</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_brl_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">others_attr_usd</span> <span class="o">=</span> <span class="n">total_rentab_usd</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_usd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">others_attr_usd_curncy</span> <span class="o">=</span> <span class="n">total_rentab_usd</span> <span class="o">-</span> <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;attr_usd_curncy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Vamos inserir o row &#39;outros&#39; com o que falta de pnl para atingir a rentabilidade do periodo</span>
    <span class="n">hist_attr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;outros_outros&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">others_pnl_brl</span><span class="p">,</span> <span class="n">others_pnl_brl_curncy</span><span class="p">,</span> <span class="n">others_pnl_usd</span><span class="p">,</span> <span class="n">others_pnl_usd_curncy</span><span class="p">,</span> <span class="n">others_attr_brl</span><span class="p">,</span> <span class="n">others_attr_brl_curncy</span><span class="p">,</span> <span class="n">others_attr_usd</span><span class="p">,</span> <span class="n">others_attr_usd_curncy</span><span class="p">]</span>

    <span class="c1">#hist_attr.loc[&quot;outros_outros&quot;] = [others_pnl_brl, others_pnl_brl_curncy, others_pnl_usd, others_pnl_usd_curncy]</span>


    <span class="c1"># Vamos calcular o % de atribuicao, proporcional a variacao da cota no periodo</span>
    <span class="c1"># Em reais</span>
    <span class="c1">#hist_attr[&quot;attr_brl&quot;] = hist_attr.apply(lambda row: ((row[&quot;p&amp;l_brl&quot;])/abs(row[&quot;p&amp;l_brl&quot;])) * abs(row[&quot;p&amp;l_brl&quot;] * total_rentab_brl/total_pnl_brl), axis=1)</span>
    <span class="c1">#hist_attr[&quot;attr_brl_curncy&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_brl_curncy&quot;] * total_rentab_brl/total_pnl_brl, axis=1)</span>
    <span class="c1"># Em dolares</span>
    <span class="c1">#hist_attr[&quot;attr_usd&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_usd&quot;] * total_rentab_usd/total_pnl_usd, axis=1)</span>
    <span class="c1">#hist_attr[&quot;attr_usd_curncy&quot;] = hist_attr.apply(lambda row: row[&quot;p&amp;l_usd_curncy&quot;] * total_rentab_usd/total_pnl_usd, axis=1)</span>


    <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;Start_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>
    <span class="n">hist_attr</span><span class="p">[</span><span class="s2">&quot;End_Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recent_date</span>

    <span class="k">return</span> <span class="n">hist_attr</span>        
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_daily_pnl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_daily_pnl</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">group_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">classification_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">asset_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">currency_exposure_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_cash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_cash_debt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticker_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">annual_adm_fee</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_small_pnl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_daily_pnl" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o PnL do dia de cada ativo no fundo.
    (Nao inclui o PnL das taxas!).
Args:
    fund (str): nome do fundo
    ref_date (str): data de referência do PnL
    currency (str): moeda (usd|brl)
    holiday_location (str, optional): refencia de feriados. Defaults to "all".
    bdays (int, optional): quantidade de dias uteis a serem considerados.
                        Defaults to 10.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_daily_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">group_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">classification_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">asset_filters</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">currency_exposure_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_cash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_cash_debt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticker_filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">annual_adm_fee</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ignore_small_pnl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span> <span class="c1">#test_op_fix=False):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calcula o PnL do dia de cada ativo no fundo.</span>
<span class="sd">        (Nao inclui o PnL das taxas!).</span>
<span class="sd">    Args:</span>
<span class="sd">        fund (str): nome do fundo</span>
<span class="sd">        ref_date (str): data de referência do PnL</span>
<span class="sd">        currency (str): moeda (usd|brl)</span>
<span class="sd">        holiday_location (str, optional): refencia de feriados. Defaults to &quot;all&quot;.</span>
<span class="sd">        bdays (int, optional): quantidade de dias uteis a serem considerados.</span>
<span class="sd">                            Defaults to 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dia util anterior</span>
    <span class="c1"># Obtendo todas as posicoes e movimentacoes, dos ultimos dias</span>
    <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">ref_date</span><span class="p">,</span> <span class="o">-</span><span class="n">bdays</span><span class="p">,</span>
                                    <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions_and_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                        <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span>
                                                      <span class="s2">&quot;Currency Exposure&quot;</span><span class="p">:</span><span class="s2">&quot;Currency_Exposure&quot;</span><span class="p">})</span>

    <span class="c1"># Filtrando pelos ativos desejados</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">classification_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">classification_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">classification_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Luxor_Classification.isin(@classification_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">group_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Group.isin(@group_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">type_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">type_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@type_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">asset_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">asset_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">asset_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset.isin(@asset_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticker_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ticker_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ticker_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Ticker.isin(@ticker_filters)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">currency_exposure_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">currency_exposure_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">currency_exposure_filters</span><span class="p">]</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Currency_Exposure.isin(@currency_exposure_filters)&quot;</span><span class="p">)</span>
    <span class="c1"># Fazemos uma juncao interna, mantendo somente as linhas filtradas acima</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Date&quot;</span> <span class="p">:</span> <span class="s2">&quot;Today&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Open_Quantity&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Quantity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Last_Price&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Current_Position_Value&quot;</span> <span class="p">:</span> <span class="s2">&quot;Close_Mkt_Value&quot;</span>
    <span class="p">})</span>

    <span class="c1"># Obtendo o preco de abertura</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">])</span>
    <span class="n">types_to_fix_open_price</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndf usdbrl&#39;</span><span class="p">]</span>
    <span class="c1">#if test_op_fix:</span>

    <span class="n">df_op_fix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@types_to_fix_open_price)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_op_fix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fix_open_price</span><span class="p">(</span><span class="n">df_op_fix</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Type.isin(@types_to_fix_open_price)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Juntando dfs novamente</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_op_fix</span><span class="p">])</span>



    <span class="c1"># Precisamos consertar o open_price do FX. (Deve ser convertido pelo spot de fechamento sempre)</span>

    <span class="c1"># Podemos puxar o caixa aqui e concatenar para as proximas operacoes</span>
    <span class="k">if</span> <span class="n">include_cash</span><span class="p">:</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hist_cash_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="n">bdays</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                            <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">])</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Close_Mkt_Value &gt;= 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixed income&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">cash</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Vamos segregar como dívida o caixa virado.</span>
    <span class="k">if</span> <span class="n">include_cash_debt</span><span class="p">:</span>
        <span class="n">cash_debt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hist_cash_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="n">bdays</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                                 <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">])</span>
        <span class="n">cash_debt</span> <span class="o">=</span> <span class="n">cash_debt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Close_Mkt_Value &lt; 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cash_debt</span><span class="p">[</span><span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;debt&#39;</span>

        <span class="c1"># Caixa virado no Brasil, vamos desconsiderar, pois na prática nao teremos.</span>
        <span class="c1">#cash_debt = cash_debt.query(&quot;Asset_ID != &#39;caixa_caixa&#39; or Location != &#39;bz&#39;&quot;).copy()</span>
        <span class="c1">#Optando por manter e retirar o PnL posteriormente, para nao perder a contribuicao dele pra aporte e resgate</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
            <span class="n">cash_debt</span> <span class="o">=</span> <span class="n">cash_debt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">cash_debt</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Vamos obter a data d-1</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Yesterday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                        <span class="p">)</span>
    <span class="c1"># Obtendo quantidade na abertura</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Obtendo valor de mercado por ativo na abertura</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span>
    <span class="c1"># Calculando precos de compas e vendas</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Buy_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> 
                        <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sell_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Calculando PnL Diário (Caixa nao pode ser calculado aqui, pois o preco eh sempre 1)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Buy_Price&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sell_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">])</span>
    <span class="c1"># Ajustando PnL sold. Quando for debt, a venda representa a divida sendo tomada</span>
    <span class="c1"># e a compra representa o pagamento da divida. Na primeira, ha juros e na segunda nao ha pnl.</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Bought&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Luxor_Classification&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Bought&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pnl_Sold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Luxor_Classification&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;debt&#39;</span><span class="p">,</span> 
                              <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open_Price&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close_Price&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Shares_Sold&#39;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">])</span>

    <span class="c1"># O caixa no BZ pode estar virado temporariamente durante aportes/resgates de caixa_us, mas isso n estará gerando PnL</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;caixa_caixa&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;caixa_caixa&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">])</span>



    <span class="c1"># Ajustar aqui as operacoes com logica de pnl e exposicao</span>
    <span class="c1"># Para nao considerar no AUM e no Cash Flow</span>
    <span class="n">types_to_recalculate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndf usdbrl&#39;</span><span class="p">]</span>
    <span class="c1"># Separando os dados em dois grupos, para editar um deles</span>
    <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type.isin(@types_to_recalculate)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Type.isin(@types_to_recalculate)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Calculo especifico para pnl do FX.</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> \
                                 <span class="o">+</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span>

    <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])</span>
    <span class="c1"># Valor de mercado sera o PnL acumulado</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">]</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Retirando qualquer possibilidade de impacto para aporte e resgate</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df_exposure</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO Pensar o que vai mudar no caso de uma zeragem parcial</span>
    <span class="n">df_exposure</span> <span class="o">=</span> <span class="n">df_exposure</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Total_Pnl&quot;</span><span class="p">)</span>


    <span class="c1"># Juntando dfs novamente</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_exposure</span><span class="p">])</span>

    <span class="c1"># Calculando net de aporte e resgate por ativo</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">])</span>

    <span class="n">hist_dividends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                        <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
    <span class="n">hist_dividends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">]],</span>
                        <span class="n">hist_dividends</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">]]</span>
    <span class="n">hist_dividends</span> <span class="o">=</span> <span class="n">hist_dividends</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">:</span><span class="s2">&quot;Dividends&quot;</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hist_dividends</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Luxor_Classification&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Open_Quantity&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Quantity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Buy_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell_Price&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cash_Flow&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]]</span>


    <span class="c1"># Calculando AUM no fechamento</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_AUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">annual_adm_fee</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Incluir taxas de adm e gestao no calculo do PnL</span>
    <span class="c1"># Elas ja impactam o caixa, mas precisam ser consideradas no PnL</span>
        <span class="n">daily_adm_fee</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_adm_fee</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">365</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_AUM&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Close_AUM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">daily_adm_fee</span>
        <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_fees</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;taxas e custos_tx adm&quot;</span>

        <span class="n">value_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Sobrescreve com 0, menos para Pnl_Unchanged e Close_AUM</span>

        <span class="n">df_fees</span><span class="p">[</span><span class="n">value_columns</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Para taxas, todos os outros valores nao importam.</span>
        <span class="c1"># Finalmente, falta colocar dados de name, type e group</span>
        <span class="n">all_assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">})</span>

        <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">location_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">location_filters</span><span class="p">]</span>
            <span class="n">df_fees</span> <span class="o">=</span> <span class="n">df_fees</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location.isin(@location_filters)&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_fees</span><span class="p">])</span>  


    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Pnl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Unchanged&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Bought&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Pnl_Sold&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>

    <span class="c1"># Calculando PL Inicial Ajustado</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Cash_Flow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Sera o valor de mercado da abertura somado com o net de aportes.</span>
    <span class="c1"># Racional: Resgates rentabilizam no dia (ja estao no inicial)</span>
    <span class="c1">#           Aportes rentabilizam no dia (nao estano no inicial)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Open_Mkt_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM_Adjusted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM&quot;</span><span class="p">]</span> <span class="o">+</span> 
                                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Net_Subscriptions_Redemptions&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Pnl&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_AUM_Adjusted&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Daily_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Today&quot;</span><span class="p">)[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


    <span class="c1"># ao retornar, filtrar port Daily_Pnl != 0 e  not Daily_Pnl.isna()</span>
    <span class="k">if</span> <span class="n">ignore_small_pnl</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39; (Daily_Pnl &lt;= -0.01 or Daily_Pnl &gt;= 0.01)</span><span class="se">\</span>
<span class="s1">                                        and not Daily_Pnl.isna()&#39;&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Today&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_drawdown" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_drawdown</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_drawdown" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o drawdown para um ativo ou um conjunto de ativos em cada data do perido fornecido.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tickers</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span> | <span title="set">set</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ticker ou lista de tickers</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Seguinte DataFrame usando Date como index -&gt; [[Asset, Period_Change, Previous_Peak, Drawdowns]]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calcula o drawdown para um ativo ou um conjunto de ativos em cada data do perido fornecido.</span>

<span class="sd">    Args:</span>
<span class="sd">        tickers (str|list|set): ticker ou lista de tickers</span>
<span class="sd">        previous_date (dt.date): _description_</span>
<span class="sd">        recent_date (dt.date):</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Seguinte DataFrame usando Date como index -&gt; [[Asset, Period_Change, Previous_Peak, Drawdowns]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Period_Change&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Period_Change&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Drawdowns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Period_Change&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Peak&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_fund_particip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_fund_particip" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <div class="highlight"><pre><span></span><code>Informa o percentual que &#39;fund_name&#39; possui do &#39;fund_owned&#39;.
</code></pre></div>
        <p>Returns:
    (float)</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_fund_particip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Informa o percentual que &#39;fund_name&#39; possui do &#39;fund_owned&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        fund_name (str) </span>
<span class="sd">        fund_owned (str)</span>
<span class="sd">        date (dt.date) </span>
<span class="sd">    Returns:</span>
<span class="sd">        (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fund_name</span> <span class="o">=</span> <span class="n">fund_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">fund_owned_key</span> <span class="o">=</span> <span class="n">fund_owned</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fund_owned</span>

    <span class="c1"># antes da data de incorporacao do manga master pelo lipi, 100% do manga master era do manga fic</span>
    <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># antes da data de incorporacao do manga master pelo lipi, 100% do fund_a era do manga master</span>
    <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga master&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Adicionando mais um nivel de calculo </span>
    <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fund_name</span> <span class="o">==</span> <span class="s2">&quot;mangalarga ii fic fia&quot;</span> <span class="ow">and</span> <span class="n">fund_owned</span> <span class="o">==</span> <span class="s2">&quot;fund a&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;mangalarga fic fia&quot;</span><span class="p">,</span> <span class="s2">&quot;mangalarga master&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fund_particip</span><span class="p">(</span><span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span> <span class="n">fund_owned</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_positions&quot;</span><span class="p">)</span>

    <span class="c1"># Busca otimizada pela posicao</span>
    <span class="k">try</span><span class="p">:</span>        
        <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[(</span>
                        <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_name</span><span class="p">)</span>
                        <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_owned_key</span><span class="p">)</span>
                        <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span>
                    <span class="p">)]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c1"># nao havia participacao do fundo em questao na data informada</span>
        <span class="k">return</span> <span class="mi">0</span>


    <span class="n">fund_owned_total_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fund_owned_total_amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[(</span>
                                        <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">fund_owned</span><span class="p">)</span>
                                        <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">fund_owned_total_amount</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span>
                                        <span class="p">)]</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>

        <span class="c1"># Algo deu errado</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">position</span><span class="o">/</span><span class="n">fund_owned_total_amount</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Mantem 5 casas decimais de precisao</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_price_correlation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_price_correlation</span><span class="p">(</span><span class="n">assets_data</span><span class="p">,</span> <span class="n">sample_frequency</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;12m&#39;</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_price_correlation" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calculate the correlation between assets in the columns of 'asset_prices'. The correlation is calculated using the formula:
corr = (1 + r1<em>r2 + r1</em>r2<em>corr) / sqrt(1+r1</em><em>2) * sqrt(1+r2</em>*2)
where r1 and r2 are the returns of the assets and corr is the correlation between the returns.
The correlation is calculated using the formula above and the returns are calculated using the formula:
r = (price[t] - price[t-1]) / price[t-1]
where t is the time period.
The returns are calculated using the sample frequency and the lookback in months.
assets_data: dict mapeando ticker para {Name:str, Key:str e Location:str(bz ou us)}
sample_frequency: str, default "monthly". Frequencia de amostragem dos precos. Pode ser "daily", "weekly" ou "monthly"
period: str, default '12m'. Periodo de calculo da correlacao. Deve ser 'ytd' ou o numero de meses seguido por 'm'</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_price_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets_data</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">sample_frequency</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;12m&quot;</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the correlation between assets in the columns of &#39;asset_prices&#39;. The correlation is calculated using the formula:</span>
<span class="sd">    corr = (1 + r1*r2 + r1*r2*corr) / sqrt(1+r1**2) * sqrt(1+r2**2)</span>
<span class="sd">    where r1 and r2 are the returns of the assets and corr is the correlation between the returns.</span>
<span class="sd">    The correlation is calculated using the formula above and the returns are calculated using the formula:</span>
<span class="sd">    r = (price[t] - price[t-1]) / price[t-1]</span>
<span class="sd">    where t is the time period.</span>
<span class="sd">    The returns are calculated using the sample frequency and the lookback in months.</span>
<span class="sd">    assets_data: dict mapeando ticker para {Name:str, Key:str e Location:str(bz ou us)}</span>
<span class="sd">    sample_frequency: str, default &quot;monthly&quot;. Frequencia de amostragem dos precos. Pode ser &quot;daily&quot;, &quot;weekly&quot; ou &quot;monthly&quot;</span>
<span class="sd">    period: str, default &#39;12m&#39;. Periodo de calculo da correlacao. Deve ser &#39;ytd&#39; ou o numero de meses seguido por &#39;m&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_frequency</span> <span class="o">=</span> <span class="n">sample_frequency</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">asset_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">assets_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">},</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">ref_date</span><span class="p">,</span>
                                    <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">)</span>
    <span class="n">usdbrl_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;usdbrl curncy&quot;</span><span class="p">},</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">usdbrl_prices</span><span class="p">])</span>

    <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>


    <span class="n">frequencies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;daily&quot;</span><span class="p">:</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly&quot;</span><span class="p">:</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly&quot;</span><span class="p">:</span><span class="s2">&quot;ME&quot;</span><span class="p">}</span>
    <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="n">sample_frequency</span><span class="p">])</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    <span class="c1">#returns = asset_prices.pct_change(lookback_in_months)</span>
    <span class="c1">#returns = returns.dropna()</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    <span class="n">correlations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Asset_Corr&quot;</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">value_vars</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset_Corr&quot;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">value_vars</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;Correlation&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Correlation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset_Corr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Asset_Corr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">assets_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
    <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">assets_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Key&quot;</span><span class="p">])</span>
    <span class="n">correlations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Order&quot;</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Comp_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset_Corr&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Key_Asset&quot;</span><span class="p">]</span>
    <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_frequency</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ly&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">period</span> <span class="o">=</span> <span class="n">period</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ytd&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;y&quot;</span>
    <span class="n">correlations</span><span class="p">[</span><span class="s2">&quot;Period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">correlations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.calculate_tracking_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_tracking_error</span><span class="p">(</span><span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.calculate_tracking_error" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o tracking error de uma serie de retorno com relacao ao benchmark.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>returns_ticker</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ticker da serie de retorno que sera testada</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>benchmark_ticker</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ticker da serie de retorno que sera usada para comparacao</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data de inicio do teste</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>() - <span title="datetime.timedelta">timedelta</span>(days=365 * 2)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data de fim do teste</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>() - <span title="datetime.timedelta">timedelta</span>(days=1)</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    <em>type</em>: <em>description</em></p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_tracking_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calcula o tracking error de uma serie de retorno com relacao ao benchmark.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns_ticker (str): ticker da serie de retorno que sera testada</span>
<span class="sd">        benchmark_ticker (str): ticker da serie de retorno que sera usada para comparacao</span>
<span class="sd">        previous_date (dt.date): data de inicio do teste</span>
<span class="sd">        recent_date (dt.date): data de fim do teste</span>
<span class="sd">    Returns:</span>
<span class="sd">        _type_: _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>


    <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">([</span><span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">)</span>

    <span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">returns</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">returns_ticker</span><span class="p">,</span> <span class="n">benchmark_ticker</span><span class="p">]</span>

    <span class="n">n_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">returns</span><span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">returns_ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">returns</span><span class="p">[</span><span class="n">benchmark_ticker</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">tracking_error</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tracking_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n_periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">tracking_error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_bday_offset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;bz&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_bday_offset" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Retorna dia util com offset dias pra frente ou pra tras.</p>
<p>location (str): 
    'any'-&gt; se é feriado em qualquer um dos lugares cadastrados</p>
<div class="highlight"><pre><span></span><code>&#39;all&#39; -&gt; se é feriado em todas as localidades da tabela

&#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_bday_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bz&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Retorna dia util com offset dias pra frente ou pra tras.\n</span>
<span class="sd">            location (str): </span>
<span class="sd">                &#39;any&#39;-&gt; se é feriado em qualquer um dos lugares cadastrados\n</span>
<span class="sd">                &#39;all&#39; -&gt; se é feriado em todas as localidades da tabela\n</span>
<span class="sd">                &#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela\n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset_direction</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">offset_direction</span> <span class="o">=</span> <span class="n">offset</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="c1"># Pegamos proxima data</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">offset_direction</span><span class="p">)</span>
        <span class="c1"># Verificamos se eh dia util. Se for, contabilizamos.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_holiday</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">date</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_bdays_count" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_bdays_count</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;bz&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_bdays_count" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula quantos dias uteis existem entre recent_date e previous_date
(Exclusivo, ou seja, recent_date e previous_date nao sao contados)</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_bdays_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bz&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula quantos dias uteis existem entre recent_date e previous_date</span>
<span class="sd">    (Exclusivo, ou seja, recent_date e previous_date nao sao contados)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iter_date</span> <span class="o">=</span> <span class="n">recent_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># primeiro dia nao eh contado</span>

    <span class="k">while</span> <span class="n">iter_date</span> <span class="o">&gt;</span> <span class="n">previous_date</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iter_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_holiday</span><span class="p">(</span><span class="n">iter_date</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">iter_date</span> <span class="o">-=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">counter</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_benchmark_spx_cash" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_benchmark_spx_cash</span><span class="p">(</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">prop_spx</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="o">=</span><span class="s1">&#39;jpmutcc lx equity&#39;</span><span class="p">,</span> <span class="n">spx_ticker</span><span class="o">=</span><span class="s1">&#39;spxt index&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_benchmark_spx_cash" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Obtem a serie historica do benchmark luxor a partir do indice s&amp;p e caixa nas proporcoes desejadas.
Args:
    previous_date (datetime.date): Data inicial desejada
    recent_date (datetime.date): Data final desejada
    prop_spx (float, optional): Proporcao s&amp;p. Defaults to 0.8.
    prop_cash (float, optional): Proporcao caixa. Defaults to 0.2.
    currency (str, optional): Moeda desejada ('usd','brl'). Defaults to "usd".
    usdbrl_ticker (str, optional): Ticker do usdbrl para conversao. Defaults to "bmfxclco curncy".
    cash_ticker (str, optional): Ticker do ativo usado como caixa. Defaults to "jpmutcc lx equity".
    spx_ticker (str, optional): Ticker do ativo usado como s&amp;p. Defaults to "spxt index".
Returns:
    pandas.DataFrame: DataFrame contendo coluna Benchmark e Datas como index.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_benchmark_spx_cash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">:</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">:</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">prop_spx</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">prop_cash</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
                           <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="o">=</span><span class="s2">&quot;jpmutcc lx equity&quot;</span><span class="p">,</span> <span class="n">spx_ticker</span><span class="o">=</span><span class="s2">&quot;spxt index&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Obtem a serie historica do benchmark luxor a partir do indice s&amp;p e caixa nas proporcoes desejadas.</span>
<span class="sd">    Args:</span>
<span class="sd">        previous_date (datetime.date): Data inicial desejada</span>
<span class="sd">        recent_date (datetime.date): Data final desejada</span>
<span class="sd">        prop_spx (float, optional): Proporcao s&amp;p. Defaults to 0.8.</span>
<span class="sd">        prop_cash (float, optional): Proporcao caixa. Defaults to 0.2.</span>
<span class="sd">        currency (str, optional): Moeda desejada (&#39;usd&#39;,&#39;brl&#39;). Defaults to &quot;usd&quot;.</span>
<span class="sd">        usdbrl_ticker (str, optional): Ticker do usdbrl para conversao. Defaults to &quot;bmfxclco curncy&quot;.</span>
<span class="sd">        cash_ticker (str, optional): Ticker do ativo usado como caixa. Defaults to &quot;jpmutcc lx equity&quot;.</span>
<span class="sd">        spx_ticker (str, optional): Ticker do ativo usado como s&amp;p. Defaults to &quot;spxt index&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: DataFrame contendo coluna Benchmark e Datas como index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">complementary_previous_date</span><span class="o">=</span><span class="n">previous_date</span>

    <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cash_ticker</span> <span class="o">==</span> <span class="s1">&#39;jpmutcc lx equity&#39;</span><span class="p">:</span>
        <span class="c1">#logger.warning(f&quot;Nao ha datas anteriores a {dt.date(2018,12,31)} para o JPMUTCC. Sera usada essa.&quot;)</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">previous_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cash_ticker</span> <span class="o">==</span> <span class="s1">&#39;sofrindx index&#39;</span><span class="p">:</span>
        <span class="c1">#logger.warning(f&quot;Nao ha datas anteriores a {dt.date(2018,12,31)} para o JPMUTCC. Sera usada essa.&quot;)</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>



    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">,</span> <span class="n">cash_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span><span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> 
                           <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">recent_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="c1"># Precisamos ajustar o ultimo preco para o mais recente</span>
        <span class="n">last_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> 
                                    <span class="s2">&quot;Asset&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;spxt index&quot;</span><span class="p">,</span><span class="n">cash_ticker</span><span class="p">],</span> 
                                  <span class="s2">&quot;Last_Price&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s2">&quot;spxt index&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">cash_ticker</span><span class="p">)]</span>
                                <span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt; @d&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">last_prices</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">complementary_previous_date</span> <span class="o">!=</span> <span class="n">previous_date</span><span class="p">:</span>
        <span class="c1"># Entrar aqui significa que o periodo precisou ser ajustado, pois eh anterior a existencia do indice usado para o caixa</span>
        <span class="c1"># Nesse caso, vamos pegar todo o periodo que faltou e considerar retorno diario do FED FUND</span>

        <span class="c1"># Primeiro, obtemos o periodo completo do s&amp;p</span>
        <span class="n">data_spx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">complementary_previous_date</span><span class="p">,</span>
                                             <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="c1"># Em seguida, vamos pegar o parcial do jpmutcc e completar com o treasury, </span>
        <span class="c1"># Para isso, sera necessario criar uma serie normalizada a partir dos retornos diarios</span>
        <span class="n">data_treasury</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Asset == @cash_ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="s2">&quot;Asset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">cash_initial_date</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
        <span class="n">complementary_treasury</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fedl01 index&quot;</span><span class="p">],</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">complementary_previous_date</span><span class="p">,</span>
                                             <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
        <span class="n">complementary_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">complementary_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">complementary_treasury</span> <span class="o">=</span> <span class="n">complementary_treasury</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt; @cash_initial_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_treasury</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">complementary_treasury</span><span class="p">,</span> <span class="n">data_treasury</span><span class="p">])</span>
        <span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash_ticker</span>
        <span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_treasury</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_spx</span><span class="p">,</span> <span class="n">data_treasury</span><span class="p">])</span>



    <span class="c1"># Gerando tabela de granularidade mensal, com as cotas mensais do indicador</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_spx</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_cash</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># Salvando a base mensal num novo df</span>
    <span class="n">df_benchmark</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Benchmark&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="c1"># Gerando base de granularidade diaria com o fator de retorno mtd com 80% spxt e 20% jpmutcc</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Asset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Pct_Change&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#df[cash_ticker].ffill() # como tende a ser constante, podemos estimar os valores na</span>
    <span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># para o s&amp;p por ser variavel, preencheremos com 0 sempre</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
    <span class="c1"># Acumulando para encontrar o retorno MTD</span>
    <span class="n">df_mtd_w</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="c1"># Ponderando para encontrar o benchmark MTD 80/20</span>
    <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;MTD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="p">[</span><span class="n">cash_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_cash</span> <span class="o">+</span> <span class="n">df_mtd_w</span><span class="p">[</span><span class="n">spx_ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">prop_spx</span>

    <span class="c1"># Agora que temos o fator MTD granularidade diaria e a cota mensal</span>
    <span class="c1"># Vamos colocar a cota mensal numa coluna da tabela de granulariade diaria</span>
    <span class="c1"># Primeiro, precisamos de uma juncao que compreenda ano e mes</span>
    <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df_mtd_w</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df_benchmark</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">:</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">})</span>

    <span class="c1"># shiftando para que seja sempre a rentabilidade acumulada ate o mes anterior.</span>
    <span class="c1"># Essa operacao tambem ira descartar qualquer acumulo feito numa data que nao for fim de mes.</span>
    <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_benchmark</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>

    <span class="c1"># Preenchemos entao uma coluna com a rentabilidade de cada mes anterior</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_mtd_w</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_benchmark</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="c1"># Finalmente, o benchmark sera obtido atraves do acumulado anterior acumulado com o MTD atual</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Benchmark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Previous_Month_Acc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MTD&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Benchmark&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_current_fx_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_current_fx_data</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">fx_ticker</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_current_fx_data" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o PNL de FX de um fundo. -&gt; CONSIDERANDO QUE EH USDBRL</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_current_fx_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">fx_ticker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calcula o PNL de FX de um fundo. -&gt; CONSIDERANDO QUE EH USDBRL&quot;&quot;&quot;</span>
    <span class="n">fx_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;last_positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund and Ticker == @fx_ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Pnl_USD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Pnl_BRL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Avg_price&quot;</span><span class="p">])</span>
    <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Exposure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fx_positions</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>
    <span class="n">fx_positions</span> <span class="o">=</span> <span class="n">fx_positions</span><span class="p">[[</span><span class="s2">&quot;Pnl_USD&quot;</span><span class="p">,</span> <span class="s2">&quot;Pnl_BRL&quot;</span><span class="p">,</span> <span class="s2">&quot;Exposure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fx_positions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_group_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_group_results</span><span class="p">(</span><span class="n">previous_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;brl&#39;</span><span class="p">,</span> <span class="n">inception_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_group_results" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula e retorna o resultado de cada segmento.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data inicial NAO inclusiva (sera filtrado por uma data anterior a essa.)
                    Ex. Para considerar retorno ate o mes de marco, deve ser passada alguma data em abril.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data final</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segments</code>
            </td>
            <td>
                  <code><span title="_type_">_type_</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista ou string com nome dos segmentos 
desejados. Defaults to None. Quando None, retorna todos os segmentos existentes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Retorno por segmento.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_group_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">segments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;brl&quot;</span><span class="p">,</span> <span class="n">inception_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calcula e retorna o resultado de cada segmento.</span>

<span class="sd">    Args:</span>
<span class="sd">        recent_date (dt.date): Data inicial NAO inclusiva (sera filtrado por uma data anterior a essa.)</span>
<span class="sd">                                Ex. Para considerar retorno ate o mes de marco, deve ser passada alguma data em abril.</span>
<span class="sd">        previous_date (dt.date): Data final</span>
<span class="sd">        segments (_type_, optional): Lista ou string com nome dos segmentos </span>
<span class="sd">            desejados. Defaults to None. Quando None, retorna todos os segmentos existentes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Retorno por segmento.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">previous_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">previous_date</span> <span class="o">&gt;</span> <span class="n">recent_date</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data inicial é menor que a data final. Parametros invertidos?&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># Obtendo tabela de retornos historicos extraida do retorno consolidado</span>
    <span class="n">group_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;luxor group results&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Segment&quot;</span><span class="p">,</span> <span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="c1"># Selecionando o periodo de tempo desejado</span>
    <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">recent_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ytd&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># fechamento de dezembro! Vamos ter que ajustar o previous_date</span>
                <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">35</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
            <span class="n">previous_date</span> <span class="o">+=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;= @previous_date and Date &lt; @recent_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">segments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Vamos deixar apenas os segmentos informados no parametro &#39;segments&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">segments</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">seg_filter</span> <span class="o">=</span> <span class="n">segments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;segments&#39; precisa ser do tipo &#39;list&#39; ou &#39;str&#39;&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot; Segment.isin(@seg_filter)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Segment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Retornos dos segmentos, por padrao, estarao em R$.</span>
    <span class="c1"># Para ver em US$ precisa ser feita a conversao.</span>
    <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">__get_usdbrl_variation</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span>
            <span class="c1"># ajustando janelas de inicio e fim, para pegar a variacao correta de usd no periodo -&gt;  A base do grupo eh de retornos, a de usd eh de preços                </span>
            <span class="n">usd_recent_date</span>  <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">recent_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">usd_previous_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">previous_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Ainda, se a data for anterior ou igual ao inceptio date, vamos usar o incepion date</span>
            <span class="c1">#print(f&quot;conversao usdbrl usando: previous_date:{usd_previous_date}  recent_date: {usd_recent_date}&quot;)</span>
            <span class="k">if</span> <span class="n">inception_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">inception_dates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">sgmnt_inception</span> <span class="o">=</span> <span class="n">inception_dates</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># subtraindo 1 dia para usar o fechamento do dia anterior ao inicio</span>
                <span class="n">usd_previous_date</span> <span class="o">=</span> <span class="n">sgmnt_inception</span> <span class="k">if</span> <span class="p">((</span><span class="n">sgmnt_inception</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sgmnt_inception</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">previous_date</span><span class="o">.</span><span class="n">month</span><span class="p">))</span> <span class="k">else</span> <span class="n">usd_previous_date</span>
                                        <span class="c1">#&quot;bmfxclco curncy&quot; -&gt; converter usando usd cupom limpo</span>

            <span class="n">delta_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">usd_previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">usd_recent_date</span><span class="p">)</span>
            <span class="c1">#print(f&quot;Segmento: {segment}  Retorno_BRL:{multiplier}  delta usdbrl={delta_usdbrl}   Retorno_USD: {(1+multiplier)/(1+delta_usdbrl)-1}&quot;)</span>
            <span class="k">return</span> <span class="n">delta_usdbrl</span>


        <span class="c1"># Convertendo para usd o que estiver em brl</span>

        <span class="n">group_results</span><span class="p">[</span><span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Return_Multiplier&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">__get_usdbrl_variation</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Segment&quot;</span><span class="p">]))</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">group_results</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Segment&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">group_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_hist_cash_movements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_hist_cash_movements</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_hist_cash_movements" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Retorna o historico de caixa do fundo.
Args:
    fund (str): nome do fundo
    currency (str): moeda (usd|brl)</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame: historico de caixa</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hist_cash_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">bdays</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span> <span class="o">=</span> <span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retorna o historico de caixa do fundo.</span>
<span class="sd">    Args:</span>
<span class="sd">        fund (str): nome do fundo</span>
<span class="sd">        currency (str): moeda (usd|brl)</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: historico de caixa</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## TODO: Remover linhas com pnl e retorno vazios!</span>


    <span class="n">fund</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">ref_date</span><span class="p">,</span> <span class="o">-</span><span class="n">bdays</span><span class="p">,</span>
                                    <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>

    <span class="n">cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_portfolios_concentration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Group.isin([&#39;caixa&#39;,&#39;caixa_us&#39;]) and Fund_Name == @fund&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;= @previous_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># cash estara com ambos os caixas em R$ ou U$.</span>
    <span class="c1"># Para saber a moeda do caixa retornado, precisamos saber a moeda do fundo</span>
    <span class="n">fund_key</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">fund_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;funds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_key&quot;</span><span class="p">)[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">currency_location</span>  <span class="o">=</span> <span class="s2">&quot;us&quot;</span> <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span> <span class="k">else</span> <span class="s2">&quot;bz&quot;</span>
    <span class="k">if</span> <span class="n">fund_location</span> <span class="o">!=</span> <span class="n">currency_location</span><span class="p">:</span>
        <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),)</span>
        <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usdbrl_clean_coupon_fix</span><span class="p">(</span><span class="n">usdbrl</span><span class="p">)</span>
        <span class="n">usdbrl</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usdbrl</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">usdbrl</span> <span class="o">=</span> <span class="n">usdbrl</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">})</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">usdbrl</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;usdbrl&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fund_location</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span><span class="p">:</span>
            <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">]</span>

        <span class="c1"># Removendo coluna auxiliar</span>
        <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;usdbrl&quot;</span><span class="p">])</span>

    <span class="c1"># Vamos calcular o preco de fechamento com o rendimento do dia</span>
    <span class="n">bz_cash_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;bzacselc index&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
    <span class="n">bz_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bz_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="n">bz_cash_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">bz_cash_index</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;bz_cash_index&quot;</span><span class="p">})</span>
                        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">us_cash_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;sofrindx index&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
    <span class="n">us_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_cash_index</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="n">us_cash_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">us_cash_index</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;us_cash_index&quot;</span><span class="p">})</span>
                        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">us_margin_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="s2">&quot;sofr + 75bps&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;60m&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">)</span>
    <span class="n">us_margin_cost</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_margin_cost</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="n">us_margin_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">us_margin_cost</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span>
                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span><span class="s2">&quot;us_margin_cost&quot;</span><span class="p">})</span>
                        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bz_cash_index</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">us_cash_index</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">us_margin_cost</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="c1"># Dependendo do ativo e da posicao a variacao no dia será diferente</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Open_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;bz_cash_index&quot;</span><span class="p">]</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">,</span>
                                   <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;us_cash_index&quot;</span><span class="p">],</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span>
                                   <span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">,</span>
                                   <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="s1">&#39;bz&#39;</span>
                                   <span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Market_Value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;caixa_us&quot;</span><span class="p">)</span> <span class="p">,</span>
                                    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;us_margin_cost&quot;</span><span class="p">],</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Price&quot;</span><span class="p">]</span>
                                    <span class="p">)</span>

    <span class="n">cash</span> <span class="o">=</span> <span class="p">(</span><span class="n">cash</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Market_Value&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_Price&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span><span class="s2">&quot;Today&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Market_Value&quot;</span><span class="p">:</span><span class="s2">&quot;Close_Mkt_Value&quot;</span>
                                 <span class="p">}))</span>
    <span class="c1"># Criando colunas necessarias para concatenar com o df do daily pnl</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Close_Mkt_Value&quot;</span><span class="p">]</span>

    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>

    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Group&quot;</span><span class="p">])[</span><span class="s2">&quot;Close_Quantity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Amount_Sold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Sold&quot;</span><span class="p">]</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span><span class="p">[</span><span class="s2">&quot;Shares_Bought&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cash</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_position_variation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_position_variation</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_position_variation" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Fornece um dataframe com a variacao das posicoes do fundo entre as datas. 
Inclui tambem uma coluna de flag informando se a posicao foi zerada ou nao</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_position_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fornece um dataframe com a variacao das posicoes do fundo entre as datas. </span>
<span class="sd">        Inclui tambem uma coluna de flag informando se a posicao foi zerada ou nao</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Pegamos as posicoes da data mais recente, transformando de dict para dataframe</span>
    <span class="n">cur_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">recent_date</span><span class="p">)</span>
    <span class="n">cur_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur_positions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;#_cur&quot;</span><span class="p">])</span>

    <span class="c1"># Igual para as posicoes da data mais antiga</span>
    <span class="n">prev_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">previous_date</span><span class="p">)</span>
    <span class="n">prev_positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prev_positions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;#_prev&quot;</span><span class="p">])</span>

    <span class="c1"># Realizamos juncao externa na chave, mantendo assim dados nan (zeragens e ativos novos)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cur_positions</span><span class="p">,</span> <span class="n">prev_positions</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;Variation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_cur&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_prev&quot;</span><span class="p">]</span>
    <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;Closed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;#_cur&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">diff</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Variation&quot;</span><span class="p">,</span> <span class="s2">&quot;Closed&quot;</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_positions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_positions</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_inner_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_positions" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Fornece um dicionario com as posicoes do fundo na data informada.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">get_inner_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fornece um dicionario com as posicoes do fundo na data informada.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hist_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_positions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Fund == @fund_name&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">previous_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># manter funcionamento antes da implementacao da funcionalidade de cosultar multiplas datas</span>
        <span class="c1"># Separamos posicoes historicas apenas do fundo que nos interessa antes da data informada</span>
        <span class="n">hist_pos</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hist_pos</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">]</span>

        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span> <span class="c1"># Obtendo lista de rows(dicts) para iterar</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="c1"># vamos iterar do primeiro ao ultimo</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.000001</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.000001</span><span class="p">:</span>
                    <span class="n">positions</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_inner_positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">positions</span>

        <span class="c1"># Vamos ver se tem fundos da luxor</span>
        <span class="c1"># Vamos remover esse e explodir em posicoes internas</span>
        <span class="n">inner_funds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lipizzaner_lipizzaner&quot;</span> <span class="p">:</span> <span class="s2">&quot;lipizzaner&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fund a_fund a&quot;</span> <span class="p">:</span> <span class="s2">&quot;fund a&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">inner_fund</span> <span class="ow">in</span> <span class="n">inner_funds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">inner_fund</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inner_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">inner_funds</span><span class="p">[</span><span class="n">inner_fund</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span>
                                                     <span class="n">get_inner_positions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">inner_fund</span><span class="p">)</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inner_positions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">positions</span>

    <span class="c1"># Obtendo data de inicio e validando datas</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">recent_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">recent_date</span> <span class="o">&gt;</span> <span class="n">previous_date</span><span class="p">)</span>

    <span class="n">previous_or_before</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @previous_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">previous_or_before</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_date</span>

    <span class="n">after_previous</span> <span class="o">=</span> <span class="n">hist_pos</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt; @previous_date and Date &lt;= @recent_date&quot;</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">previous_or_before</span><span class="p">,</span> <span class="n">after_previous</span><span class="p">])</span>
    <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">positions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_positions_and_movements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_positions_and_movements</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_positions_and_movements" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fund_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tickers</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span> | <span title="set">set</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defaults to dt.date.today().</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em>. Defaults to dt.date.today()-dt.timedelta(days=1).</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>() - <span title="datetime.timedelta">timedelta</span>(days=1)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>mtd|ytd|3m|6m|...|nm. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>holiday_location</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any|bz|us|all. Defaults to "all".</p>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame:</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_positions_and_movements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        fund_name (str): </span>
<span class="sd">        tickers (str|list|set, optional): Defaults to None.</span>
<span class="sd">        recent_date (datetime.date, optional): Defaults to dt.date.today().</span>
<span class="sd">        previous_date (datetime.date, optional): _description_. Defaults to dt.date.today()-dt.timedelta(days=1).</span>
<span class="sd">        period (str, optional): mtd|ytd|3m|6m|...|nm. Defaults to None.</span>
<span class="sd">        holiday_location (str, optional): any|bz|us|all. Defaults to &quot;all&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__run_return_analysis</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span>
                                <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span>
                                <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span>
                                <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span> <span class="n">agregate_by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span>
                                <span class="p">)</span>
    <span class="c1"># Vamos obter os precos de fechamento em cada dia</span>
    <span class="c1"># Preenchendo primeiro todo o historico</span>
    <span class="n">prices_previous_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">price_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span>
                <span class="n">tickers</span><span class="o">=</span><span class="n">price_keys</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">prices_previous_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span>
                <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Asset&quot;</span><span class="p">:</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="c1"># Finalmente, vamos atualizar com o preco mais recente do ativo na data de hoje</span>
    <span class="c1"># -&gt; Pode ser substituido pelo uso da flag get_intraday_prices na get_prices</span>
    <span class="c1"># TODO : remover essa parte e testar</span>
    <span class="c1">#df_prev = df.query(&quot;Date &lt; @dt.date.today()&quot;).copy()</span>
    <span class="c1">#df_today = df.query(&quot;Date == @dt.date.today()&quot;).copy()</span>
    <span class="c1">#assets = self.get_table(&quot;assets&quot;).rename(columns={&quot;Key&quot;:&quot;Asset_ID&quot;})</span>
    <span class="c1">#df_today = df_today.merge(assets[[&quot;Asset_ID&quot;, &quot;Location&quot;]], on=&quot;Asset_ID&quot;)</span>
    <span class="c1">#if len(df_today) &gt; 0:</span>
    <span class="c1">#    df_today[&quot;Last_Price&quot;] = df_today.apply(lambda row: self.get_price(</span>
    <span class="c1">#                                        row[&quot;Price_Key&quot;], currency=currency,</span>
    <span class="c1">#                                        usdbrl_ticker=&quot;usdbrl curncy&quot;,</span>
    <span class="c1">#                                        asset_location=row[&quot;Location&quot;]), axis=1</span>
    <span class="c1">#                                        )</span>
    <span class="c1">#    df = pd.concat([df_prev, df_today])</span>
    <span class="c1">#else:</span>
    <span class="c1">#    df = df_prev</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_Quantity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_Quantity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Delta_Shares&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Bought_Cost&quot;</span><span class="p">,</span> <span class="s2">&quot;Shares_Sold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Amount_Sold&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Current_Position_Value&quot;</span><span class="p">]]</span>

    <span class="c1"># preenchendo Last_Price nulos com o do dia anterior para os mesmos asset_id</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_price" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_price</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger_level</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">dr_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">,</span> <span class="n">asset_location</span><span class="o">=</span><span class="s1">&#39;us&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_price" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Informa o preço do ativo. Quando px_date nao eh informado, retorna o
preço mais recente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ticker</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>identificador do ativo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>px_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data de referencia.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logger_level</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defaults to "trace".</p>
              </div>
            </td>
            <td>
                  <code>&#39;trace&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>float</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>preço do ativo.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger_level</span><span class="o">=</span><span class="s2">&quot;trace&quot;</span><span class="p">,</span> <span class="n">dr_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">asset_location</span><span class="o">=</span><span class="s2">&quot;us&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Informa o preço do ativo. Quando px_date nao eh informado, retorna o</span>
<span class="sd">    preço mais recente.</span>

<span class="sd">    Args:</span>
<span class="sd">        ticker (str): identificador do ativo.</span>
<span class="sd">        px_date (dt.date, optional): Data de referencia.</span>
<span class="sd">        logger_level (str, optional): Defaults to &quot;trace&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: preço do ativo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>


    <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asset_location</span> <span class="o">==</span> <span class="s2">&quot;bz&quot;</span> <span class="ow">and</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;usd&quot;</span><span class="p">:</span>
                <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">px_date</span><span class="p">)</span>
                <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">usdbrl</span>
            <span class="k">elif</span> <span class="n">asset_location</span> <span class="o">==</span> <span class="s2">&quot;us&quot;</span> <span class="ow">and</span> <span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;brl&quot;</span><span class="p">:</span>
                <span class="n">usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">px_date</span><span class="o">=</span><span class="n">px_date</span><span class="p">)</span>
                <span class="n">currency_factor</span> <span class="o">=</span> <span class="n">usdbrl</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao converter moeda para </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2"> para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="n">currency_factor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># dados do usd cupom limpo comecam em abril de 2011. Antes disso vamos pergar usdbrl normalmente</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ticker</span> <span class="o">==</span> <span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">px_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">px_date</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span> <span class="p">:</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;usdbrl curncy&quot;</span>

    <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">ticker</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">px_date</span><span class="p">)</span> <span class="c1"># chave unica do preco para essa data</span>
    <span class="c1"># se o preco foi consultado recentemente, podemos retorna-lo rapidamente.</span>
    <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">*</span> <span class="n">currency_factor</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">px_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">px_date</span><span class="o">&gt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
        <span class="c1"># Nesse caso retornamos o mais recente utilizando o dicionario</span>

        <span class="k">if</span> <span class="s2">&quot;px_last&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;px_last&quot;</span><span class="p">])</span>

        <span class="c1">#if ticker in self.asset_last_prices.keys():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_last_prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;px_last&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">price_1_tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fip mission 1.1&#39;</span><span class="p">,</span> <span class="s1">&#39;caixa&#39;</span><span class="p">,</span> <span class="s1">&#39;caixa us&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">price_1_tickers</span> <span class="p">:</span>
                <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1">#if px_last_at_date is None:</span>
                <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o ticker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
                <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="k">return</span> <span class="n">px_last_at_date</span> <span class="o">*</span> <span class="n">currency_factor</span>

    <span class="c1"># Vamos olhar em cada tabela de precos procurando pelo ticker informado</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">])</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Busca otimizada do preco pelo ativo e pela data informada</span>
        <span class="c1">#px_last_at_date = (self.hist_prices_table[&quot;Last_Price&quot;]</span>
        <span class="c1">#                    .to_numpy()[(</span>
        <span class="c1">#                            (self.hist_prices_table[&quot;Date&quot;].dt.date.to_numpy() &lt;= px_date) </span>
        <span class="c1">#                            &amp; </span>
        <span class="c1">#                            (self.hist_prices_table[&quot;Asset&quot;].to_numpy() == ticker) </span>
        <span class="c1">#                            )].item(-1)</span>
        <span class="c1">#                    )</span>
        <span class="c1">#return  px_last_at_date</span>

        <span class="n">px_last_at_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @px_date and Asset == @ticker&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">px_last_at_date</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="n">currency_factor</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">px_last_at_date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span> <span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c1"># Nao achou o ativo em nenhuma das tabelas, retorna 0</span>
        <span class="k">if</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">logger_level</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># logger_level == &quot;erro&quot;:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preço nao disponivel para o tikcker &#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&#39;. Preço setado para 0.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">px_last_at_date</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_price_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_price_key</span><span class="p">(</span><span class="n">asset_key</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_price_key" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Retorna a chave correta a ser usada para consultar o preco/rentabilidade do ativo.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_price_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Retorna a chave correta a ser usada para consultar o preco/rentabilidade do ativo.&quot;&quot;&quot;</span>

    <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Key == @asset_key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vc&quot;</span><span class="p">,</span> <span class="s2">&quot;luxor&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>

    <span class="c1"># Verificando se ha valor valido de ticker bbg</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]</span>
    <span class="c1"># caso nao haja, sera usado o ticker</span>
    <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_prices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prices</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_prices" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <div class="highlight"><pre><span></span><code>Filtra o historico de preços pelos tickers e pelo periodo informado.
</code></pre></div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>recent_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data de fim. Por padrao, data de hoje.</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>previous_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data de inicio. Por padrao, 30 dias antes de hoje.</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>() - <span title="datetime.timedelta">timedelta</span>(days=30)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tickers</code>
            </td>
            <td>
                  <code><span title="list">list</span> | <span title="set">set</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de tickers que devem ser incluidos, quando existirem.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period(str)</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ytd, mtd ou 'xm' onde 'x' é o numero de meses.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>currency(str)</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>codigo de 3 caracteres da moeda ou 'all' para considerar a moeda local de cada ativo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period(str)</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ytd|mtd|'xm' onde 'x' é o numero de meses. Usara como base o parametro 'recent_date'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>holiday_location(str)</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>all|any|us|bz ... ver metodo 'is_holiday'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Tabela de precos filtrada e convertida para moeda desejada</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
                     <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filtra o historico de preços pelos tickers e pelo periodo informado.</span>

<span class="sd">    Args:</span>
<span class="sd">        recent_date (dt.date, optional): data de fim. Por padrao, data de hoje.</span>
<span class="sd">        previous_date (dt.date, optional): data de inicio. Por padrao, 30 dias antes de hoje.</span>
<span class="sd">        tickers (list|set, optional): Lista de tickers que devem ser incluidos, quando existirem.</span>
<span class="sd">        period(str): ytd, mtd ou &#39;xm&#39; onde &#39;x&#39; é o numero de meses.</span>
<span class="sd">        currency(str): codigo de 3 caracteres da moeda ou &#39;all&#39; para considerar a moeda local de cada ativo.</span>
<span class="sd">        period(str): ytd|mtd|&#39;xm&#39; onde &#39;x&#39; é o numero de meses. Usara como base o parametro &#39;recent_date&#39;</span>
<span class="sd">        holiday_location(str): all|any|us|bz ... ver metodo &#39;is_holiday&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Tabela de precos filtrada e convertida para moeda desejada</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">recent_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                 <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">recent_date</span> <span class="o">&lt;</span> <span class="n">previous_date</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Possivel inversao dos parametros de inicio e fim do periodo.&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">recent_date</span>
        <span class="n">recent_date</span> <span class="o">=</span> <span class="n">previous_date</span>
        <span class="n">previous_date</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_tables_loaded</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;custom_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">,</span> <span class="s2">&quot;px_last&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="c1"># Vamos tentar sem o custom_funds_quotas, pois pode nao existir ainda.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="s2">&quot;hist_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_non_bbg_px_last&quot;</span><span class="p">,</span> <span class="s2">&quot;hist_vc_px_last&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;all_funds_quotas&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_prices&quot;</span><span class="p">,</span> <span class="s2">&quot;px_last&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">tickers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#prices = self.hist_prices_table.query(&quot;Date &lt;= @recent_date and Date &gt;= @previous_date&quot;)</span>
        <span class="c1"># Nesse caso, tickers sera uma lista com todos os ativos da tabela de precos</span>
        <span class="n">tickers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tickers</span><span class="p">]</span>

    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">]</span> <span class="c1"># padronizando tickers para lowercase</span>

    <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_prices_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">surrogate_previous_date</span> <span class="o">=</span> <span class="n">previous_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">surrogate_recent_date</span> <span class="o">=</span> <span class="n">recent_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @surrogate_recent_date and Date &gt;= @surrogate_previous_date</span><span class="se">\</span>
<span class="s2">                               and Asset.isin(@tickers)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">force_continuous_date_range</span><span class="p">:</span>
        <span class="c1"># Vamos ajustar as datas logo aqui, caso flag esteja ativa</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Asset&quot;</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>\
                        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">get_intraday_prices</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hist_prices_intraday_extensor</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>

        <span class="c1"># TODO:  Resolver problema de consistencia com ticker e ticker_bbg </span>

        <span class="n">assets</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Type != &#39;ações_bdr&#39; and Asset != &#39;spx eagle&#39;&quot;</span><span class="p">)</span>

        <span class="n">ticker_map</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~Ticker_BBG.isna() and Ticker_BBG != Ticker&quot;</span><span class="p">)[[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ticker_map</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ticker_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]],</span> <span class="n">prices</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">]]</span>
        <span class="n">currency_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bz&quot;</span><span class="p">:</span><span class="s2">&quot;brl&quot;</span><span class="p">,</span> <span class="s2">&quot;us&quot;</span><span class="p">:</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;cn&quot;</span><span class="p">:</span><span class="s2">&quot;cad&quot;</span><span class="p">,</span> <span class="s2">&quot;eur&quot;</span><span class="p">:</span><span class="s2">&quot;eur&quot;</span><span class="p">}</span>
        <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">currency_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="n">prices_by_location</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iter_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">iter_prices</span><span class="p">:</span>
            <span class="n">price_currency</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prices_by_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;Location&quot;</span><span class="p">})],</span> 
                                                            <span class="n">price_currency</span><span class="o">=</span><span class="n">price_currency</span><span class="p">,</span> <span class="n">dest_currency</span><span class="o">=</span><span class="n">currency</span><span class="p">,</span>
                                                            <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">force_continuous_date_range</span><span class="o">=</span><span class="n">force_continuous_date_range</span><span class="p">,</span>
                                                            <span class="n">holiday_location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">,</span> <span class="n">get_intraday_prices</span><span class="o">=</span><span class="n">get_intraday_prices</span><span class="p">,</span>
                                                            <span class="n">force_month_end</span><span class="o">=</span><span class="n">force_month_end</span><span class="p">))</span>


        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">prices_by_location</span><span class="p">)[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="c1"># Finalmente, vamos seguir filtrando pelo periodo desejado.</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= @recent_date and Date &gt;= @previous_date and Asset.isin(@tickers)&quot;</span><span class="p">)</span>

    <span class="c1">#if adjust_bmfxlcoc and (&#39;bmfxclco curncy&#39; in tickers) and (recent_date == dt.date.today()):</span>
    <span class="c1">#    max_date = prices.query(&quot;Asset == &#39;bmfxclco curncy&#39;&quot;)[&quot;Date&quot;].max()</span>
    <span class="c1">#    if max_date &lt; dt.date.today(): # vamos colocar mais um dia usando usdbrl curncy</span>
    <span class="c1">#        var_usdbrl1d = self.get_pct_change(&#39;usdbrl curncy&#39;, </span>
    <span class="c1">#                                           recent_date=dt.date.today(),</span>
    <span class="c1">#                                           previous_date=max_date)</span>
    <span class="c1">#        # vamos pegar o last_price em max_date</span>
    <span class="c1">#        last_price = self.get_price(&#39;bmfxclco curncy&#39;, px_date=max_date)</span>
    <span class="c1">#        # vamos ajustar com a variacao do usdbrl</span>
    <span class="c1">#        last_price = last_price * (1 + var_usdbrl1d)</span>
    <span class="c1">#        #vamos colocar na base na data de hoje</span>
    <span class="c1">#        prices = pd.concat([prices, </span>
    <span class="c1">#                    pd.DataFrame({&quot;Date&quot;:[dt.date.today()],</span>
    <span class="c1">#                                  &quot;Asset&quot;:[&#39;bmfxclco curncy&#39;], &quot;Last_Price&quot;:[last_price]})])</span>

    <span class="k">return</span> <span class="n">prices</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_px_update_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_px_update_time</span><span class="p">()</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_px_update_time" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Informa Horário da ultima atualizacao da base de precos.
Returns:
    dt.datetime</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_px_update_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Informa Horário da ultima atualizacao da base de precos.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dt.datetime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;px_last&quot;</span><span class="p">)[</span><span class="s2">&quot;Query_Time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_risk_metric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_risk_metric</span><span class="p">(</span><span class="n">fund_name</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_risk_metric" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <div class="highlight"><pre><span></span><code>Retorna as metricas de risco numa determinada data.
</code></pre></div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fund_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>nome do fundo correspontente</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics</code>
            </td>
            <td>
                  <code>str, list(str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str da metrica desejada ou uma lista de strings
para mais de uma metrica. Defaults to None (all available).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data da metrica. Defaults to datetime.date.today().</p>
              </div>
            </td>
            <td>
                  <code><span title="datetime.date.today">today</span>()</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:</p>
<div class="highlight"><pre><span></span><code>Pode retornar o valor de uma metrica especifica ou Dataframe quando 
metrics passado for uma lista de metricas.
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_risk_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fund_name</span><span class="p">,</span>  <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retorna as metricas de risco numa determinada data.</span>

<span class="sd">    Args:</span>
<span class="sd">        fund_name (str): nome do fundo correspontente</span>
<span class="sd">        metrics (str, list(str)): str da metrica desejada ou uma lista de strings</span>
<span class="sd">         para mais de uma metrica. Defaults to None (all available).</span>
<span class="sd">        date (datetime.date, optional): Data da metrica. Defaults to datetime.date.today().</span>

<span class="sd">    Returns:</span>

<span class="sd">        Pode retornar o valor de uma metrica especifica ou Dataframe quando </span>
<span class="sd">        metrics passado for uma lista de metricas.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fund_name</span> <span class="o">=</span> <span class="n">fund_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="n">hist_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;hist_risk_metrics&quot;</span><span class="p">)</span>
    <span class="n">hist_metrics</span> <span class="o">=</span> <span class="n">hist_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">hist_metrics</span><span class="p">[</span><span class="s2">&quot;Fund&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fund_name</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hist_metrics</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)</span> <span class="p">)]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hist_metrics</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Fund&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">hist_metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist_metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrica(s) </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2"> indisponivel(is)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_start_period_dt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_start_period_dt</span><span class="p">(</span><span class="n">ref_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_start_period_dt" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>A partir da data informada e do periodo, retorna a data de inicio do periodo.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ref_date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A data de referencia</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>O periodo em questao dado em meses, ou ytd ou mtd. Ex.: '12m', '6m', 'ytd', 'mtd', '24m'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_bday</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Determina se a data retorna devera ser dia util</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>holiday_location</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <div class="highlight"><pre><span></span><code>                &quot;bz&quot;,&quot;us&quot; -&gt; considerar feriados num local especifico

                &quot;all&quot; -&gt; considerar feriados globais apenas

                &quot;any&quot; -&gt; considerar feriado em qualquer localidade (dentre bz e us)
</code></pre></div>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_start_period_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_date</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">force_bday</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">holiday_location</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                        <span class="n">force_month_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A partir da data informada e do periodo, retorna a data de inicio do periodo.</span>

<span class="sd">    Args:</span>
<span class="sd">        ref_date (dt.date): A data de referencia</span>
<span class="sd">        period (str): O periodo em questao dado em meses, ou ytd ou mtd. Ex.: &#39;12m&#39;, &#39;6m&#39;, &#39;ytd&#39;, &#39;mtd&#39;, &#39;24m&#39;</span>
<span class="sd">        force_bday (bool): Determina se a data retorna devera ser dia util\n</span>
<span class="sd">        holiday_location (str): \n</span>
<span class="sd">                                &quot;bz&quot;,&quot;us&quot; -&gt; considerar feriados num local especifico\n</span>
<span class="sd">                                &quot;all&quot; -&gt; considerar feriados globais apenas\n</span>
<span class="sd">                                &quot;any&quot; -&gt; considerar feriado em qualquer localidade (dentre bz e us)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> 

        <span class="n">n_months</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">force_month_end</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">ref_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">n_months</span><span class="p">)</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_month_end</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">is_leap_date</span> <span class="o">=</span> <span class="p">((</span><span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">is_leap_date</span><span class="p">:</span>
                <span class="n">ref_date</span> <span class="o">=</span> <span class="n">ref_date</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">year_offset</span> <span class="o">=</span> <span class="n">n_months</span><span class="o">//</span><span class="mi">12</span> <span class="c1"># obtendo o numero de anos inteiros no periodo informado</span>
            <span class="n">month_offset</span> <span class="o">=</span> <span class="n">n_months</span><span class="o">%</span><span class="mi">12</span> <span class="c1"># obtendo o numero de anos parciais </span>

            <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="n">year_offset</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">-</span> <span class="n">month_offset</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_leap_date</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># forcando avanco ao mes seguinte</span>
                <span class="c1"># Retornando ao ultimo dia do mes anterior</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">start_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">start_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;ytd&quot;</span><span class="p">:</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;mtd&quot;</span><span class="p">:</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># A partir de uma data pegar o trimestre anterior</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s1">&#39;qtr&#39;</span><span class="p">:</span>
        <span class="c1"># Deve retornar sempre a ultima data do final do trimestre anterior</span>
        <span class="n">current_quarter</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">start_of_current_quarter</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">ref_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="p">(</span><span class="n">current_quarter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_of_current_quarter</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Last day of previous quarter</span>

        <span class="c1">#start_date = ref_date - pd.DateOffset(months=3) </span>
        <span class="c1">#start_date = start_date.date()</span>
        <span class="c1">#start_date = self.get_month_end(start_date)</span>

    <span class="k">if</span> <span class="n">force_bday</span><span class="p">:</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bday_offset</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">holiday_location</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">start_date</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.get_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="p">{},</span> <span class="n">force_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.get_table" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Retorna uma copia do DataFrame do 'table_name' correspondente. Se não estiver disponivel,
retorna None.</p>


<details class="table_name" open>
  <summary>table_name</summary>
  <p>'px_last'              - Último preco dos ativos</p>
<p>'trades'               - Historico de boletas dos trades da Luxor</p>
<p>'assets'               - Tabela de ativos validos</p>
<p>'hist_px_last'         - Preço histórico dos ativos desde 1990</p>
<p>'hist_vc_px_last'      - Preço histórico dos VCs</p>
<p>'hist_non_bbg_px_last' - Preço histórico de ativos sem preco no bbg (fidc trybe, spx hawker)</p>
<p>'[NOME_FUNDO]_quotas   - Cotas historicas do fundo (fund_a, fund_b, hmx, ...</p>
<p>'hist_us_cash'         - Historico de caixas dos fundos (us apenas)</p>
<p>'bbg_tickers'          - Ticker bbg de todos os tickers cadastrados</p>
<p>'bdr_sizes'            - Tabela com o ultimo peso de cada bdr</p>
<p>'hist_swap'            - Tabela historica dos swaps</p>
<p>'hist_positions'       - Historico de posicoes dos fundos</p>
<p>'hist_positions_by_bank- Posicoes por banco</p>
<p>'cash_movements'       - Historico de movimentacoes com data de liquidacao</p>
<p>'holidays'             - Tabela de feriados das bolsas</p>
<p>'daily_pnl'            - Tabela de PnL diario</p>
<p>'custom_funds_quotas'  - Cotas dos fundos customizados(luxor equities, non-equities, etc)</p>
</details>

<details class="dtypes_override" open>
  <summary>dict : set - Dicionario com os tipos de dados das colunas devem ser sobrescritos.</summary>
  <p>Deve possuir as chaves 'float', 'date', 'bool' e 'str_nan_format'(troca 'nan' por pd.NA)
    Para cada chave, colocar um Set com os nomes das colunas que receberao o cast.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="p">{},</span> <span class="n">force_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retorna uma copia do DataFrame do &#39;table_name&#39; correspondente. Se não estiver disponivel,</span>
<span class="sd">        retorna None.</span>

<span class="sd">        table_name: </span>
<span class="sd">            &#39;px_last&#39;              - Último preco dos ativos\n</span>
<span class="sd">            &#39;trades&#39;               - Historico de boletas dos trades da Luxor\n</span>
<span class="sd">            &#39;assets&#39;               - Tabela de ativos validos\n</span>
<span class="sd">            &#39;hist_px_last&#39;         - Preço histórico dos ativos desde 1990\n</span>
<span class="sd">            &#39;hist_vc_px_last&#39;      - Preço histórico dos VCs\n</span>
<span class="sd">            &#39;hist_non_bbg_px_last&#39; - Preço histórico de ativos sem preco no bbg (fidc trybe, spx hawker)\n</span>
<span class="sd">            &#39;[NOME_FUNDO]_quotas   - Cotas historicas do fundo (fund_a, fund_b, hmx, ...\n</span>
<span class="sd">            &#39;hist_us_cash&#39;         - Historico de caixas dos fundos (us apenas)\n</span>
<span class="sd">            &#39;bbg_tickers&#39;          - Ticker bbg de todos os tickers cadastrados\n</span>
<span class="sd">            &#39;bdr_sizes&#39;            - Tabela com o ultimo peso de cada bdr\n</span>
<span class="sd">            &#39;hist_swap&#39;            - Tabela historica dos swaps\n</span>
<span class="sd">            &#39;hist_positions&#39;       - Historico de posicoes dos fundos\n</span>
<span class="sd">            &#39;hist_positions_by_bank- Posicoes por banco\n</span>
<span class="sd">            &#39;cash_movements&#39;       - Historico de movimentacoes com data de liquidacao\n</span>
<span class="sd">            &#39;holidays&#39;             - Tabela de feriados das bolsas\n</span>
<span class="sd">            &#39;daily_pnl&#39;            - Tabela de PnL diario\n</span>
<span class="sd">            &#39;custom_funds_quotas&#39;  - Cotas dos fundos customizados(luxor equities, non-equities, etc)\n</span>

<span class="sd">        dtypes_override: dict : set - Dicionario com os tipos de dados das colunas devem ser sobrescritos.</span>
<span class="sd">            Deve possuir as chaves &#39;float&#39;, &#39;date&#39;, &#39;bool&#39; e &#39;str_nan_format&#39;(troca &#39;nan&#39; por pd.NA)</span>
<span class="sd">                Para cada chave, colocar um Set com os nomes das colunas que receberao o cast.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s1">&#39;bbg_tickers&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_tickers_bbg</span><span class="p">()</span> <span class="c1"># DEPRECATED TODO: remover apos testes</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">table_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;table_data&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">dtypes_override</span><span class="o">=</span><span class="n">dtypes_override</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.is_holiday" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_holiday</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.is_holiday" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>date</code>
            </td>
            <td>
                  <code><span title="datetime.date">date</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>location</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <div class="highlight"><pre><span></span><code>&#39;any&#39;-&gt; se é feriado em qualquer um dos lugares cadastrados

&#39;all&#39; -&gt; se é feriado em todas as localidades da tabela

&#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela
</code></pre></div>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>se é ou nao feriado</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_holiday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span>  <span class="n">location</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        date (dt.date): </span>
<span class="sd">        location (str): </span>
<span class="sd">                &#39;any&#39;-&gt; se é feriado em qualquer um dos lugares cadastrados\n</span>
<span class="sd">                &#39;all&#39; -&gt; se é feriado em todas as localidades da tabela\n</span>
<span class="sd">                &#39;us&#39;, &#39;bz&#39;, (...) -&gt; para local especifico, com codigo presente na tabela\n</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: se é ou nao feriado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">holidays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;holidays&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">location</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span> <span class="ow">and</span> <span class="n">location</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">holidays</span> <span class="o">=</span> <span class="n">holidays</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">n_locations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">holidays</span> <span class="o">=</span> <span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;count == @n_locations&quot;</span><span class="p">)</span>
                            <span class="p">)</span>

    <span class="k">return</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.list_blob_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_blob_files</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">ends_with</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.list_blob_files" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Lista todos os arquivos dentro de um diretorio no blob storage.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_blob_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">ends_with</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lista todos os arquivos dentro de um diretorio no blob storage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">connect_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AZURE_STORAGE_CONNECTION_STRING&#39;</span><span class="p">)</span>
    <span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">connect_str</span><span class="p">)</span>

    <span class="c1"># Vamos listar os arquivos do diretorio</span>
    <span class="n">blob_files</span> <span class="o">=</span> <span class="n">blob_service_client</span>\
                <span class="o">.</span><span class="n">get_container_client</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">list_blobs</span><span class="p">(</span><span class="n">name_starts_with</span><span class="o">=</span><span class="n">sub_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ends_with</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">blob_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blob_file</span> <span class="ow">in</span> <span class="n">blob_files</span> <span class="k">if</span> <span class="n">blob_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ends_with</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">blob_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blob_file</span> <span class="ow">in</span> <span class="n">blob_files</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.normalize_price_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_price_key</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.normalize_price_key" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <div class="highlight"><pre><span></span><code>Adiciona a coluna &#39;Price_ID&#39; no df informado representando uma chave normalizada para o preco do ativo desejado.
</code></pre></div>
<p>Args:
    df (pandas.DataFrame): DataFrame que obrigatoriamente precisa conter 'Asset' e 'Ticker' como colunas.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">normalize_price_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adiciona a coluna &#39;Price_ID&#39; no df informado representando uma chave normalizada para o preco do ativo desejado.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): DataFrame que obrigatoriamente precisa conter &#39;Asset&#39; e &#39;Ticker&#39; como colunas. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">,]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">})</span>

    <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price_key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">asset_price_key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;etf s&amp;p&quot;</span> <span class="p">:</span> <span class="s1">&#39;voo us equity&#39;</span><span class="p">,</span> <span class="s2">&quot;spx hawker&quot;</span><span class="p">:</span> <span class="s2">&quot;spx hawker usd&quot;</span><span class="p">,</span> <span class="s2">&quot;berkshire&quot;</span> <span class="p">:</span> <span class="s2">&quot;brk/b us equity&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;localiza&quot;</span> <span class="p">:</span> <span class="s2">&quot;rent3 bz equity&quot;</span><span class="p">,</span> <span class="s2">&quot;suzano&quot;</span><span class="p">:</span><span class="s2">&quot;suzb3 bz equity&quot;</span><span class="p">}</span>
    <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">asset_price_key_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Asset&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">asset_price_key_map</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Price_Old_key&quot;</span><span class="p">})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Price_Key&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">)</span>

    <span class="c1"># Casos padroes |-&gt; tratados na tabela asset, usando o get_price_key. Casos especificos adicionar no asset_price_key_map.</span>
    <span class="c1">#df[&quot;Price_Key&quot;] = np.where((df[&quot;Ticker_BBG&quot;] is None) or (df[&quot;Ticker_BBG&quot;].isnull()), df[&quot;Ticker&quot;], df[&quot;Ticker_BBG&quot;])</span>

    <span class="k">if</span> <span class="s2">&quot;Price_Key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span> <span class="n">df_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Price_Key&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df_columns</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.normalize_trades" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_trades</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">asset_id_columns</span><span class="o">=</span><span class="s1">&#39;Asset_ID&#39;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.normalize_trades" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Para um dado dataframe de trades, converte para moeda indicada.
    Trades devem conter as colunas Asset, Ticker e Delta_Shares.
    BDR: Usa o peso do BDR e a quantidade de BDR operada para chegar na quantidade do ativo original.
    Financeiro: Corrigido pelo cambio de fechamento.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trades</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe de trades, mais especificamente o output
            de get_positions_and_movements.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>currency</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>brl; usd; all -&gt; todas as moedas, no caso usd e brl</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">normalize_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">asset_id_columns</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">usdbrl_ticker</span><span class="o">=</span><span class="s2">&quot;bmfxclco curncy&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Para um dado dataframe de trades, converte para moeda indicada.</span>
<span class="sd">        Trades devem conter as colunas Asset, Ticker e Delta_Shares.</span>
<span class="sd">        BDR: Usa o peso do BDR e a quantidade de BDR operada para chegar na quantidade do ativo original.</span>
<span class="sd">        Financeiro: Corrigido pelo cambio de fechamento.</span>

<span class="sd">    Args:</span>
<span class="sd">        trades (pd.DataFrame): dataframe de trades, mais especificamente o output</span>
<span class="sd">                        de get_positions_and_movements.</span>
<span class="sd">        currency (str): brl; usd; all -&gt; todas as moedas, no caso usd e brl</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;brl&quot;</span><span class="p">])</span>
    <span class="n">previous_date</span><span class="o">=</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">recent_date</span><span class="o">=</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>

    <span class="c1"># tratando inconsistencia da Location do spx hawker</span>
    <span class="n">spx_hawker_brl_tickers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;SPX SEG HAWKER JAN22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER FEB22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX HAWKER CL AMAR22&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SPX SEG HAWKER APR22&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX HAWKER CL ASET18&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER JUN23&quot;</span><span class="p">,</span> <span class="s2">&quot;SPX SEG HAWKER SEP23&quot;</span><span class="p">]</span>
    <span class="n">spx_hawker_brl_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">spx_hawker_brl_tickers</span><span class="p">))</span> <span class="c1"># colocando tudo para minusculo</span>
    <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">spx_hawker_brl_tickers</span><span class="p">),</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="n">assets</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>


    <span class="c1"># Salvando os nomes das colunas antes de editar a tabela.</span>
    <span class="n">trades_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">trades</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>        


    <span class="c1"># Adicionando algumas colunas que vamos precisar para conseguir distinguir os ativos</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">assets</span><span class="p">[[</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Ticker_BBG&quot;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Asset_ID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Key&quot;</span><span class="p">)</span>

    <span class="c1"># Achando quantidade do trade no ativo original -&gt; usando peso do bdr </span>
    <span class="n">bdr_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;bdr_sizes&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">bdr_sizes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;adr_adr_per_sh&quot;</span><span class="p">:</span><span class="s2">&quot;BDR_Size&quot;</span><span class="p">})</span>
    <span class="c1"># Achando quantidade do trade no ativo original -&gt; usando peso do bdr </span>
    <span class="c1"># -&gt; Partindo da premissa que sempre atualizamos o historico quando ha alteracao do peso (inplit/split do bdr)</span>
    <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ações_bdr&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;BDR_Size&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Delta_Shares&quot;</span><span class="p">])</span>
    <span class="c1"># Ajustando quantidades dos trades de localiza proporcionalmente:</span>
    <span class="c1">#lcam_rent_ratio = 0.4388444  #0.44 rent3 para cada lcam3</span>
    <span class="c1">#lzrfy_rent_ratio = 1 # 1 rent para cada lzrfy</span>
    <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;lcam3 bz equity&#39;, trades[&quot;Delta_Shares&quot;] * lcam_rent_ratio, trades[&quot;Delta_Shares&quot;])</span>
    <span class="c1"># Ajuste da lzrfy eh desnecessario ja que eh 1:1</span>
    <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;lzrfy us equity&#39;, trades[&quot;Delta_Shares&quot;] * lzrfy_rent_ratio, trades[&quot;Delta_Shares&quot;])</span>

    <span class="c1">#brkA_brkB_ratio = 1500</span>
    <span class="c1">#trades[&quot;Delta_Shares&quot;] = np.where(trades[&quot;Ticker&quot;] == &#39;brk/a us equity&#39;, trades[&quot;Delta_Shares&quot;] * brkA_brkB_ratio, trades[&quot;Delta_Shares&quot;])</span>

    <span class="c1"># Adicionando coluna de usdbrl de fechamento em cada dia</span>
    <span class="n">hist_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">usdbrl_ticker</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">previous_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">recent_date</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">:</span> <span class="s2">&quot;USDBRL&quot;</span><span class="p">})</span>

    <span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">hist_usdbrl</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;USDBRL&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

    <span class="c1"># Criando colunas com financeiro normalizado.</span>
    <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;usd&#39;</span><span class="p">:</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bz&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;USDBRL&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">currency</span> <span class="o">==</span> <span class="s1">&#39;brl&#39;</span><span class="p">:</span>
        <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">trades</span><span class="p">[</span><span class="s2">&quot;USDBRL&quot;</span><span class="p">],</span> <span class="n">trades</span><span class="p">[</span><span class="s2">&quot;Trade_Amount&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades_columns</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.simulate_portfolio_performance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">simulate_portfolio_performance</span><span class="p">(</span><span class="n">portfolio</span><span class="p">,</span> <span class="n">portfolio_date</span><span class="p">,</span> <span class="n">adm_fee</span><span class="p">,</span> <span class="n">performance_fee</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.simulate_portfolio_performance" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Simula o desempenho de um portfólio com base em um dicionário de ativos e suas alocações iniciais.</p>
<p>Parâmetros:
- portfolio: dicionário com os ativos e suas alocações iniciais. Dicionário deve seguir o formato:</p>
<div class="highlight"><pre><span></span><code>{
    &quot;ticker1&quot;: peso1,
    &quot;ticker2&quot;: peso2,
    ...
    &quot;tickerN&quot;: pesoN
}, onde os pesos devem somar 1.
</code></pre></div>
<ul>
<li>portfolio_date: data inicial do portfólio.</li>
<li>adm_fee: taxa de administração %.a.a</li>
<li>performance_fee: taxa de performance (opcional).</li>
</ul>
<p>Retorna:
- DataFrame com o fator de correção da cota para cada dia a partir da data inicial do portfolio.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_portfolio_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">portfolio_date</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">adm_fee</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">performance_fee</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simula o desempenho de um portfólio com base em um dicionário de ativos e suas alocações iniciais.</span>

<span class="sd">        Parâmetros:</span>
<span class="sd">        - portfolio: dicionário com os ativos e suas alocações iniciais. Dicionário deve seguir o formato:\n</span>
<span class="sd">            {</span>
<span class="sd">                &quot;ticker1&quot;: peso1,</span>
<span class="sd">                &quot;ticker2&quot;: peso2,</span>
<span class="sd">                ...</span>
<span class="sd">                &quot;tickerN&quot;: pesoN</span>
<span class="sd">            }, onde os pesos devem somar 1.</span>
<span class="sd">        - portfolio_date: data inicial do portfólio.</span>
<span class="sd">        - adm_fee: taxa de administração %.a.a</span>
<span class="sd">        - performance_fee: taxa de performance (opcional).</span>

<span class="sd">        Retorna:</span>
<span class="sd">        - DataFrame com o fator de correção da cota para cada dia a partir da data inicial do portfolio.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Formatar os tickers para minusculas</span>
        <span class="n">portfolio</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">initial_portfolio</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;date&quot;</span> <span class="p">:</span> <span class="n">portfolio_date</span><span class="p">,</span>
            <span class="s2">&quot;assets&quot;</span> <span class="p">:</span> <span class="n">portfolio</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Criando dataframe com as colunas  Date|Ticker|Weight|</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">initial_portfolio</span><span class="p">[</span><span class="s2">&quot;assets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;Weight&quot;</span><span class="p">])</span>
        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_portfolio</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">tickers</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Ticker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">max_date</span> <span class="o">=</span> <span class="n">portfolio_date</span>

        <span class="k">while</span> <span class="n">max_date</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
            <span class="c1"># Adicionando 1 dia</span>
            <span class="n">new_date</span> <span class="o">=</span> <span class="n">max_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">daily_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_changes</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">previous_date</span><span class="o">=</span><span class="n">max_date</span><span class="p">,</span> <span class="n">recent_date</span><span class="o">=</span><span class="n">new_date</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">)</span>

            <span class="n">daily_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Ticker&quot;</span>

            <span class="n">new_day</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @max_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Ticker&quot;</span><span class="p">)</span>
            <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_returns</span>
            <span class="n">new_day</span> <span class="o">=</span> <span class="n">new_day</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># Ajusta pesos considerando a atribuicao de retorno do dia anterior</span>
            <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span>
            <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">new_date</span>

            <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span>
            <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_day</span><span class="p">[</span><span class="s2">&quot;Daily_Attribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">positions</span><span class="p">,</span> <span class="n">new_day</span><span class="p">])</span>
            <span class="n">max_date</span> <span class="o">=</span> <span class="n">new_date</span>

        <span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
        <span class="c1">#positions.to_excel(&quot;positions_tci.xlsx&quot;)</span>
        <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

        <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Daily_Portfolio_Return&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
                                                        <span class="p">((</span><span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">performance_fee</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">adm_fee</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span>
                                                        <span class="n">daily_returns</span><span class="p">[</span><span class="s2">&quot;Acc_Returns&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">adm_fee</span><span class="o">/</span><span class="mi">12</span>
                                                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Acc_Returns_Adjusted_by_Taxes&quot;</span><span class="p">:</span> <span class="s2">&quot;Factor&quot;</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.text_to_lowercase" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">text_to_lowercase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.text_to_lowercase" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Converte todas as colunas de texto para lowercase
Args:
    t (dt.DataFrame): pandas DataFrame
Returns:
    dt.DataFrame</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">text_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converte todas as colunas de texto para lowercase</span>
<span class="sd">    Args:</span>
<span class="sd">        t (dt.DataFrame): pandas DataFrame</span>
<span class="sd">    Returns:</span>
<span class="sd">        dt.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Pendente de atualizacao para o python 3.12.2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="n">update_attempts_limit</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.update" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Atualiza todas as tabelas em uso.</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_attempts_limit</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Atualiza todas as tabelas em uso.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">update_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># -&gt; reset da otimizacao da consulta de preco </span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">update_success</span> <span class="ow">and</span> <span class="p">(</span><span class="n">update_attempts</span> <span class="o">&lt;</span> <span class="n">update_attempts_limit</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">update_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_in_use</span><span class="p">:</span>
                <span class="c1"># Verificando se tabela foi criada ou modificada</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_table_modified</span><span class="p">(</span><span class="n">table_key</span><span class="p">):</span>                        
                    <span class="bp">self</span><span class="o">.</span><span class="n">__load_table_group</span><span class="p">([</span><span class="n">table_key</span><span class="p">])</span>


            <span class="n">update_success</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="n">hist_prices_tables</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># desconsidera appends feitos no loop nao concluido</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Não foi possível carregar as tabelas pois tem algum arquivo aberto.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentativas de atualização: </span><span class="si">{</span><span class="n">update_attempts</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">update_attempts_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Não foi possivel carregar as tabelas.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentativas de atualização: </span><span class="si">{</span><span class="n">update_attempts</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">update_attempts_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">update_attempts</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">update_success</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Nao foi possivel atualizar os dados. Execução finalizada.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.usdbrl_clean_coupon_fix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">usdbrl_clean_coupon_fix</span><span class="p">(</span><span class="n">usdbrl_df</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.usdbrl_clean_coupon_fix" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Corrige o problema do ticker bmfxclco curncy nao ter dados intraday.
    Usa a variacao intraday do usdbrl curncy
Args:
    usdbrl_df (pd.DataFrame): dataframe com precos historicos do bmfxclco curncy</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">usdbrl_clean_coupon_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usdbrl_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Corrige o problema do ticker bmfxclco curncy nao ter dados intraday.</span>
<span class="sd">        Usa a variacao intraday do usdbrl curncy</span>
<span class="sd">    Args:</span>
<span class="sd">        usdbrl_df (pd.DataFrame): dataframe com precos historicos do bmfxclco curncy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_date</span> <span class="o">=</span> <span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">max_date</span> <span class="o">&lt;</span> <span class="n">today</span><span class="p">:</span>
        <span class="c1"># vamos pegar a variacao do usdbrl curncy</span>
        <span class="n">var_usdbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pct_change</span><span class="p">(</span><span class="s1">&#39;usdbrl curncy&#39;</span><span class="p">,</span> 
                                           <span class="n">recent_date</span><span class="o">=</span><span class="n">today</span><span class="p">,</span>
                                           <span class="n">previous_date</span><span class="o">=</span><span class="n">max_date</span><span class="p">)</span>
        <span class="c1"># vamos pegar o last_price em max_date</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">usdbrl_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date == @max_date&quot;</span><span class="p">)[</span><span class="s2">&quot;Last_Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="c1"># vamos ajustar com a variacao do usdbrl</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">last_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">var_usdbrl</span><span class="p">)</span>
        <span class="c1">#vamos colocar na base na data de hoje</span>
        <span class="n">usdbrl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">usdbrl_df</span><span class="p">,</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Date&quot;</span><span class="p">:[</span><span class="n">today</span><span class="p">],</span>
                                  <span class="s2">&quot;Asset&quot;</span><span class="p">:[</span><span class="s1">&#39;bmfxclco curncy&#39;</span><span class="p">],</span> <span class="s2">&quot;Last_Price&quot;</span><span class="p">:[</span><span class="n">last_price</span><span class="p">]})])</span>

        <span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">usdbrl_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">usdbrl_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="luxorDB_datareader.LuxorQuery.xirr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">xirr</span><span class="p">(</span><span class="n">cashflows</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span></code>

<a href="#luxorDB_datareader.LuxorQuery.xirr" class="headerlink" title="Permanent link">¶</a></h3>


    <div class="doc doc-contents ">

        <p>Calcula o XIRR para uma serie de cash flows em datas especificas.</p>
<p>:cashflows (numpy.array of float): cash flows (positive para entrada, negativo para saida)
:dates (numpy.array of datetime64): datas correspondentes aos cash flows
:return: XIRR</p>


            <details class="quote">
              <summary>Source code in <code>LuxorASAP\luxorDB_datareader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xirr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cashflows</span><span class="p">,</span> <span class="n">dates</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calcula o XIRR para uma serie de cash flows em datas especificas.</span>

<span class="sd">        :cashflows (numpy.array of float): cash flows (positive para entrada, negativo para saida)</span>
<span class="sd">        :dates (numpy.array of datetime64): datas correspondentes aos cash flows</span>
<span class="sd">        :return: XIRR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Garantindo que dates eh um numpy array de datetime64</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dates</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">:</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Reference date</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">date</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[D]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xnpv</span><span class="p">(</span><span class="n">rate</span><span class="p">):</span>
        <span class="c1"># Limiting the rate to avoid overflow and division by zero</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.9999</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">yr</span> <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cashflows</span><span class="p">,</span> <span class="n">years</span><span class="p">)])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xnpv_prime</span><span class="p">(</span><span class="n">rate</span><span class="p">):</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.9999</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="o">-</span><span class="n">yr</span> <span class="o">*</span> <span class="n">cf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">yr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cf</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cashflows</span><span class="p">,</span> <span class="n">years</span><span class="p">)])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Using a conservative initial guess</span>
        <span class="n">initial_guess</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">return</span> <span class="n">newton</span><span class="p">(</span><span class="n">xnpv</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">fprime</span><span class="o">=</span><span class="n">xnpv_prime</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
        <span class="c1"># Return NaN if the calculation fails</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Luxor Group
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>